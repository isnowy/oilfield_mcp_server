# LibreChat MCP占位符问题解决方案

## 问题现象
- 数据库中用户角色是 ADMIN
- MCP Server日志显示 `User: {{LIBRECHAT_USER_EMAIL}}` 和 `Role: USER`
- 占位符没有被LibreChat替换

## 根本原因
LibreChat在stdio传输模式下可能不处理环境变量占位符，或者需要特殊配置。

## 解决方案

### 方案1: 使用自定义用户变量（推荐）

LibreChat支持通过customUserVars让用户在UI中配置，然后自动传递：

```yaml
mcpServers:
  oilfield-data:
    command: python
    args:
      - "d:/work/oilMCP/oilfield_mcp_server_with_permissions.py"
    # 让用户在UI中配置这些值
    customUserVars:
      USER_EMAIL:
        title: "用户邮箱"
        description: "用于权限验证的邮箱地址"
        default: ""
      USER_ROLE:
        title: "用户角色"
        description: "用户角色(ADMIN/USER)"
        default: "USER"
    env:
      DATABASE_URL: "sqlite:///d:/work/oilMCP/oilfield.db"
      # 使用customUserVars
      LIBRECHAT_USER_EMAIL: "{{USER_EMAIL}}"
      LIBRECHAT_USER_ROLE: "{{USER_ROLE}}"
      DEV_MODE: "false"
```

### 方案2: 使用Headers传递（SSE/HTTP传输）

如果可以，改用SSE或HTTP传输，在headers中传递用户信息：

```yaml
mcpServers:
  oilfield-data:
    type: sse
    url: "http://localhost:5000/mcp"
    headers:
      X-User-Email: "{{LIBRECHAT_USER_EMAIL}}"
      X-User-Role: "{{LIBRECHAT_USER_ROLE}}"
```

### 方案3: 修改MCP Server从请求中获取用户信息

如果LibreChat在调用MCP工具时会传递用户信息，可以从工具参数中获取。

### 方案4: 临时解决 - 开发模式

如果暂时无法解决占位符问题，可以设置开发模式跳过权限检查：

```yaml
env:
  DEV_MODE: "true"
```

但这不安全，只适合开发测试。

## 验证步骤

1. 修改librechat.yaml后重启LibreChat
2. 重新登录
3. 查看MCP Server日志
4. 运行诊断脚本: `python diagnose_env.py`

## 联系信息

如果问题持续，需要：
1. 确认LibreChat版本: `cat package.json | grep version`
2. 查看LibreChat日志中关于MCP的输出
3. 检查是否有其他配置覆盖了环境变量
