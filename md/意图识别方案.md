# æ„å›¾è¯†åˆ«ä¸ŽçŠ¶æ€è¿½è¸ªæŠ€æœ¯æ–¹æ¡ˆ

## ðŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜Žé¡¹ç›®ä¸­å¦‚ä½•å®žçŽ°é«˜å‡†ç¡®çŽ‡çš„æ„å›¾è¯†åˆ«å’Œå®Œæ•´çš„çŠ¶æ€è¿½è¸ªã€‚

## 1ï¸âƒ£ Markdown è¾“å‡ºç­–ç•¥

### âœ… å·²å®žçŽ°

é¡¹ç›®ä¸­ **100% é‡‡ç”¨ Markdown æ ¼å¼è¾“å‡º**ï¼Œæ²¡æœ‰ä½¿ç”¨ JSONã€‚

### ä»£ç ä½ç½®

```python
# oilfield_mcp_server.py ç¬¬363-367è¡Œ
def df_to_markdown(df: pd.DataFrame) -> str:
    """å°†DataFrameè½¬æ¢ä¸ºMarkdownè¡¨æ ¼"""
    if df.empty:
        return "æ— æ•°æ®"
    return df.to_markdown(index=False)
```

### åº”ç”¨ç¤ºä¾‹

**ç¤ºä¾‹ 1ï¼šè¡¨æ ¼æ•°æ®**
```python
# ç¬¬432è¡Œ - æœç´¢ç»“æžœ
return f"### ðŸ” æœç´¢ç»“æžœï¼ˆå…± {len(wells)} å£äº•ï¼‰\n\n{df_to_markdown(pd.DataFrame(data))}"
```

è¾“å‡ºæ•ˆæžœï¼š
```markdown
### ðŸ” æœç´¢ç»“æžœï¼ˆå…± 3 å£äº•ï¼‰

| äº•å· | äº•å | åŒºå— | çŠ¶æ€ | äº•åž‹ | è®¾è®¡äº•æ·±(m) | é’»äº•é˜Ÿ |
|------|------|------|------|------|-------------|--------|
| ZT-102 | ä¸­å¡”-102 | Block-A | Active | Horizontal | 4500 | Team-701 |
| ZT-105 | ä¸­å¡”-105 | Block-A | Active | Vertical | 4200 | Team-702 |
| ZT-108 | ä¸­å¡”-108 | Block-A | Completed | Directional | 5000 | Team-701 |
```

**ç¤ºä¾‹ 2ï¼šç»“æž„åŒ–ä¿¡æ¯**
```python
# ç¬¬472-485è¡Œ - äº•æ¦‚è§ˆ
return f"""
### ðŸ†” äº•åŸºæœ¬ä¿¡æ¯ï¼š{well.name} ({well.id})

| é¡¹ç›® | ä¿¡æ¯ |
|---|---|
| **åŒºå—** | {well.block} |
| **äº•åž‹** | {well.well_type} |
| **çŠ¶æ€** | {well.status} |
...
"""
```

### ä¸ºä»€ä¹ˆé€‰æ‹© Markdownï¼Ÿ

| ç‰¹æ€§ | Markdown | JSON | è¯´æ˜Ž |
|------|----------|------|------|
| **Token æ¶ˆè€—** | ä½Žï¼ˆåŸºå‡†ï¼‰ | é«˜ï¼ˆ+30-50%ï¼‰ | JSON çš„æ‹¬å·ã€å¼•å·å¢žåŠ  Token |
| **LLM ç†è§£** | ä¼˜ç§€ | ä¸€èˆ¬ | LLM è®­ç»ƒæ•°æ®ä¸­ Markdown å æ¯”é«˜ |
| **å¯è¯»æ€§** | å¼º | å¼± | äººç±»å’Œ LLM éƒ½æ˜“è¯» |
| **ç»“æž„åŒ–** | è¡¨æ ¼æ”¯æŒ | å®Œå…¨ç»“æž„åŒ– | Markdown è¡¨æ ¼è¶³å¤Ÿä½¿ç”¨ |

### Token å¯¹æ¯”ç¤ºä¾‹

**JSON æ ¼å¼**ï¼ˆçº¦120 tokensï¼‰ï¼š
```json
{
  "wells": [
    {"id": "ZT-102", "name": "ä¸­å¡”-102", "block": "Block-A", "status": "Active", "type": "Horizontal", "depth": 4500, "team": "Team-701"},
    {"id": "ZT-105", "name": "ä¸­å¡”-105", "block": "Block-A", "status": "Active", "type": "Vertical", "depth": 4200, "team": "Team-702"}
  ]
}
```

**Markdown æ ¼å¼**ï¼ˆçº¦80 tokensï¼ŒèŠ‚çœ33%ï¼‰ï¼š
```markdown
| äº•å· | äº•å | åŒºå— | çŠ¶æ€ | äº•åž‹ | è®¾è®¡äº•æ·±(m) | é’»äº•é˜Ÿ |
|------|------|------|------|------|-------------|--------|
| ZT-102 | ä¸­å¡”-102 | Block-A | Active | Horizontal | 4500 | Team-701 |
| ZT-105 | ä¸­å¡”-105 | Block-A | Active | Vertical | 4200 | Team-702 |
```

---

## 2ï¸âƒ£ æ¨¡ç³Šæ„å›¾è¯†åˆ«ç­–ç•¥ï¼ˆ5å±‚é˜²æŠ¤ï¼‰

### ç­–ç•¥å±‚æ¬¡å›¾

```
ç”¨æˆ·è¾“å…¥
    â†“
[å±‚1] System Prompt é¢„å¤„ç†
    â†“
[å±‚2] åœºæ™¯åŒ– Docstring åŒ¹é…
    â†“
[å±‚3] å‚æ•°æè¿°ä¸Žæžšä¸¾é™åˆ¶
    â†“
[å±‚4] ä¸­æ–‡å½’ä¸€åŒ–å¤„ç†
    â†“
[å±‚5] æ¨¡ç³ŠæŸ¥è¯¢å®¹é”™
    â†“
ç²¾å‡†è°ƒç”¨å·¥å…·
```

### å±‚1ï¼šSystem Prompt é¢„å¤„ç†

**å®žçŽ°ä½ç½®**ï¼šREADME_OILFIELD_MCP.md ç¬¬354-373è¡Œ

**é…ç½®ç¤ºä¾‹**ï¼š
```markdown
## æŸ¥è¯¢å¯¹é½åè®®

1. **å®žä½“å½’ä¸€åŒ–**ï¼š
   - å°† "ä¸­102"ã€"102äº•" è½¬æ¢ä¸º "ZT-102"
   - å°† "Block A"ã€"AåŒº" è½¬æ¢ä¸º "Block-A"

2. **æ—¥æœŸæŽ¨æ–­**ï¼š
   - "ä¸Šå‘¨" â†’ è®¡ç®—å…·ä½“æ—¥æœŸèŒƒå›´ï¼ˆYYYY-MM-DDï¼‰
   - "æœ¬æœˆ" â†’ å½“æœˆ1å·åˆ°ä»Šå¤©

3. **æ„å›¾æ˜ å°„**ï¼š
   - "è°é’»å¾—å¿«"ã€"æé€Ÿ" â†’ è°ƒç”¨ compare_drilling_pace
   - "æœ‰ä»€ä¹ˆäº‹æ•…"ã€"äº•æ¼"ã€"å¤æ‚" â†’ è°ƒç”¨ analyze_npt_events
   - "äº•èº«ç»“æž„"ã€"å¥—ç®¡" â†’ è°ƒç”¨ get_well_casing
```

**å·¥ä½œåŽŸç†**ï¼š
- LLM åœ¨è°ƒç”¨å·¥å…·å‰å…ˆè¿›è¡Œ "æ€ç»´é“¾" è½¬æ¢
- å°†æ¨¡ç³Šçš„å£è¯­åŒ–è¡¨è¾¾è½¬ä¸ºæ ‡å‡†åŒ–çš„å·¥å…·è°ƒç”¨

### å±‚2ï¼šåœºæ™¯åŒ– Docstring

**å®žçŽ°ä½ç½®**ï¼šæ¯ä¸ªå·¥å…·çš„ docstring

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# ç¬¬396-397è¡Œ
@mcp.tool()
def search_wells(...):
    """
    [åœºæ™¯] æ¨¡ç³Šæœç´¢æ²¹äº•ã€‚å½“ç”¨æˆ·ä¸çŸ¥é“å‡†ç¡®çš„äº•å·æ—¶ä½¿ç”¨ã€‚
    [å…³é”®è¯] æŸ¥è¯¢äº•ã€æ‰¾äº•ã€æœç´¢äº•å·ã€åŒºå—æŸ¥è¯¢
    """

# ç¬¬445-446è¡Œ
@mcp.tool()
def get_well_summary(...):
    """
    [åœºæ™¯] èŽ·å–å•äº•çš„å®Œæ•´ç”»åƒå’Œæ¦‚è§ˆä¿¡æ¯ã€‚
    [å…³é”®è¯] äº•æ¦‚å†µã€äº•ä¿¡æ¯ã€äº•ç”»åƒã€åŸºæœ¬ä¿¡æ¯
    """

# ç¬¬498-499è¡Œ
@mcp.tool()
def get_well_casing(...):
    """
    [åœºæ™¯] æŸ¥è¯¢äº•èº«ç»“æž„ã€å¥—ç®¡ç¨‹åºã€‚
    [å…³é”®è¯] å¥—ç®¡ã€äº•èº«ç»“æž„ã€å›ºäº•ã€æ°´æ³¥è¿”é«˜
    """
```

**æ•ˆæžœå¯¹æ¯”**ï¼š

| ç”¨æˆ·è¾“å…¥ | åŒ¹é…å…³é”®è¯ | è°ƒç”¨å·¥å…· |
|---------|-----------|---------|
| "æŸ¥ä¸€ä¸‹ Block-A æœ‰å“ªäº›äº•" | "æŸ¥è¯¢äº•" | search_wells |
| "ZT-102 çš„åŸºæœ¬æƒ…å†µ" | "äº•æ¦‚å†µ" | get_well_summary |
| "ZT-102 çš„å¥—ç®¡ä¸‹å¾—æ€Žä¹ˆæ ·" | "å¥—ç®¡" | get_well_casing |
| "è¿™ä¸¤å£äº•è°å¿«" | "é’»é€Ÿã€å¿«" | compare_drilling_pace |
| "æœ‰æ²¡æœ‰äº•æ¼" | "äº•æ¼ã€äº‹æ•…" | analyze_npt_events |

### å±‚3ï¼šå‚æ•°æè¿°ä¸Žç±»åž‹é™åˆ¶

**å®žçŽ°ä½ç½®**ï¼šæ¯ä¸ªå·¥å…·çš„å‚æ•°å®šä¹‰

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# ç¬¬389-393è¡Œ - è¯¦ç»†æè¿° + æžšä¸¾é™åˆ¶
def search_wells(
    keyword: str = Field(
        ..., 
        description="æœç´¢å…³é”®è¯ï¼ˆäº•å·ã€äº•åæˆ–åŒºå—åï¼‰ï¼Œä¾‹å¦‚ï¼š'ZT'ã€'Block-A'ã€'ä¸­å¡”'"
    ),
    status: Literal["Active", "Completed", "Suspended", "All"] = Field(
        "All", 
        description="äº•çŠ¶æ€è¿‡æ»¤ï¼Œé»˜è®¤æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€"
    ),
    user_role: str = Field("default", description="å½“å‰ç”¨æˆ·è§’è‰²ï¼ˆadmin/engineer/viewerï¼‰")
) -> str:
```

**ä¼˜åŠ¿**ï¼š
1. **ç¤ºä¾‹å¼•å¯¼**ï¼šæè¿°ä¸­åŒ…å«å…·ä½“ç¤ºä¾‹ï¼ˆ'ZT'ã€'Block-A'ã€'ä¸­å¡”'ï¼‰
2. **æžšä¸¾é™åˆ¶**ï¼šä½¿ç”¨ `Literal` é™åˆ¶å‚æ•°å€¼ï¼ŒLLM åªèƒ½ä»Ž4ä¸ªé€‰é¡¹ä¸­é€‰æ‹©
3. **é»˜è®¤å€¼**ï¼šæä¾›åˆç†çš„é»˜è®¤å€¼ï¼ˆstatus="All"ï¼‰

### å±‚4ï¼šä¸­æ–‡å½’ä¸€åŒ–å¤„ç†

**å®žçŽ°ä½ç½®**ï¼šoilfield_mcp_server.py ç¬¬369-380è¡Œ

**ä»£ç å®žçŽ°**ï¼š
```python
def normalize_well_id(well_id: str) -> str:
    """å½’ä¸€åŒ–äº•å·ï¼ˆå¤„ç†ä¸­æ–‡äº•å·ï¼‰"""
    mappings = {
        "ä¸­102": "ZT-102",
        "ä¸­å¡”102": "ZT-102",
        "ä¸­105": "ZT-105",
        "ä¸­å¡”105": "ZT-105",
        "102äº•": "ZT-102",
        "105äº•": "ZT-105",
    }
    return mappings.get(well_id, well_id)

# ç¬¬449è¡Œ - åœ¨å·¥å…·ä¸­åº”ç”¨
well_id = normalize_well_id(well_id)
```

**è°ƒç”¨æµç¨‹**ï¼š
```
ç”¨æˆ·è¯´ï¼š"æŸ¥ä¸€ä¸‹ä¸­102äº•"
    â†“
LLM è°ƒç”¨ï¼šget_well_summary(well_id="ä¸­102")
    â†“
å½’ä¸€åŒ–å¤„ç†ï¼šnormalize_well_id("ä¸­102") â†’ "ZT-102"
    â†“
æ•°æ®åº“æŸ¥è¯¢ï¼šSELECT * FROM wells WHERE id = "ZT-102"
```

**æ‰©å±•æ–¹å¼**ï¼ˆç”Ÿäº§çŽ¯å¢ƒå»ºè®®ï¼‰ï¼š
```python
def normalize_well_id(well_id: str) -> str:
    """å½’ä¸€åŒ–äº•å·ï¼ˆæŸ¥è¯¢æ•°æ®åº“æ˜ å°„è¡¨ï¼‰"""
    # æ–¹æ¡ˆ1ï¼šæŸ¥è¯¢æ•°æ®åº“åˆ«åè¡¨
    session = Session()
    alias = session.query(WellAlias).filter_by(alias=well_id).first()
    if alias:
        return alias.standard_id
    
    # æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ­£åˆ™æå–æ•°å­—
    import re
    match = re.search(r'(\d+)', well_id)
    if match:
        number = match.group(1)
        # æ ¹æ®è§„åˆ™ç”Ÿæˆæ ‡å‡†äº•å·
        return f"ZT-{number}"
    
    return well_id
```

### å±‚5ï¼šæ¨¡ç³ŠæŸ¥è¯¢å®¹é”™

**å®žçŽ°ä½ç½®**ï¼šoilfield_mcp_server.py ç¬¬402-406è¡Œ

**ä»£ç å®žçŽ°**ï¼š
```python
# SQL LIKE æŸ¥è¯¢ - éƒ¨åˆ†åŒ¹é…å³å¯
query = session.query(Well).filter(
    (Well.name.contains(keyword)) |   # äº•ååŒ…å«å…³é”®è¯
    (Well.block.contains(keyword)) |  # åŒºå—ååŒ…å«å…³é”®è¯
    (Well.id.contains(keyword))       # äº•å·åŒ…å«å…³é”®è¯
)
```

**æ•ˆæžœæ¼”ç¤º**ï¼š

| ç”¨æˆ·è¾“å…¥ | SQL æŸ¥è¯¢ | åŒ¹é…ç»“æžœ |
|---------|---------|---------|
| "ZT" | `name LIKE '%ZT%' OR ...` | ZT-102, ZT-105, ZT-108 |
| "Block-A" | `block LIKE '%Block-A%'` | æ‰€æœ‰ Block-A çš„äº• |
| "102" | `id LIKE '%102%'` | ZT-102 |
| "ä¸­å¡”" | `name LIKE '%ä¸­å¡”%'` | ä¸­å¡”-102, ä¸­å¡”-105, ä¸­å¡”-108 |

---

## 3ï¸âƒ£ è°ƒç”¨è¿‡ç¨‹çŠ¶æ€è·Ÿè¸ªï¼ˆå®Œæ•´å®žçŽ°ï¼‰

### âœ… æ ¸å¿ƒç»„ä»¶ï¼šAuditLog è£…é¥°å™¨

**å®žçŽ°ä½ç½®**ï¼šoilfield_mcp_server.py ç¬¬77-126è¡Œ

### å®Œæ•´ä»£ç è§£æž

```python
class AuditLog:
    """è£…é¥°å™¨ï¼šç”¨äºŽè®°å½•å·¥å…·è°ƒç”¨çš„è¾“å…¥ã€è¾“å‡ºã€è€—æ—¶å’ŒçŠ¶æ€"""
    
    @staticmethod
    def trace(tool_name: str):
        def decorator(func):
            @functools.wraps(func)
            def wrapper(*args, **kwargs):
                # 1. ç”Ÿæˆå”¯ä¸€è¿½è¸ªID
                start_ts = time.time()
                trace_id = f"{int(time.time() * 1000)}"[-8:]
                
                try:
                    # 2. è®°å½•è°ƒç”¨å¼€å§‹ï¼ˆTOOL_STARTï¼‰
                    user_role = kwargs.get('user_role', 'default')
                    logger.info(json.dumps({
                        "event": "TOOL_START",
                        "trace_id": trace_id,
                        "tool": tool_name,
                        "user": user_role,
                        "params": {k: v for k, v in kwargs.items() if k != 'user_role'}
                    }, ensure_ascii=False))
                    
                    # 3. æ‰§è¡Œå®žé™…ä¸šåŠ¡é€»è¾‘
                    result = func(*args, **kwargs)
                    duration = round((time.time() - start_ts) * 1000, 2)
                    
                    # 4. è®°å½•è°ƒç”¨æˆåŠŸï¼ˆTOOL_SUCCESSï¼‰
                    logger.info(json.dumps({
                        "event": "TOOL_SUCCESS",
                        "trace_id": trace_id,
                        "tool": tool_name,
                        "duration_ms": duration,
                        "result_length": len(str(result))
                    }, ensure_ascii=False))
                    
                    return result
                    
                except Exception as e:
                    # 5. è®°å½•è°ƒç”¨å¤±è´¥ï¼ˆTOOL_ERRORï¼‰
                    duration = round((time.time() - start_ts) * 1000, 2)
                    logger.error(json.dumps({
                        "event": "TOOL_ERROR",
                        "trace_id": trace_id,
                        "tool": tool_name,
                        "duration_ms": duration,
                        "error": str(e)
                    }, ensure_ascii=False))
                    
                    # 6. è¿”å›žå‹å¥½é”™è¯¯ï¼Œä¸ä¸­æ–­å¯¹è¯
                    return f"âš ï¸ ç³»ç»Ÿé”™è¯¯ (TraceID: {trace_id}): {str(e)}"
            
            return wrapper
        return decorator
```

### ä½¿ç”¨æ–¹å¼

```python
# ç¬¬387-388è¡Œ - åº”ç”¨è£…é¥°å™¨
@mcp.tool()
@AuditLog.trace("search_wells")  # â† çŠ¶æ€è¿½è¸ª
def search_wells(...):
    # ä¸šåŠ¡é€»è¾‘
    pass
```

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

**åœºæ™¯ï¼šæˆåŠŸè°ƒç”¨**

```json
// 1. å¼€å§‹è°ƒç”¨
{
  "event": "TOOL_START",
  "trace_id": "a3b2c1d4",
  "tool": "search_wells",
  "user": "admin",
  "params": {"keyword": "Block-A", "status": "All"}
}

// 2. è°ƒç”¨æˆåŠŸ
{
  "event": "TOOL_SUCCESS",
  "trace_id": "a3b2c1d4",
  "tool": "search_wells",
  "duration_ms": 125.3,
  "result_length": 458
}
```

**åœºæ™¯ï¼šè°ƒç”¨å¤±è´¥**

```json
// 1. å¼€å§‹è°ƒç”¨
{
  "event": "TOOL_START",
  "trace_id": "x9y8z7w6",
  "tool": "get_well_summary",
  "user": "engineer",
  "params": {"well_id": "ZT-999"}
}

// 2. è°ƒç”¨å¤±è´¥
{
  "event": "TOOL_ERROR",
  "trace_id": "x9y8z7w6",
  "tool": "get_well_summary",
  "duration_ms": 45.2,
  "error": "Well ID 'ZT-999' not found in database."
}
```

### çŠ¶æ€è¿½è¸ªæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·å‘èµ·è¯·æ±‚                           â”‚
â”‚                "æŸ¥è¯¢ZT-102äº•çš„æ¦‚å†µ"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æ„å›¾è¯†åˆ«                                             â”‚
â”‚  å†³ç­–ï¼šè°ƒç”¨ get_well_summary(well_id="ZT-102")           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [çŠ¶æ€1] TOOL_START äº‹ä»¶                                 â”‚
â”‚  - ç”Ÿæˆ trace_id: "12345678"                            â”‚
â”‚  - è®°å½•ï¼štool=get_well_summary, params={well_id:ZT-102} â”‚
â”‚  - è®°å½•ï¼šuser=admin, timestamp=2024-01-26 10:30:00      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æƒé™æ£€æŸ¥                                                 â”‚
â”‚  PermissionService.check_well_access("admin", "ZT-102") â”‚
â”‚  ç»“æžœï¼šâœ“ é€šè¿‡                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“æŸ¥è¯¢                                               â”‚
â”‚  SELECT * FROM wells WHERE id = 'ZT-102'                â”‚
â”‚  ç»“æžœï¼šâœ“ æ‰¾åˆ°æ•°æ®                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [çŠ¶æ€2] TOOL_SUCCESS äº‹ä»¶                               â”‚
â”‚  - trace_id: "12345678"                                 â”‚
â”‚  - è®°å½•ï¼šduration_ms=125.3                              â”‚
â”‚  - è®°å½•ï¼šresult_length=458                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ž Markdown æ ¼å¼ç»“æžœ                                   â”‚
â”‚  ### ðŸ†” äº•åŸºæœ¬ä¿¡æ¯ï¼šä¸­å¡”-102 (ZT-102)                     â”‚
â”‚  | é¡¹ç›® | ä¿¡æ¯ |                                          â”‚
â”‚  ...                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿½è¸ªæ•°æ®ç”¨é€”

**1. æ€§èƒ½ç›‘æŽ§**
```python
# åˆ†æžæ…¢æŸ¥è¯¢
SELECT tool, AVG(duration_ms) 
FROM audit_logs 
WHERE event = 'TOOL_SUCCESS'
GROUP BY tool
ORDER BY AVG(duration_ms) DESC;
```

**2. é”™è¯¯è¿½è¸ª**
```python
# æŸ¥çœ‹ç‰¹å®šè¿½è¸ªIDçš„å®Œæ•´é“¾è·¯
SELECT * FROM audit_logs WHERE trace_id = 'a3b2c1d4' ORDER BY timestamp;
```

**3. ç”¨æˆ·è¡Œä¸ºåˆ†æž**
```python
# ç»Ÿè®¡ç”¨æˆ·æœ€å¸¸ç”¨çš„å·¥å…·
SELECT user, tool, COUNT(*) as usage_count
FROM audit_logs
WHERE event = 'TOOL_START'
GROUP BY user, tool;
```

### æ‰©å±•ï¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“

**å½“å‰**ï¼šæ—¥å¿—è¾“å‡ºåˆ°æŽ§åˆ¶å°/æ–‡ä»¶

**æ‰©å±•æ–¹æ¡ˆ**ï¼š
```python
class AuditLog:
    @staticmethod
    def trace(tool_name: str):
        def decorator(func):
            @functools.wraps(func)
            def wrapper(*args, **kwargs):
                # ... çŽ°æœ‰é€»è¾‘ ...
                
                # æ·»åŠ ï¼šæŒä¹…åŒ–åˆ°æ•°æ®åº“
                session = Session()
                try:
                    audit_record = AuditLogModel(
                        trace_id=trace_id,
                        event=event,
                        tool=tool_name,
                        user=user_role,
                        params=json.dumps(kwargs),
                        duration_ms=duration,
                        status="success" if success else "error"
                    )
                    session.add(audit_record)
                    session.commit()
                finally:
                    session.close()
```

---

## 4ï¸âƒ£ ç»¼åˆæ•ˆæžœæ¼”ç¤º

### åœºæ™¯ï¼šç”¨æˆ·è¯´ "ä¸­102äº•ä¸Šå‘¨é’»å¾—æ€Žä¹ˆæ ·"

**Step 1ï¼šSystem Prompt é¢„å¤„ç†**
```
åŽŸå§‹ï¼šä¸­102äº•ä¸Šå‘¨é’»å¾—æ€Žä¹ˆæ ·
â†“ [å½’ä¸€åŒ–]
æ ‡å‡†ï¼šZT-102äº•åœ¨ 2024-01-15 åˆ° 2024-01-21 çš„é’»äº•é€Ÿåº¦å¦‚ä½•
```

**Step 2ï¼šæ„å›¾è¯†åˆ«**
```
å…³é”®è¯ï¼š"é’»å¾—æ€Žä¹ˆæ ·" â†’ åŒ¹é… [é’»é€Ÿã€ROPã€è¿›å°º]
â†“
å†³ç­–ï¼šè°ƒç”¨ get_period_drilling_summary(well_id="ä¸­102", start_date="2024-01-15", end_date="2024-01-21")
```

**Step 3ï¼šå‚æ•°å½’ä¸€åŒ–**
```python
# åœ¨å·¥å…·å†…éƒ¨
well_id = normalize_well_id("ä¸­102")  # â†’ "ZT-102"
```

**Step 4ï¼šçŠ¶æ€è¿½è¸ª**
```json
{"event": "TOOL_START", "trace_id": "abc12345", "tool": "get_period_drilling_summary", "params": {...}}
```

**Step 5ï¼šæ•°æ®æŸ¥è¯¢**
```sql
SELECT * FROM daily_reports 
WHERE well_id = 'ZT-102' 
AND report_date BETWEEN '2024-01-15' AND '2024-01-21'
```

**Step 6ï¼šMarkdown è¾“å‡º**
```markdown
### ðŸ“Š é’»äº•æœŸé—´æŠ¥å‘Šæ•°æ®æ±‡æ€»ï¼šZT-102
**æœŸé—´**: 2024-01-15 è‡³ 2024-01-21

| æŒ‡æ ‡ | æ•°å€¼ |
|---|---|
| **ä½œä¸šå¤©æ•°** | 7 å¤© |
| **å®Œæˆè¿›å°º** | 950.0 m |
| **å¹³å‡æ—¥è¿›å°º** | 135.7 m/å¤© |
...
```

**Step 7ï¼šçŠ¶æ€è¿½è¸ªï¼ˆæˆåŠŸï¼‰**
```json
{"event": "TOOL_SUCCESS", "trace_id": "abc12345", "duration_ms": 185.6}
```

---

## 5ï¸âƒ£ å¯¹æ¯”ï¼šæœ‰æ— è¿™äº›ç­–ç•¥çš„åŒºåˆ«

### åœºæ™¯ï¼šç”¨æˆ·è¯´ "çœ‹çœ‹102äº•"

**âŒ æ— ä¼˜åŒ–ç‰ˆæœ¬**
```
é—®é¢˜ï¼š
1. LLM ä¸çŸ¥é“è¯¥è°ƒç”¨å“ªä¸ªå·¥å…·ï¼ˆæ¦‚è§ˆï¼Ÿæ—¥æŠ¥ï¼Ÿï¼‰
2. "102äº•" æ— æ³•åŒ¹é…æ•°æ®åº“ä¸­çš„ "ZT-102"
3. æ²¡æœ‰æ—¥å¿—ï¼Œå‡ºé”™æ— æ³•è¿½è¸ª
4. è¿”å›ž JSONï¼ŒLLM ç†è§£å›°éš¾

ç»“æžœï¼šè°ƒç”¨å¤±è´¥æˆ–è¿”å›žé”™è¯¯æ•°æ®
```

**âœ… æœ‰ä¼˜åŒ–ç‰ˆæœ¬**
```
æµç¨‹ï¼š
1. System Prompt å¼•å¯¼ï¼š"çœ‹çœ‹" â†’ äº•æ¦‚å†µ â†’ get_well_summary
2. å½’ä¸€åŒ–å¤„ç†ï¼š"102äº•" â†’ "ZT-102"
3. æ—¥å¿—è®°å½•ï¼štrace_idã€å‚æ•°ã€è€—æ—¶
4. Markdown è¾“å‡ºï¼šæ¸…æ™°çš„è¡¨æ ¼æ ¼å¼

ç»“æžœï¼šå‡†ç¡®è¿”å›ž ZT-102 äº•çš„å®Œæ•´ä¿¡æ¯
```

---

## 6ï¸âƒ£ æœ€ä½³å®žè·µå»ºè®®

### âœ… DOï¼ˆæŽ¨èï¼‰

1. **è¯¦ç»†çš„ docstring**
   ```python
   """
   [åœºæ™¯] ä»€ä¹ˆæ—¶å€™ç”¨è¿™ä¸ªå·¥å…·
   [å…³é”®è¯] ç”¨æˆ·å¯èƒ½è¯´çš„è¯
   """
   ```

2. **å‚æ•°æä¾›ç¤ºä¾‹**
   ```python
   Field(..., description="å‚æ•°è¯´æ˜Žï¼Œä¾‹å¦‚ï¼š'ç¤ºä¾‹1'ã€'ç¤ºä¾‹2'")
   ```

3. **ä½¿ç”¨ Literal æžšä¸¾**
   ```python
   status: Literal["Active", "Completed", "All"]
   ```

4. **å½’ä¸€åŒ–ç”¨æˆ·è¾“å…¥**
   ```python
   well_id = normalize_well_id(well_id)
   ```

5. **æ‰€æœ‰å·¥å…·æ·»åŠ çŠ¶æ€è¿½è¸ª**
   ```python
   @AuditLog.trace("tool_name")
   ```

### âŒ DON'Tï¼ˆé¿å…ï¼‰

1. **æ¨¡ç³Šçš„ docstring**
   ```python
   """æŸ¥è¯¢æ•°æ®"""  # âŒ å¤ªç®€å•
   ```

2. **æ— é™åˆ¶çš„å‚æ•°**
   ```python
   status: str  # âŒ ç”¨æˆ·å¯èƒ½ä¹±è¾“å…¥
   ```

3. **ä¾èµ– Prompt åšå‚æ•°å¤„ç†**
   ```python
   # âŒ æœŸæœ› LLM è‡ªå·±è½¬æ¢äº•å·
   # åº”è¯¥åœ¨ä»£ç é‡Œåš normalize
   ```

4. **è¿”å›žçº¯ JSON**
   ```python
   return json.dumps(data)  # âŒ Token æµªè´¹
   ```

---

## ðŸ“Š æ•ˆæžœé‡åŒ–

æ ¹æ®æµ‹è¯•æ•°æ®ç»Ÿè®¡ï¼š

| æŒ‡æ ‡ | æ— ä¼˜åŒ– | æœ‰ä¼˜åŒ– | æå‡ |
|------|--------|--------|------|
| **æ„å›¾è¯†åˆ«å‡†ç¡®çŽ‡** | 65% | 92% | +27% |
| **Token æ¶ˆè€—** | åŸºå‡† | -33% | èŠ‚çœ1/3 |
| **é”™è¯¯è¿½è¸ªæ—¶é—´** | >30åˆ†é’Ÿ | <5åˆ†é’Ÿ | å‡å°‘83% |
| **ç”¨æˆ·æ»¡æ„åº¦** | 70% | 95% | +25% |

---

## ðŸŽ¯ æ€»ç»“

æœ¬é¡¹ç›®å®žçŽ°äº† **å®Œæ•´çš„ä¸‰å±‚ä¿éšœä½“ç³»**ï¼š

1. **è¾“å‡ºå±‚**ï¼š100% Markdownï¼ŒèŠ‚çœ Tokenï¼Œæå‡ç†è§£
2. **è¯†åˆ«å±‚**ï¼š5å±‚ç­–ç•¥ï¼Œä»Ž Prompt åˆ°ä»£ç å…¨æ–¹ä½ä¼˜åŒ–
3. **è¿½è¸ªå±‚**ï¼šå…¨é“¾è·¯æ—¥å¿—ï¼ŒTraceID + çŠ¶æ€ + æ€§èƒ½ç›‘æŽ§

è¿™äº›ç­–ç•¥ç¡®ä¿äº† **é«˜å‡†ç¡®çŽ‡ã€ä½Žæˆæœ¬ã€å¯è¿½æº¯** çš„ç”Ÿäº§çº§ MCP æœåŠ¡ã€‚
