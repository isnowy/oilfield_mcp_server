# 三个日报快速使用指南

## 快速开始

### 启动 MCP Server
```bash
# 生产模式（启用权限控制）
set DEV_MODE=false
python oilfield_mcp_true_server.py

# 或开发模式（跳过权限检查）
set DEV_MODE=true
python oilfield_mcp_true_server.py
```

Server 将在 `http://localhost:8081` 启动

---

## 使用示例

### 示例 1: 查询某井的钻井工程日报

```bash
curl -X POST http://localhost:8081/sse \
  -H "Content-Type: application/json" \
  -H "x-user-role: ADMIN" \
  -H "x-user-email: admin@example.com" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "get_drilling_daily",
      "arguments": {
        "well_id": "ZT-102",
        "start_date": "2024-02-01",
        "end_date": "2024-02-27",
        "limit": 50
      }
    }
  }'
```

**响应**: Markdown 格式的日报表格
- 包含日期、井号、当日井深、日进尺、钻头类型、钻速等信息

---

### 示例 2: 查询钻前工程进度

```bash
curl -X POST http://localhost:8081/sse \
  -H "Content-Type: application/json" \
  -H "x-user-role: ENGINEER" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/call",
    "params": {
      "name": "get_drilling_pre_daily",
      "arguments": {
        "project": "勘探项目A",
        "year": 2024
      }
    }
  }'
```

**响应**: 项目的钻前进度，包括关键时间节点
- 井位论证时间、工程设计审批、环评下达、搬家安装等

---

### 示例 3: 查询重点井生产数据

```bash
curl -X POST http://localhost:8081/sse \
  -H "Content-Type: application/json" \
  -H "x-user-role: VIEWER" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "tools/call",
    "params": {
      "name": "get_key_well_daily",
      "arguments": {
        "block": "Block-A",
        "start_date": "2024-02-20",
        "limit": 30
      }
    }
  }'
```

**响应**: 重点井生产日报
- 日期、井号、日产气量、含水率、压力参数等

---

## 权限控制

### 用户角色
系统支持五种角色，可通过 HTTP Header 设置:

```
x-user-role: ADMIN      # 管理员 - 完全访问
x-user-role: ENGINEER   # 工程师 - 部分井 + 项目
x-user-role: VIEWER     # 查看者 - 只读特定井
x-user-role: USER       # 普通用户 - 仅公共数据
x-user-role: GUEST      # 访客 - 仅公共数据
```

### 权限配置

编辑 `oilfield_mcp_true_server.py` 中的 `USER_PERMISSIONS`:

```python
USER_PERMISSIONS = {
    "ADMIN": {
        "wells": "*",           # 所有井
        "blocks": "*"           # 所有区块
    },
    "ENGINEER": {
        "wells": ["ZT-102", "ZT-105"],
        "blocks": ["Block-A"]
    },
    "VIEWER": {
        "wells": ["ZT-102"],
        "blocks": ["Block-A"]
    }
}
```

---

## 可用工具列表

### 工具名称: `get_drilling_daily`
| 参数 | 类型 | 说明 | 必需 |
|------|------|------|------|
| well_id | string | 井号 | ❌ |
| start_date | string | 开始日期 (YYYY-MM-DD) | ❌ |
| end_date | string | 结束日期 (YYYY-MM-DD) | ❌ |
| limit | integer | 返回数量 | ❌ (默认100) |

### 工具名称: `get_drilling_pre_daily`
| 参数 | 类型 | 说明 | 必需 |
|------|------|------|------|
| project | string | 勘探项目名 | ❌ |
| year | integer | 实施年度 | ❌ |
| well_id | string | 井号 | ❌ |
| limit | integer | 返回数量 | ❌ (默认50) |

### 工具名称: `get_key_well_daily`
| 参数 | 类型 | 说明 | 必需 |
|------|------|------|------|
| well_id | string | 井号 | ❌ |
| start_date | string | 开始日期 (YYYY-MM-DD) | ❌ |
| end_date | string | 结束日期 (YYYY-MM-DD) | ❌ |
| block | string | 区块 | ❌ |
| limit | integer | 返回数量 | ❌ (默认100) |

---

## 常见查询场景

### 场景1: 获取最近7天的钻井日报
```python
from datetime import date, timedelta

today = date.today()
start = today - timedelta(days=7)

arguments = {
    "well_id": "ZT-102",
    "start_date": str(start),
    "end_date": str(today)
}
```

### 场景2: 查询某项目的所有钻井井进展
```python
arguments = {
    "project": "区块A勘探",
    "year": 2024,
    "limit": 100
}
```

### 场景3: 监控某区块重点井压力参数异常
```python
arguments = {
    "block": "Block-A",
    "start_date": "2024-02-20",
    "limit": 50
}
# 输出会包含详细的压力参数信息
```

---

## 故障排除

### Q: 返回 "权限拒绝" 错误
**A**: 检查用户角色和权限配置
- 确认 `x-user-role` Header 设置正确
- 查看 `USER_PERMISSIONS` 中该角色的配置
- 在开发模式下测试（`DEV_MODE=true`）

### Q: 返回 "未找到数据" 错误
**A**: 检查查询参数
- 确认井号、项目名、日期格式正确
- 确认数据库中确实存在这些记录
- 尝试减少 WHERE 条件，扩大查询范围

### Q: 数据库连接失败
**A**: 检查数据库配置
```bash
# 环境变量设置
set DB_HOST=localhost
set DB_PORT=5432
set DB_NAME=rag
set DB_USER=postgres
set DB_PASSWORD=postgres
```

---

## Python 集成示例

```python
import requests
import json
from datetime import date

def query_drilling_daily(well_id: str, days: int = 30):
    """查询某井最近N天的钻井日报"""
    
    today = date.today()
    from datetime import timedelta
    start = today - timedelta(days=days)
    
    url = "http://localhost:8081/sse"
    headers = {
        "Content-Type": "application/json",
        "x-user-role": "ADMIN",
        "x-user-email": "admin@example.com"
    }
    
    payload = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "tools/call",
        "params": {
            "name": "get_drilling_daily",
            "arguments": {
                "well_id": well_id,
                "start_date": str(start),
                "end_date": str(today),
                "limit": 100
            }
        }
    }
    
    response = requests.post(url, json=payload, headers=headers)
    result = response.json()
    
    if "result" in result:
        return result["result"]["content"][0]["text"]
    else:
        return f"错误: {result.get('error', {}).get('message', '未知错误')}"

# 使用
print(query_drilling_daily("ZT-102", days=7))
```

---

## 监控和日志

所有工具调用都会被记录。查看日志:

```bash
# 日志包含
- 工具调用开始: TOOL_START
- 工具执行成功: TOOL_SUCCESS (包含执行时间)
- 工具执行失败: TOOL_ERROR (包含错误信息)
- 用户信息: 邮箱、角色、用户ID
- 参数信息: 调用参数
```

---

## 扩展功能建议

- [ ] 添加数据聚合分析（求和、平均等）
- [ ] 添加数据导出功能（CSV、Excel）
- [ ] 添加实时告警（异常值检测）
- [ ] 添加数据对比功能（不同井、不同时期）
- [ ] 添加图表推荐（自动识别最优图表类型）

