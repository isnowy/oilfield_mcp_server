# 权限控制使用指南

## ✨ 新特性

您的 MCP 服务器现在支持**灵活的权限控制模式**：

- 🔓 **开发模式**：方便测试，所有用户自动拥有全部权限
- 🔒 **生产模式**：严格控制，基于角色的权限管理

## 🚀 快速开始

### 方式 1: 使用启动脚本（推荐）

#### 开发/测试环境
```powershell
.\start_dev.ps1
```

#### 生产环境
```powershell
.\start_prod.ps1
```

### 方式 2: 手动设置环境变量

#### 开发模式
```powershell
$env:DEV_MODE="true"
python oilfield_mcp_server.py
```

#### 生产模式
```powershell
$env:DEV_MODE="false"
python oilfield_mcp_server.py
```

## 🧪 测试权限配置

运行测试脚本验证权限配置：

```powershell
# 测试开发模式
python test_permissions.py

# 测试生产模式
$env:DEV_MODE="false"
python test_permissions.py
```

## 📊 两种模式对比

| 特性 | 开发模式 | 生产模式 |
|-----|---------|---------|
| **环境变量** | `DEV_MODE=true` | `DEV_MODE=false` |
| **权限检查** | 跳过 | 严格执行 |
| **default 角色** | 全部权限 | 无权限 |
| **适用场景** | 本地开发、测试 | 正式部署 |
| **安全性** | 低（仅测试用） | 高 |

## 📁 文件说明

| 文件 | 说明 |
|-----|------|
| `oilfield_mcp_server.py` | MCP 服务器主程序（已添加开发模式支持） |
| `start_dev.ps1` | 开发模式启动脚本 |
| `start_prod.ps1` | 生产模式启动脚本 |
| `test_permissions.py` | 权限测试脚本 |
| `PERMISSION_CONFIG.md` | 详细权限配置文档 |
| `librechat.yaml` | LibreChat 配置文件 |

## 🎯 使用场景

### 场景 1: 本地开发

```powershell
# 使用开发模式，无需关心权限
.\start_dev.ps1

# 或
$env:DEV_MODE="true"
python oilfield_mcp_server.py
```

**特点**：
- ✅ 快速测试所有功能
- ✅ 无需配置用户角色
- ✅ 所有查询都能返回数据

### 场景 2: 功能演示

```powershell
# 开发模式，展示全部功能
.\start_dev.ps1
```

**特点**：
- ✅ 演示所有井和区块的数据
- ✅ 无权限限制

### 场景 3: 生产部署

```powershell
# 生产模式，启用严格权限
.\start_prod.ps1
```

**特点**：
- ✅ 严格的基于角色的访问控制
- ✅ 不同用户看到不同数据
- ✅ 符合安全规范

### 场景 4: 权限测试

```powershell
# 测试不同角色的权限
python test_permissions.py

# 切换到生产模式测试
$env:DEV_MODE="false"
python test_permissions.py
```

## 👥 生产模式权限说明

在生产模式（`DEV_MODE=false`）下：

| 角色 | 可访问的井 | 可访问的区块 |
|------|-----------|-------------|
| **admin** | 所有井 | 所有区块 |
| **engineer** | ZT-102, ZT-105 | Block-A |
| **viewer** | ZT-102 | Block-A |
| **default** | 无 | 无 |

## ⚙️ 配置到 LibreChat

编辑 `librechat.yaml`：

```yaml
mcpServers:
  oilfield-data:
    command: python
    args:
      - "d:/work/joyagent/gemini-ge/oilfield_mcp_server.py"
    env:
      DEV_MODE: "true"  # 开发：true，生产：false
```

## 🔧 自定义权限

编辑 `oilfield_mcp_server.py` 中的 `USER_PERMISSIONS`：

```python
USER_PERMISSIONS = {
    "admin": {
        "wells": "*",                           # 所有井
        "blocks": "*",                          # 所有区块
        "role": "admin"
    },
    "custom_role": {
        "wells": ["ZT-102", "ZT-105"],          # 指定井
        "blocks": ["Block-A", "Block-B"],       # 指定区块
        "role": "custom"
    },
}
```

## 💡 最佳实践

### ✅ 推荐做法

1. **开发阶段**：使用 `start_dev.ps1` 或 `DEV_MODE=true`
2. **生产部署**：使用 `start_prod.ps1` 或 `DEV_MODE=false`
3. **测试权限**：部署前运行 `test_permissions.py` 验证
4. **环境隔离**：不同环境使用不同配置文件

### ❌ 避免做法

1. ❌ 生产环境使用 `DEV_MODE=true`
2. ❌ 硬编码敏感信息
3. ❌ 在代码中直接修改权限后不测试

油田钻井数据查询 MCP 服务器支持**基于角色的权限控制**（RBAC），并提供**开发模式**方便测试。

## 🔓 开发模式 vs 🔒 生产模式

### 开发模式（默认）

- **用途**：本地开发、测试、演示
- **特点**：所有用户自动拥有 admin 权限，无需配置
- **启用方式**：设置环境变量 `DEV_MODE=true`（默认）

```yaml
# librechat.yaml 配置示例
env:
  DEV_MODE: "true"  # 开发模式
```

### 生产模式

- **用途**：正式部署、多用户环境
- **特点**：严格的基于角色的权限控制
- **启用方式**：设置环境变量 `DEV_MODE=false`

```yaml
# librechat.yaml 配置示例
env:
  DEV_MODE: "false"  # 生产模式
```

## 👥 权限角色说明

在**生产模式**下，系统支持以下角色：

| 角色 | 权限范围 | 可访问的井 | 可访问的区块 | 典型用途 |
|------|---------|-----------|-------------|---------|
| **admin** | 全部权限 | 所有井 | 所有区块 | 系统管理员 |
| **engineer** | 部分权限 | ZT-102, ZT-105 | Block-A | 工程师 |
| **viewer** | 只读权限 | ZT-102 | Block-A | 只读访客 |
| **default** | 受限访问 | 无 | 无 | 未授权用户 |

## ⚙️ 配置方式

### 方式 1: 环境变量（推荐）

```bash
# Windows PowerShell
$env:DEV_MODE="true"    # 开发模式
$env:DEV_MODE="false"   # 生产模式

# Linux/Mac
export DEV_MODE=true    # 开发模式
export DEV_MODE=false   # 生产模式
```

### 方式 2: LibreChat 配置文件

编辑 `librechat.yaml`：

```yaml
mcpServers:
  oilfield-data:
    command: python
    args:
      - "d:/work/joyagent/gemini-ge/oilfield_mcp_server.py"
    env:
      DEV_MODE: "true"  # 改为 "false" 启用生产模式
```

### 方式 3: Claude Desktop 配置

编辑 `claude_desktop_config.json`：

```json
{
  "mcpServers": {
    "oilfield-data": {
      "command": "python",
      "args": ["d:/work/joyagent/gemini-ge/oilfield_mcp_server.py"],
      "env": {
        "DEV_MODE": "true"
      }
    }
  }
}
```

## 🛠️ 自定义权限配置

如需修改权限配置，编辑 `oilfield_mcp_server.py` 中的 `USER_PERMISSIONS`：

```python
USER_PERMISSIONS = {
    "admin": {
        "wells": "*",              # "*" 表示所有井
        "blocks": "*",             # "*" 表示所有区块
        "role": "admin"
    },
    "engineer": {
        "wells": ["ZT-102", "ZT-105", "ZT-108"],  # 指定可访问的井
        "blocks": ["Block-A"],                    # 指定可访问的区块
        "role": "engineer"
    },
    "viewer": {
        "wells": ["ZT-102"],
        "blocks": ["Block-A"],
        "role": "viewer"
    },
    "default": {
        "wells": [],               # 空列表表示无权限
        "blocks": [],
        "role": "guest"
    }
}
```

## 📊 权限检查逻辑

### 开发模式（DEV_MODE=true）

```python
# 所有权限检查都返回 True
check_well_access("default", "ZT-102")  # ✅ 返回 True
check_block_access("default", "Block-A") # ✅ 返回 True
get_accessible_wells("default")         # ✅ 返回 "*" (所有井)
```

### 生产模式（DEV_MODE=false）

```python
# 严格按照角色权限检查
check_well_access("engineer", "ZT-102")  # ✅ 返回 True (有权限)
check_well_access("engineer", "XY-009")  # ❌ 返回 False (无权限)
check_well_access("admin", "XY-009")     # ✅ 返回 True (admin全部权限)
```

## 🧪 测试不同模式

### 测试开发模式

1. 设置环境变量：
   ```bash
   $env:DEV_MODE="true"
   ```

2. 启动服务：
   ```bash
   python oilfield_mcp_server.py
   ```

3. 查看启动信息：
   ```
   🔓 权限模式：开发模式 (所有用户拥有 admin 权限)
      提示：生产环境请设置环境变量 DEV_MODE=false
   ```

4. 测试查询（任何角色都能访问所有数据）：
   ```
   查询所有油井  # ✅ 成功
   搜索 Block-B 的井  # ✅ 成功
   ```

### 测试生产模式

1. 设置环境变量：
   ```bash
   $env:DEV_MODE="false"
   ```

2. 启动服务：
   ```bash
   python oilfield_mcp_server.py
   ```

3. 查看启动信息：
   ```
   🔒 权限模式：生产模式 (严格权限控制)
   
   📌 权限角色：
     • admin   - 全部权限
     • engineer - Block-A的部分井
     • viewer  - ZT-102只读
     • default - 受限访问
   ```

4. 测试查询（根据角色限制）：
   ```
   # 使用 default 角色
   查询所有油井  # ❌ 无权限，返回空
   
   # 使用 admin 角色
   查询所有油井  # ✅ 成功
   ```

## 🎯 推荐实践

### 开发/测试阶段

```yaml
env:
  DEV_MODE: "true"  # 方便快速测试所有功能
```

### 生产部署

```yaml
env:
  DEV_MODE: "false"  # 启用严格权限控制
  # 其他生产环境配置...
```

### 多环境配置

创建不同的配置文件：

```bash
# 开发环境
librechat.dev.yaml    (DEV_MODE=true)

# 测试环境
librechat.test.yaml   (DEV_MODE=true)

# 生产环境
librechat.prod.yaml   (DEV_MODE=false)
```

## ⚠️ 安全提示

1. **生产环境务必设置 `DEV_MODE=false`**
2. **定期审查权限配置**
3. **使用环境变量而非硬编码密钥**
4. **记录所有权限变更**
5. **测试完成后删除临时权限**

## 📝 常见问题

### Q1: 为什么查询不到数据？

**A**: 检查以下几点：
1. 是否在生产模式（DEV_MODE=false）下使用了 `default` 角色
2. 当前角色是否有权限访问目标井或区块
3. 数据库中是否有数据

### Q2: 如何快速切换模式？

**A**: 修改环境变量后重启服务即可：
```bash
# 切换到开发模式
$env:DEV_MODE="true"
python oilfield_mcp_server.py

# 切换到生产模式  
$env:DEV_MODE="false"
python oilfield_mcp_server.py
```

### Q3: 可以在运行时切换模式吗？

**A**: 不可以。权限模式在服务启动时确定，需要重启服务才能切换。

### Q4: 如何为新用户添加权限？

**A**: 编辑 `USER_PERMISSIONS` 字典，添加新的角色配置，然后重启服务。


## 🎉 总结

现在您的 MCP 服务器支持：

✅ **灵活切换**：开发模式 ↔️ 生产模式  
✅ **保留权限代码**：完整的 RBAC 实现  
✅ **方便测试**：一键启动开发模式  
✅ **安全部署**：生产环境严格控制  
✅ **快速验证**：测试脚本验证权限

开始使用：`.\start_dev.ps1` 🚀
