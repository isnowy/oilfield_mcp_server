# 批量查询功能测试说明

本目录包含两个测试文件，用于测试新增的批量查询功能和原有的单个查询功能。

## 测试文件

### 1. `test_batch_queries.py` - 直接函数调用测试

直接调用业务逻辑函数进行测试，不需要启动HTTP服务器。

**测试内容：**
- ✅ search_wells - 单关键词搜索（旧接口）
- ✅ search_wells - 多关键词批量搜索（新接口）
- ✅ get_well_summary - 单井概况查询（旧接口）
- ✅ get_well_summary - 多井批量概况查询（新接口）
- ✅ get_daily_report - 单井单日期查询（旧接口）
- ✅ get_daily_report - 日期为空（列出可用日期）
- ✅ get_daily_report - 多井同一日期批量查询（新接口）
- ✅ get_daily_report - 多井多日期批量查询（新接口）
- ✅ generate_weekly_report - 单井周报生成（旧接口）
- ✅ generate_weekly_report - 多井批量周报生成（新接口）
- ✅ 权限测试 - 非管理员用户
- ✅ 错误处理 - 不存在的井号

**运行方法：**
```bash
python test_batch_queries.py
```

### 2. `test_http_batch_queries.py` - HTTP API 测试

通过HTTP请求测试API端点，需要先启动HTTP服务器。

**测试内容：**
- ✅ search_wells - 单关键词搜索
- ✅ search_wells - 多关键词批量搜索
- ✅ get_well_summary - 单井查询
- ✅ get_well_summary - 多井批量查询
- ✅ get_daily_report - 多井同一日期批量查询
- ✅ get_daily_report - 多井多日期批量查询
- ✅ generate_weekly_report - 单井周报生成
- ✅ generate_weekly_report - 多井批量周报生成
- ✅ 权限测试 - VIEWER用户
- ✅ 错误处理 - 不存在的井号

**运行方法：**

1. 先启动HTTP服务器：
```bash
python oilfield_mcp_http_server.py
# 或使用批处理文件
start_http_server.bat
```

2. 在另一个终端运行测试：
```bash
python test_http_batch_queries.py
```

## 运行完整测试流程

### 步骤 1: 确保数据库已初始化

```bash
python init_db.py
```

### 步骤 2: 运行直接函数调用测试

```bash
python test_batch_queries.py
```

### 步骤 3: 启动HTTP服务器

```bash
# Windows
start_http_server.bat

# 或直接运行
python oilfield_mcp_http_server.py
```

### 步骤 4: 运行HTTP API测试

在新的终端窗口：
```bash
python test_http_batch_queries.py
```

## 测试覆盖的功能

### 批量查询功能（新增）

1. **批量搜索** - 支持多个关键词同时搜索
   ```json
   {
     "keywords": ["ZT", "Block-A"],
     "status": "All"
   }
   ```

2. **批量获取井概况** - 支持一次查询多口井
   ```json
   {
     "well_ids": ["ZT-102", "ZT-105", "ZT-108"]
   }
   ```

3. **批量获取日报** - 支持多种批量模式
   - 多井同一日期：
   ```json
   {
     "well_ids": ["ZT-102", "ZT-105"],
     "date": "2023-11-01"
   }
   ```
   
   - 多井多日期（一一对应）：
   ```json
   {
     "well_ids": ["ZT-102", "ZT-105"],
     "dates": ["2023-11-01", "2023-11-02"]
   }
   ```

4. **批量生成周报** - 支持多口井同时生成周报
   ```json
   {
     "well_ids": ["ZT-102", "ZT-105"],
     "start_date": "2023-11-01",
     "end_date": "2023-11-07"
   }
   ```

### 向后兼容（旧接口）

所有旧的单参数接口仍然可用：
- `keyword` (单个关键词)
- `well_id` (单个井号)
- `date` (单个日期)

### 权限控制测试

测试不同角色用户访问权限：
- ADMIN - 完全访问权限
- VIEWER - 受限访问权限

### 错误处理测试

测试各种错误场景：
- 不存在的井号
- 无效的日期格式
- 权限拒绝
- 数据不存在

## 预期输出

### 成功的测试输出示例

```
================================================================================
📋 测试: search_wells - 多关键词批量搜索（新接口）
================================================================================
参数: keywords=['ZT', 'Block-A']

### 🔍 搜索结果（关键词：ZT、Block-A，共 5 口井）

| 井号     | 井名      | 区块    | 状态      | ...
|----------|-----------|---------|-----------|---
| ZT-102   | 中塔-102  | Block-A | Active    | ...
| ZT-105   | 中塔-105  | Block-A | Active    | ...
...
```

### 错误处理输出示例

```
### 🏭 井信息概览：中塔-102 (ZT-102)
...

---

❌ 未找到井号: INVALID-WELL

---

### 🏭 井信息概览：中塔-105 (ZT-105)
...
```

## 故障排除

### 问题：数据库连接错误

**解决方法：**
1. 检查数据库配置
2. 确保已运行 `init_db.py` 初始化数据库

### 问题：HTTP服务器连接失败

**解决方法：**
1. 确保HTTP服务器正在运行
2. 检查端口 8000 是否被占用
3. 检查防火墙设置

### 问题：部分测试显示"无数据"

**解决方法：**
这是正常的，因为测试使用的日期范围可能超出数据库中的数据范围。只要其他测试通过即可。

## 性能测试

如需测试批量查询的性能，可以修改测试脚本中的井号数量：

```python
# 测试10口井的批量查询
result = get_well_summary(
    well_ids=[f"ZT-{100+i}" for i in range(10)],
    user_role=TEST_USER_ROLE,
    user_id=TEST_USER_ID,
    user_email=TEST_USER_EMAIL
)
```

## 测试结果记录

运行测试后，所有输出都会在终端显示。如需保存测试结果：

```bash
# 保存直接函数调用测试结果
python test_batch_queries.py > test_results_direct.log 2>&1

# 保存HTTP API测试结果
python test_http_batch_queries.py > test_results_http.log 2>&1
```

## 注意事项

1. **开发模式**：测试使用开发模式（DEV_MODE=true），跳过权限检查
2. **数据依赖**：某些测试依赖数据库中的特定数据
3. **缓存机制**：get_daily_report 使用缓存，相同查询会返回缓存结果
4. **并发测试**：HTTP API测试是顺序执行的，如需并发测试需要修改脚本

## 参考文档

- [批量查询功能说明.md](批量查询功能说明.md) - 详细的功能说明
- [oilfield_mcp_http_server.py](../oilfield_mcp_http_server.py) - 源代码
