# 验证LibreChat角色权限配置

## 配置说明

### 1. 当前架构
由于LibreChat的stdio类型MCP Server是在启动时加载，无法动态传递用户信息，我们采用了以下解决方案：

- **创建两个独立的MCP Server实例**
  - `oilfield-admin`: 硬编码为ADMIN角色
  - `oilfield-user`: 硬编码为USER角色

- **使用roleBasedAccess控制可见性**
  - ADMIN角色的用户只能看到并使用`oilfield-admin`
  - USER角色的用户只能看到并使用`oilfield-user`
  - GUEST角色的用户无法使用任何MCP Server

### 2. librechat.yaml配置

```yaml
# 基于角色的interface访问权限
roleBasedAccess:
  ADMIN:
    mcpServers:
      - oilfield-admin
  USER:
    mcpServers:
      - oilfield-user
  GUEST:
    mcpServers: []

mcpServers:
  oilfield-admin:
    env:
      LIBRECHAT_USER_ROLE: "ADMIN"
      # ... 其他配置
  
  oilfield-user:
    env:
      LIBRECHAT_USER_ROLE: "USER"
      # ... 其他配置
```

## 验证步骤

### 步骤1: 设置用户角色

使用脚本设置用户角色：

```bash
# 设置管理员
cd d:\work\librechat
node scripts/set-user-role.js 18202727050@163.com ADMIN

# 查看所有用户及角色
node scripts/list-users-with-roles.js
```

### 步骤2: 重启LibreChat

确保修改生效：

```bash
# 停止服务
docker-compose down

# 启动服务
docker-compose up -d
```

### 步骤3: 测试管理员用户

1. 使用`18202727050@163.com`登录（ADMIN角色）
2. 打开对话，查看可用的MCP Servers
3. 应该只能看到 **"油田钻井数据查询服务(管理员)"**
4. 测试调用工具：
   - ✅ 应该能访问所有15个工具
   - ✅ 包括管理员专用工具（如`export_all_data`）

### 步骤4: 测试普通用户

1. 创建或使用一个USER角色的用户登录
2. 打开对话，查看可用的MCP Servers
3. 应该只能看到 **"油田钻井数据查询服务(普通用户)"**
4. 测试调用工具：
   - ✅ 应该能访问8个基础工具
   - ❌ 不应该能看到管理员专用工具

## 测试用例

### 管理员测试（ADMIN角色）

| 工具名称 | 权限要求 | 预期结果 |
|---------|---------|---------|
| query_drilling_data | READ | ✅ 可访问 |
| query_by_well_number | READ | ✅ 可访问 |
| query_by_date_range | READ | ✅ 可访问 |
| get_statistics | READ | ✅ 可访问 |
| add_drilling_record | WRITE | ✅ 可访问 |
| update_drilling_record | WRITE | ✅ 可访问 |
| delete_drilling_record | DELETE | ✅ 可访问 |
| batch_delete_records | DELETE | ✅ 可访问 |
| export_all_data | ADMIN | ✅ 可访问 |
| reset_database | ADMIN | ✅ 可访问 |
| backup_database | ADMIN | ✅ 可访问 |
| get_system_info | ADMIN | ✅ 可访问 |

### 普通用户测试（USER角色）

| 工具名称 | 权限要求 | 预期结果 |
|---------|---------|---------|
| query_drilling_data | READ | ✅ 可访问 |
| query_by_well_number | READ | ✅ 可访问 |
| query_by_date_range | READ | ✅ 可访问 |
| get_statistics | READ | ✅ 可访问 |
| add_drilling_record | WRITE | ✅ 可访问 |
| update_drilling_record | WRITE | ✅ 可访问 |
| delete_drilling_record | DELETE | ❌ 不可访问 |
| batch_delete_records | DELETE | ❌ 不可访问 |
| export_all_data | ADMIN | ❌ 不可访问 |
| reset_database | ADMIN | ❌ 不可访问 |
| backup_database | ADMIN | ❌ 不可访问 |
| get_system_info | ADMIN | ❌ 不可访问 |

## 故障排除

### 问题1: 看不到预期的MCP Server

**检查项**：
1. 确认用户在数据库中的角色是否正确
   ```bash
   node scripts/list-users-with-roles.js
   ```

2. 检查librechat.yaml中的roleBasedAccess配置

3. 重启LibreChat服务
   ```bash
   docker-compose restart
   ```

### 问题2: 无法调用工具

**检查项**：
1. 查看MCP Server日志
   ```bash
   docker-compose logs -f api
   ```

2. 确认Python环境变量是否正确
   ```bash
   # 在MCP Server日志中应该看到类似输出：
   # LIBRECHAT_USER_ROLE = ADMIN
   # LIBRECHAT_USER_EMAIL = admin@oilfield.com
   ```

3. 测试权限逻辑
   ```bash
   cd d:\work\oilMCP
   python test_permissions_quick.py
   ```

### 问题3: LibreChat不支持roleBasedAccess

如果你的LibreChat版本不支持`roleBasedAccess`配置，有以下替代方案：

**方案A: 在MCP Server中禁用特定工具**

修改`oilfield_mcp_server_with_permissions.py`，根据角色隐藏工具：

```python
# 在list_tools方法中根据角色过滤
if user_role == UserRole.USER:
    # 不返回ADMIN级别的工具
    tools = [t for t in tools if not t.name.startswith('export_')]
```

**方案B: 创建不同的MCP Server脚本**

- `oilfield_mcp_admin.py`: 包含所有工具
- `oilfield_mcp_user.py`: 只包含READ/WRITE权限的工具

## 架构限制说明

### stdio类型的限制

当前配置的`stdio`类型MCP Server有以下限制：

1. **静态环境变量**: MCP Server在LibreChat启动时加载，环境变量在整个生命周期内固定
2. **无法动态传递用户信息**: `{{LIBRECHAT_USER_ROLE}}`等占位符不会被替换
3. **需要创建多个实例**: 必须为不同角色创建独立的MCP Server实例

### 更好的替代方案

如果需要真正的动态用户权限控制，建议：

1. **切换到HTTP/SSE传输类型**
   ```yaml
   mcpServers:
     oilfield:
       type: sse  # 或 http
       url: "http://localhost:8080/mcp"
       headers:
         Authorization: "Bearer {{LIBRECHAT_USER_TOKEN}}"
         X-User-Email: "{{LIBRECHAT_USER_EMAIL}}"
         X-User-Role: "{{LIBRECHAT_USER_ROLE}}"
   ```

2. **在HTTP Server中动态处理权限**
   - 每次请求时从headers中获取用户信息
   - 根据实际用户角色进行权限检查
   - 支持真正的per-request权限控制

## 总结

当前配置采用了"多实例"的解决方案：
- ✅ 优点: 简单、可靠、易于部署
- ❌ 缺点: 需要为每个角色创建独立实例，资源占用较高
- ⚠️ 注意: 用户角色在数据库中必须正确设置，且LibreChat需要支持roleBasedAccess配置

如果未来需要更灵活的权限控制，建议迁移到HTTP/SSE传输类型。
