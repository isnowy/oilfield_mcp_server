# 角色权限测试指南

## 📋 概述

本指南介绍如何使用自动化测试脚本验证不同角色的查询结果差异。

## 🚀 快速开始

### 方式 1: Python 自动化测试（推荐）

直接测试 MCP 服务器函数，无需启动 LibreChat。

#### Windows PowerShell
```powershell
# 方式 A: 使用批处理文件（双击即可）
.\run_role_test.bat

# 方式 B: 直接运行
$env:DEV_MODE="false"
python test_role_permissions.py
```

#### Linux/Mac
```bash
export DEV_MODE=false
python test_role_permissions.py
```

#### 测试内容

脚本会自动测试以下场景：

| 测试项 | 查询内容 | admin | engineer | viewer | default |
|--------|---------|-------|----------|--------|---------|
| 1 | 搜索 Block-A 的井 | ✅ | ✅ | ✅ | ❌ |
| 2 | 搜索 Block-B 的井 | ✅ | ❌ | ❌ | ❌ |
| 3 | 查询 ZT-102 井 | ✅ | ✅ | ✅ | ❌ |
| 4 | 查询 ZT-105 井 | ✅ | ✅ | ❌ | ❌ |
| 5 | 查询 XY-009 井 | ✅ | ❌ | ❌ | ❌ |
| 6 | ZT-102 日报 | ✅ | ✅ | ✅ | ❌ |
| 7 | 对比 ZT-102+ZT-105 | ✅ | ✅ | ❌ | ❌ |
| 8 | Block-A 区块报告 | ✅ | ✅ | ✅ | ❌ |
| 9 | Block-B 区块报告 | ✅ | ❌ | ❌ | ❌ |

#### 预期输出

```
================================================================================
  🧪 角色权限自动化测试
================================================================================

🔒 测试模式: 生产模式 (DEV_MODE=false)
👥 测试角色: admin, engineer, viewer, default

--------------------------------------------------------------------------------
📋 测试 1: 搜索 Block-A 的井
   engineer 和 viewer 应该能访问，default 应该被拒绝
--------------------------------------------------------------------------------
✅ admin         -> 成功                   (预期: success)
✅ engineer      -> 成功                   (预期: success)
✅ viewer        -> 成功                   (预期: success)
✅ default       -> 权限拒绝               (预期: deny)

...

================================================================================
  📊 测试总结
================================================================================
  总测试数: 36
  ✅ 通过: 36
  ❌ 失败: 0
  📈 通过率: 100.0%
================================================================================

🎉 所有测试通过！权限控制正常工作。
```

### 方式 2: LibreChat 集成测试

在真实的 LibreChat 环境中测试不同角色。

#### 步骤 1: 生成配置文件

```powershell
# 运行配置生成脚本
.\test_librechat_setup.ps1
```

脚本会自动生成：
- `librechat_test_roles.yaml` - LibreChat 配置文件
- `LIBRECHAT_TEST_GUIDE.txt` - 详细测试指南

#### 步骤 2: 复制配置到 LibreChat

```powershell
# 复制配置文件（修改为你的实际路径）
Copy-Item "librechat_test_roles.yaml" "C:\Projects\LibreChat\librechat.yaml"
```

#### 步骤 3: 重启 LibreChat

```bash
cd C:\Projects\LibreChat
npm run backend
```

#### 步骤 4: 在浏览器中测试

1. 打开 http://localhost:3080
2. 创建新对话
3. 选择不同的 MCP 服务进行测试

可用的服务：
- `oilfield-admin` - 管理员（全部权限）
- `oilfield-engineer` - 工程师（Block-A部分井）
- `oilfield-viewer` - 访客（ZT-102只读）
- `oilfield-default` - 默认（无权限）

#### 步骤 5: 执行测试查询

**测试 1: 查询 ZT-102 井**

```
查询 ZT-102 井的详细信息
```

预期结果：
- ✅ admin: 返回完整数据
- ✅ engineer: 返回完整数据
- ✅ viewer: 返回完整数据
- ❌ default: 权限拒绝

**测试 2: 查询 ZT-105 井**

```
查询 ZT-105 井的详细信息
```

预期结果：
- ✅ admin: 返回完整数据
- ✅ engineer: 返回完整数据
- ❌ viewer: 权限拒绝
- ❌ default: 权限拒绝

**测试 3: 查询 XY-009 井**

```
查询 XY-009 井的详细信息
```

预期结果：
- ✅ admin: 返回完整数据
- ❌ engineer: 权限拒绝
- ❌ viewer: 权限拒绝
- ❌ default: 权限拒绝

**测试 4: 搜索 Block-A**

```
搜索 Block-A 区块的所有油井
```

预期结果：
- ✅ admin: 返回所有井
- ✅ engineer: 返回所有井
- ✅ viewer: 返回所有井
- ❌ default: 返回空列表或拒绝

**测试 5: 搜索 Block-B**

```
搜索 Block-B 区块的所有油井
```

预期结果：
- ✅ admin: 返回所有井
- ❌ engineer: 返回空列表或拒绝
- ❌ viewer: 返回空列表或拒绝
- ❌ default: 返回空列表或拒绝

**测试 6: 对比两口井**

```
对比 ZT-102 和 ZT-105 的钻井速度
```

预期结果：
- ✅ admin: 返回对比数据
- ✅ engineer: 返回对比数据
- ❌ viewer: 权限拒绝（无ZT-105权限）
- ❌ default: 权限拒绝

## 📊 测试记录表格

建议使用以下表格记录测试结果：

| 查询内容 | admin | engineer | viewer | default | 备注 |
|---------|-------|----------|--------|---------|------|
| ZT-102 井详情 | | | | | |
| ZT-105 井详情 | | | | | |
| XY-009 井详情 | | | | | |
| Block-A 搜索 | | | | | |
| Block-B 搜索 | | | | | |
| ZT-102 日报 | | | | | |
| 对比 ZT-102+ZT-105 | | | | | |
| Block-A 周报 | | | | | |
| Block-B 周报 | | | | | |

填写说明：
- ✅ = 成功返回数据
- ❌ = 权限拒绝或返回空
- ⚠️ = 部分数据或异常

## 🔍 验证权限控制逻辑

### 使用权限测试脚本

```powershell
# 测试生产模式
$env:DEV_MODE="false"
python test_permissions.py

# 测试开发模式
$env:DEV_MODE="true"
python test_permissions.py
```

### 预期输出（生产模式）

```
========================================================================
  🧪 权限模式测试
========================================================================

🔒 当前模式：生产模式 (严格权限控制)

📊 权限测试结果：
------------------------------------------------------------------------
角色          访问井        访问区块      井权限      区块权限
------------------------------------------------------------------------
admin        ZT-102       Block-A      ✅ 允许    ✅ 允许
engineer     ZT-102       Block-A      ✅ 允许    ✅ 允许
engineer     XY-009       Block-B      ❌ 拒绝    ❌ 拒绝
viewer       ZT-102       Block-A      ✅ 允许    ✅ 允许
viewer       ZT-105       Block-A      ❌ 拒绝    ✅ 允许
default      ZT-102       Block-A      ❌ 拒绝    ❌ 拒绝
------------------------------------------------------------------------
```

## 🎯 故障排查

### 问题 1: 所有角色都能访问所有数据

**原因**: DEV_MODE 未设置为 false

**解决**:
```powershell
$env:DEV_MODE="false"
python test_role_permissions.py
```

或在 `librechat.yaml` 中设置：
```yaml
env:
  DEV_MODE: "false"
```

### 问题 2: 测试脚本报错

**原因**: 可能缺少依赖或数据库未初始化

**解决**:
```powershell
# 重新安装依赖
pip install -r requirements.txt

# 运行基础测试
python test_server.py
```

### 问题 3: LibreChat 中看不到 MCP 服务

**原因**: 配置文件路径错误或格式错误

**解决**:
1. 检查配置文件路径是否正确
2. 验证 YAML 格式（使用在线 YAML 验证器）
3. 查看 LibreChat 日志
4. 完全重启 LibreChat

### 问题 4: 权限判断不符合预期

**原因**: 权限配置可能被修改

**解决**:
检查 `oilfield_mcp_server.py` 中的 `USER_PERMISSIONS` 配置：

```python
USER_PERMISSIONS = {
    "admin": {"wells": "*", "blocks": "*", "role": "admin"},
    "engineer": {"wells": ["ZT-102", "ZT-105"], "blocks": ["Block-A"], "role": "engineer"},
    "viewer": {"wells": ["ZT-102"], "blocks": ["Block-A"], "role": "viewer"},
    "default": {"wells": [], "blocks": [], "role": "guest"}
}
```

## 📝 最佳实践

### 测试前检查清单

- [ ] 确认 `DEV_MODE=false`（生产模式）
- [ ] 确认数据库有测试数据
- [ ] 确认所有依赖已安装
- [ ] 备份现有配置文件

### 测试顺序建议

1. **先运行 Python 测试**
   - 快速验证权限逻辑
   - 无需启动 LibreChat
   - 自动化测试所有场景

2. **再运行 LibreChat 测试**
   - 验证真实环境
   - 测试用户体验
   - 检查错误提示

3. **记录测试结果**
   - 使用测试记录表格
   - 截图保存关键结果
   - 记录异常情况

### 定期测试

建议在以下情况下运行测试：

- ✅ 修改权限配置后
- ✅ 添加新角色后
- ✅ 修改数据库结构后
- ✅ 部署到新环境前
- ✅ 版本发布前

## 🔗 相关文档

- [README_PERMISSIONS.md](README_PERMISSIONS.md) - 权限控制使用指南
- [PERMISSION_CONFIG.md](PERMISSION_CONFIG.md) - 详细权限配置说明
- [部署启动指南.md](部署启动指南.md) - 完整部署指南

## 📞 获取帮助

如果测试遇到问题：

1. 查看自动生成的 `LIBRECHAT_TEST_GUIDE.txt`
2. 运行基础测试验证环境：`python test_server.py`
3. 检查 MCP 服务器日志
4. 查看 LibreChat 后台日志

---

**最后更新**: 2026-01-27
