# å®æ–½æ–¹æ¡ˆæ€»ç»“ - æ•°æ®åº“MCP Server + ACLæƒé™ç³»ç»Ÿ

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

ä½¿ç”¨LibreChatçš„**æ•°æ®åº“MCP ServeråŠŸèƒ½**é…åˆ**ACLæƒé™ç³»ç»Ÿ**ï¼Œå®ç°åŸºäºç”¨æˆ·è§’è‰²çš„MCPå·¥å…·è®¿é—®æ§åˆ¶ã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ–¹æ¡ˆ

| ç‰¹æ€§ | yamlé…ç½® | æ•°æ®åº“+ACLé…ç½®ï¼ˆâœ…æ¨èï¼‰ |
|-----|---------|----------------------|
| è®¿é—®æ§åˆ¶ | âŒ å…¨å±€å¯è§ | âœ… åŸºäºACL |
| è§’è‰²éš”ç¦» | âŒ æ— æ³•å®ç° | âœ… å®Œç¾éš”ç¦» |
| åŠ¨æ€ç®¡ç† | âŒ éœ€é‡å¯ | âœ… æ— éœ€é‡å¯ |
| æƒé™ç²’åº¦ | âŒ æ—  | âœ… ç”¨æˆ·/ç»„/è§’è‰² |
| ç”Ÿäº§å°±ç»ª | âŒ å¦ | âœ… æ˜¯ |

## ğŸ“ å·²åˆ›å»ºçš„æ–‡ä»¶

### æ–‡æ¡£æ–‡ä»¶

1. **[LibreChat_MCPæƒé™é…ç½®æœ€ç»ˆæ–¹æ¡ˆ.md](d:\work\oilMCP\LibreChat_MCPæƒé™é…ç½®æœ€ç»ˆæ–¹æ¡ˆ.md)**
   - å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”
   - 3ç§æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹åˆ†æ
   - å¸¸è§é—®é¢˜è§£ç­”

2. **[UIé…ç½®MCPæƒé™æ“ä½œæŒ‡å—.md](d:\work\oilMCP\UIé…ç½®MCPæƒé™æ“ä½œæŒ‡å—.md)**
   - è¯¦ç»†çš„UIæ“ä½œæ­¥éª¤ï¼ˆå¦‚æœLibreChatæ”¯æŒï¼‰
   - APIæ–¹å¼åˆ›å»ºçš„å¤‡é€‰æ–¹æ³•
   - å®Œæ•´çš„æ•…éšœæ’é™¤æŒ‡å—

3. **[å¿«é€Ÿå¼€å§‹-ACLæ–¹æ¡ˆ.md](d:\work\oilMCP\å¿«é€Ÿå¼€å§‹-ACLæ–¹æ¡ˆ.md)**
   - 5åˆ†é’Ÿå¿«é€Ÿå®æ–½æµç¨‹
   - ä¸€é”®æ‰§è¡Œå‘½ä»¤åºåˆ—
   - å¸¸è§é—®é¢˜å¿«é€Ÿè§£ç­”

4. **[é—®é¢˜æ ¹æºå’Œè§£å†³æ–¹æ¡ˆ.md](d:\work\oilMCP\é—®é¢˜æ ¹æºå’Œè§£å†³æ–¹æ¡ˆ.md)**
   - stdioç±»å‹é™åˆ¶çš„æ ¹æœ¬åŸå› 
   - ä¸ºä»€ä¹ˆå ä½ç¬¦ä¸è¢«æ›¿æ¢
   - æ–¹æ¡ˆé€‰æ‹©æŒ‡å—

### è„šæœ¬æ–‡ä»¶

5. **[scripts/create-mcp-admin.js](d:\work\librechat\scripts\create-mcp-admin.js)**
   - é€šè¿‡APIåˆ›å»ºç®¡ç†å‘˜ç‰ˆMCP Server
   - ç¡¬ç¼–ç  `LIBRECHAT_USER_ROLE: "ADMIN"`
   - äº¤äº’å¼è¾“å…¥JWT token

6. **[scripts/create-mcp-user.js](d:\work\librechat\scripts\create-mcp-user.js)**
   - é€šè¿‡APIåˆ›å»ºç”¨æˆ·ç‰ˆMCP Server
   - ç¡¬ç¼–ç  `LIBRECHAT_USER_ROLE: "USER"`
   - äº¤äº’å¼è¾“å…¥JWT token

7. **[scripts/configure-mcp-acl.js](d:\work\librechat\scripts\configure-mcp-acl.js)**
   - é…ç½®MCP Serverçš„ACLæƒé™
   - ä¸ºæŒ‡å®šè§’è‰²çš„æ‰€æœ‰ç”¨æˆ·æˆæƒ
   - è‡ªåŠ¨æ£€æµ‹å·²æœ‰æƒé™ï¼Œé¿å…é‡å¤

### æ ¸å¿ƒå®ç°æ–‡ä»¶ï¼ˆå·²æœ‰ï¼‰

8. **[permissions.py](d:\work\oilMCP\permissions.py)**
   - æƒé™æ£€æŸ¥æ ¸å¿ƒæ¨¡å—
   - UserRole, Permissionæšä¸¾
   - PermissionCheckerç±»

9. **[oilfield_mcp_server_with_permissions.py](d:\work\oilMCP\oilfield_mcp_server_with_permissions.py)**
   - MCP Serverä¸»ç¨‹åº
   - 15ä¸ªå·¥å…·å®ç°
   - æƒé™éªŒè¯é›†æˆ

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1: å‡†å¤‡é…ç½®

ç¼–è¾‘ `librechat.yaml`:

```yaml
interface:
  mcpServers:
    use: true
    create: true  # â­ é‡è¦
    share: false
    public: false

# æ³¨é‡Šæ‰å…¨å±€MCPé…ç½®
# mcpServers:
#   oilfield-admin: ...
#   oilfield-user: ...
```

é‡å¯LibreChatï¼š

```bash
cd d:\work\librechat
docker-compose restart
```

### æ­¥éª¤2: åˆ›å»ºMCP Servers

#### è·å–JWT Token

1. ç™»å½•LibreChatï¼ˆç®¡ç†å‘˜è´¦å·ï¼‰
2. F12 â†’ Networkæ ‡ç­¾
3. åˆ·æ–°é¡µé¢
4. æ‰¾åˆ° `/api/user` è¯·æ±‚
5. å¤åˆ¶ `Authorization` headerä¸­ `Bearer ` åçš„token

#### åˆ›å»ºæœåŠ¡å™¨

```bash
cd d:\work\librechat

# åˆ›å»ºç®¡ç†å‘˜ç‰ˆ
node scripts\create-mcp-admin.js
# ç²˜è´´tokenï¼Œè®°å½•è¿”å›çš„Server Nameï¼ˆå¦‚ï¼šmcp_abc123xyzï¼‰

# åˆ›å»ºç”¨æˆ·ç‰ˆ
node scripts\create-mcp-user.js
# ç²˜è´´tokenï¼Œè®°å½•è¿”å›çš„Server Nameï¼ˆå¦‚ï¼šmcp_def456uvwï¼‰
```

### æ­¥éª¤3: é…ç½®ACLæƒé™

```bash
# ä¸ºADMINè§’è‰²é…ç½®
node scripts\configure-mcp-acl.js mcp_abc123xyz ADMIN

# ä¸ºUSERè§’è‰²é…ç½®
node scripts\configure-mcp-acl.js mcp_def456uvw USER
```

### æ­¥éª¤4: éªŒè¯

#### ç®¡ç†å‘˜éªŒè¯

1. ä½¿ç”¨ADMINè´¦å·ç™»å½•
2. Settings â†’ MCP Servers
3. åº”è¯¥åªçœ‹åˆ°ï¼š"æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(ç®¡ç†å‘˜)"
4. åˆ›å»ºå¯¹è¯ï¼Œæµ‹è¯•æ‰€æœ‰15ä¸ªå·¥å…·

#### ç”¨æˆ·éªŒè¯

1. ä½¿ç”¨USERè´¦å·ç™»å½•
2. Settings â†’ MCP Servers
3. åº”è¯¥åªçœ‹åˆ°ï¼š"æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(æ™®é€šç”¨æˆ·)"
4. åˆ›å»ºå¯¹è¯ï¼Œæµ‹è¯•8ä¸ªåŸºç¡€å·¥å…·
5. ç¡®è®¤æ— æ³•è®¿é—®ç®¡ç†å‘˜å·¥å…·

## ğŸ“Š æƒé™å¯¹ç…§è¡¨

### ç®¡ç†å‘˜ï¼ˆADMINï¼‰ - 15ä¸ªå·¥å…·

| å·¥å…· | æƒé™è¦æ±‚ | è¯´æ˜ |
|-----|---------|------|
| query_drilling_data | READ | âœ… æŸ¥è¯¢é’»äº•æ•°æ® |
| query_by_well_number | READ | âœ… æŒ‰äº•å·æŸ¥è¯¢ |
| query_by_date_range | READ | âœ… æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢ |
| get_statistics | READ | âœ… è·å–ç»Ÿè®¡ä¿¡æ¯ |
| add_drilling_record | WRITE | âœ… æ·»åŠ é’»äº•è®°å½• |
| update_drilling_record | WRITE | âœ… æ›´æ–°é’»äº•è®°å½• |
| delete_drilling_record | DELETE | âœ… åˆ é™¤å•æ¡è®°å½• |
| batch_delete_records | DELETE | âœ… æ‰¹é‡åˆ é™¤è®°å½• |
| export_all_data | ADMIN | âœ… å¯¼å‡ºæ‰€æœ‰æ•°æ® |
| reset_database | ADMIN | âœ… é‡ç½®æ•°æ®åº“ |
| backup_database | ADMIN | âœ… å¤‡ä»½æ•°æ®åº“ |
| get_system_info | ADMIN | âœ… è·å–ç³»ç»Ÿä¿¡æ¯ |
| query_well_info | READ | âœ… æŸ¥è¯¢äº•ä¿¡æ¯ |
| get_performance_metrics | READ | âœ… æ€§èƒ½æŒ‡æ ‡ |
| analyze_drilling_efficiency | WRITE | âœ… æ•ˆç‡åˆ†æ |

### ç”¨æˆ·ï¼ˆUSERï¼‰ - 8ä¸ªå·¥å…·

| å·¥å…· | æƒé™è¦æ±‚ | è¯´æ˜ |
|-----|---------|------|
| query_drilling_data | READ | âœ… æŸ¥è¯¢é’»äº•æ•°æ® |
| query_by_well_number | READ | âœ… æŒ‰äº•å·æŸ¥è¯¢ |
| query_by_date_range | READ | âœ… æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢ |
| get_statistics | READ | âœ… è·å–ç»Ÿè®¡ä¿¡æ¯ |
| add_drilling_record | WRITE | âœ… æ·»åŠ é’»äº•è®°å½• |
| update_drilling_record | WRITE | âœ… æ›´æ–°é’»äº•è®°å½• |
| query_well_info | READ | âœ… æŸ¥è¯¢äº•ä¿¡æ¯ |
| get_performance_metrics | READ | âœ… æ€§èƒ½æŒ‡æ ‡ |

**è¢«æ‹’ç»çš„å·¥å…·ï¼ˆ7ä¸ªï¼‰**ï¼š
- âŒ delete_drilling_record
- âŒ batch_delete_records
- âŒ export_all_data
- âŒ reset_database
- âŒ backup_database
- âŒ get_system_info
- âŒ analyze_drilling_efficiency

## ğŸ”§ å¸¸è§ä»»åŠ¡

### æ·»åŠ æ–°ç”¨æˆ·

```bash
# 1. åˆ›å»ºç”¨æˆ·
node scripts\create-user.js

# 2. è®¾ç½®è§’è‰²
node scripts\set-user-role.js newuser@example.com USER

# 3. æ— éœ€é¢å¤–é…ç½®ï¼ŒACLå·²è‡ªåŠ¨æˆæƒ
```

### æŸ¥çœ‹ç”¨æˆ·åŠè§’è‰²

```bash
node scripts\list-users-with-roles.js
```

### æ›´æ”¹ç”¨æˆ·è§’è‰²

```bash
# å°†ç”¨æˆ·ä»USERæå‡ä¸ºADMIN
node scripts\set-user-role.js user@example.com ADMIN

# éœ€è¦é‡æ–°é…ç½®ACLï¼ˆç§»é™¤æ—§æƒé™ï¼Œæ·»åŠ æ–°æƒé™ï¼‰
```

### æ’¤é”€MCP Serverè®¿é—®æƒé™

```bash
# è¿›å…¥MongoDB
docker-compose exec mongodb mongosh librechat

# åˆ é™¤æƒé™
db.permissions.deleteOne({
  principalId: ObjectId('ç”¨æˆ·ID'),
  resourceId: ObjectId('MCP Server ID'),
  resourceType: 'mcpServer'
})
```

### æŸ¥çœ‹å½“å‰é…ç½®çš„æƒé™

```bash
# è¿›å…¥MongoDB
docker-compose exec mongodb mongosh librechat

# æŸ¥çœ‹æ‰€æœ‰MCPæƒé™
db.permissions.find({ resourceType: 'mcpServer' }).pretty()

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æƒé™
db.permissions.find({
  principalType: 'user',
  principalId: ObjectId('ç”¨æˆ·ID')
}).pretty()
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Tokenå®‰å…¨

- JWT tokenæœ‰æœ‰æ•ˆæœŸï¼ˆé€šå¸¸24å°æ—¶ï¼‰
- ä¸è¦å°†tokenä¿å­˜åœ¨æ–‡ä»¶ä¸­
- ä½¿ç”¨åç«‹å³åˆ é™¤å‘½ä»¤å†å²

### 2. æƒé™ç²’åº¦

å½“å‰é…ç½®ä¸º"å…¨æœ‰æˆ–å…¨æ— "æ¨¡å¼ï¼š
- ADMINç”¨æˆ·ï¼šæ‰€æœ‰15ä¸ªå·¥å…·
- USERç”¨æˆ·ï¼š8ä¸ªåŸºç¡€å·¥å…·

å¦‚éœ€æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œè€ƒè™‘ï¼š
- åˆ›å»ºæ›´å¤šè§’è‰²ï¼ˆå¦‚OPERATOR, ANALYSTï¼‰
- ä¸ºæ¯ä¸ªè§’è‰²åˆ›å»ºä¸“ç”¨MCP Server
- é…ç½®å¯¹åº”çš„ç¯å¢ƒå˜é‡å’Œæƒé™

### 3. æ€§èƒ½è€ƒè™‘

æ¯ä¸ªMCP Serveræ˜¯ç‹¬ç«‹è¿›ç¨‹ï¼š
- ç®¡ç†å‘˜ç‰ˆï¼šå•ç‹¬è¿›ç¨‹
- ç”¨æˆ·ç‰ˆï¼šå•ç‹¬è¿›ç¨‹

èµ„æºå ç”¨ï¼š
- æ¯ä¸ªè¿›ç¨‹çº¦50-100MBå†…å­˜
- å¯åŠ¨æ—¶é—´çº¦2-5ç§’

### 4. æ•°æ®åº“ä¸€è‡´æ€§

ä¸¤ä¸ªMCP Serverå…±äº«åŒä¸€æ•°æ®åº“ï¼š

```python
env:
  DATABASE_URL: "sqlite:///d:/work/oilMCP/oilfield.db"
```

ç¡®ä¿ï¼š
- æ•°æ®åº“æ–‡ä»¶æƒé™æ­£ç¡®
- æ”¯æŒå¹¶å‘è®¿é—®
- å®šæœŸå¤‡ä»½æ•°æ®

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ï¼šåˆ›å»ºMCP Serverå¤±è´¥ï¼ˆ401ï¼‰

```bash
# Tokenè¿‡æœŸï¼Œé‡æ–°è·å–
# 1. ç™»å½•LibreChat
# 2. F12 â†’ Network â†’ å¤åˆ¶æ–°token
# 3. é‡æ–°è¿è¡Œåˆ›å»ºè„šæœ¬
```

### é—®é¢˜ï¼šåˆ›å»ºæˆåŠŸä½†ç”¨æˆ·çœ‹ä¸åˆ°

```bash
# 1. æ£€æŸ¥ACLæ˜¯å¦é…ç½®
node scripts\configure-mcp-acl.js <server-name> <role>

# 2. ç¡®è®¤ç”¨æˆ·è§’è‰²
node scripts\list-users-with-roles.js

# 3. æ¸…é™¤ç¼“å­˜
node scripts\flush-cache.js
docker-compose restart
```

### é—®é¢˜ï¼šMCP Serveræ— æ³•å¯åŠ¨

```bash
# 1. æµ‹è¯•Pythonç¯å¢ƒ
cd d:\work\oilMCP
python -c "import mcp; print('OK')"

# 2. æµ‹è¯•è„šæœ¬
python oilfield_mcp_server_with_permissions.py

# 3. æŸ¥çœ‹æ—¥å¿—
cd d:\work\librechat
docker-compose logs api | grep -i mcp
```

### é—®é¢˜ï¼šæƒé™æ£€æŸ¥å¤±è´¥

```bash
# æ£€æŸ¥æƒé™ç³»ç»Ÿ
cd d:\work\oilMCP
python test_permissions_quick.py

# åº”è¯¥çœ‹åˆ°ï¼š
# ADMIN: 15/15 tools (100.0%)
# USER: 8/15 tools (53.3%)
# GUEST: 4/15 tools (26.7%)
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ**: [LibreChat_MCPæƒé™é…ç½®æœ€ç»ˆæ–¹æ¡ˆ.md](LibreChat_MCPæƒé™é…ç½®æœ€ç»ˆæ–¹æ¡ˆ.md)
- **è¯¦ç»†æ“ä½œæŒ‡å—**: [UIé…ç½®MCPæƒé™æ“ä½œæŒ‡å—.md](UIé…ç½®MCPæƒé™æ“ä½œæŒ‡å—.md)
- **å¿«é€Ÿå¼€å§‹**: [å¿«é€Ÿå¼€å§‹-ACLæ–¹æ¡ˆ.md](å¿«é€Ÿå¼€å§‹-ACLæ–¹æ¡ˆ.md)
- **é—®é¢˜åˆ†æ**: [é—®é¢˜æ ¹æºå’Œè§£å†³æ–¹æ¡ˆ.md](é—®é¢˜æ ¹æºå’Œè§£å†³æ–¹æ¡ˆ.md)

## âœ… æˆåŠŸæ ‡å¿—

å®æ–½æˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

1. **ç®¡ç†å‘˜ç™»å½•**
   - Settings â†’ MCP Serversæ˜¾ç¤º1ä¸ªæœåŠ¡å™¨
   - åç§°ï¼šæ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(ç®¡ç†å‘˜)
   - å¯ä½¿ç”¨æ‰€æœ‰15ä¸ªå·¥å…·

2. **æ™®é€šç”¨æˆ·ç™»å½•**
   - Settings â†’ MCP Serversæ˜¾ç¤º1ä¸ªæœåŠ¡å™¨
   - åç§°ï¼šæ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(æ™®é€šç”¨æˆ·)
   - å¯ä½¿ç”¨8ä¸ªåŸºç¡€å·¥å…·
   - è°ƒç”¨ç®¡ç†å‘˜å·¥å…·è¿”å›æƒé™ä¸è¶³

3. **æ•°æ®åº“è®°å½•**
   - `mcpservers` é›†åˆæœ‰2æ¡è®°å½•
   - `permissions` é›†åˆæœ‰Næ¡è®°å½•ï¼ˆN=ç”¨æˆ·æ•°ï¼‰

4. **yamlé…ç½®**
   - æ²¡æœ‰å…¨å±€çš„ `mcpServers` é…ç½®
   - æˆ–è€…å·²è¢«æ³¨é‡Šæ‰

## ğŸ‰ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰äº†ï¼š

âœ… **ç”Ÿäº§çº§æƒé™ç³»ç»Ÿ** - åŸºäºLibreChatåŸç”ŸACL
âœ… **å®Œæ•´çš„è§’è‰²éš”ç¦»** - ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒå·¥å…·
âœ… **çµæ´»çš„æƒé™ç®¡ç†** - å¯é€šè¿‡è„šæœ¬æ‰¹é‡æ“ä½œ
âœ… **è¯¦ç»†çš„æ–‡æ¡£** - æ¶µç›–æ‰€æœ‰åœºæ™¯å’Œé—®é¢˜
âœ… **å¯ç»´æŠ¤çš„æ¶æ„** - æ¸…æ™°çš„å®æ–½æ­¥éª¤å’Œæ•…éšœæ’é™¤

è¿™æ˜¯ä½¿ç”¨stdioç±»å‹MCP Serverçš„**æœ€ä½³å®è·µ**ï¼
