# ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹ - MCP Serveræƒé™é…ç½®

## ç›®æ ‡

ä¸ºä½ çš„LibreChatç³»ç»Ÿçš„MCP Serveræ·»åŠ è§’è‰²æƒé™æ§åˆ¶,å®ç°ä¸åŒç”¨æˆ·æœ‰ä¸åŒçš„å·¥å…·è®¿é—®æƒé™ã€‚

---

## å‰ææ¡ä»¶

- âœ… LibreChatå·²å®‰è£…å¹¶è¿è¡Œ
- âœ… å·²æœ‰åŸºç¡€çš„MCP Serveré…ç½®
- âœ… Python 3.8+ç¯å¢ƒ

---

## å¿«é€Ÿé…ç½®(5æ­¥å®Œæˆ)

### ç¬¬1æ­¥: ä¿®æ”¹ librechat.yaml (2åˆ†é’Ÿ)

ç¼–è¾‘ `d:\work\librechat\librechat.yaml`,æ‰¾åˆ°ä½ çš„MCP Serveré…ç½®,æ·»åŠ ç”¨æˆ·ä¸Šä¸‹æ–‡å˜é‡:

```yaml
mcpServers:
  oilfield-data:
    command: python
    args:
      - "d:/work/oilMCP/oilfield_mcp_server_with_permissions.py"
    env:
      DATABASE_URL: "sqlite:///d:/work/oilMCP/oilfield.db"
      
      # â­ å…³é”®: æ·»åŠ è¿™äº›ç”¨æˆ·ä¸Šä¸‹æ–‡å˜é‡
      LIBRECHAT_USER_ID: "{{LIBRECHAT_USER_ID}}"
      LIBRECHAT_USER_EMAIL: "{{LIBRECHAT_USER_EMAIL}}"
      LIBRECHAT_USER_ROLE: "{{LIBRECHAT_USER_ROLE}}"
      LIBRECHAT_USER_USERNAME: "{{LIBRECHAT_USER_USERNAME}}"
      
      # â­ å…³é”®: å¯ç”¨æƒé™æ£€æŸ¥
      DEV_MODE: "false"
    
    description: "æ²¹ç”°é’»äº•æ•°æ®æŸ¥è¯¢æœåŠ¡"
```

### ç¬¬2æ­¥: å¤åˆ¶æƒé™æ¨¡å—æ–‡ä»¶ (1åˆ†é’Ÿ)

æ–‡ä»¶å·²ç»åˆ›å»ºåœ¨ `d:\work\oilMCP\` ç›®å½•:

- âœ… `permissions.py` - æƒé™æ£€æŸ¥æ¨¡å—
- âœ… `oilfield_mcp_server_with_permissions.py` - å¸¦æƒé™çš„MCP Serverç¤ºä¾‹

### ç¬¬3æ­¥: æµ‹è¯•æƒé™é…ç½® (1åˆ†é’Ÿ)

```bash
cd d:\work\oilMCP

# è¿è¡Œå¿«é€Ÿæµ‹è¯•
python test_permissions_quick.py all
```

**é¢„æœŸè¾“å‡º:**
```
ğŸš€ MCP Server æƒé™ç³»ç»Ÿå…¨é¢æµ‹è¯•
==================================================

ğŸ§ª æµ‹è¯•è§’è‰²: ADMIN
âœ… å…è®¸ä½¿ç”¨: 15/15 ä¸ªå·¥å…· (100%)

ğŸ§ª æµ‹è¯•è§’è‰²: USER  
âœ… å…è®¸ä½¿ç”¨: 8/15 ä¸ªå·¥å…· (53.3%)

ğŸ§ª æµ‹è¯•è§’è‰²: GUEST
âœ… å…è®¸ä½¿ç”¨: 4/15 ä¸ªå·¥å…· (26.7%)
```

### ç¬¬4æ­¥: é‡å¯LibreChat (1åˆ†é’Ÿ)

```bash
cd d:\work\librechat

# Dockeræ–¹å¼
docker-compose restart

# æˆ–å¼€å‘æ¨¡å¼
# Ctrl+Cåœæ­¢,ç„¶åé‡æ–°è¿è¡Œ
npm run backend:dev
```

### ç¬¬5æ­¥: éªŒè¯æ•ˆæœ (ç«‹å³)

1. ä»¥ä¸åŒè§’è‰²ç™»å½•LibreChat
2. å°è¯•è°ƒç”¨MCPå·¥å…·
3. è§‚å¯Ÿæƒé™æ§åˆ¶æ•ˆæœ

**ADMINç”¨æˆ·:** æ‰€æœ‰å·¥å…·éƒ½å¯ç”¨  
**USERç”¨æˆ·:** åªèƒ½æŸ¥è¯¢å’Œå†™å…¥,ä¸èƒ½åˆ é™¤  
**å…¶ä»–ç”¨æˆ·:** åªèƒ½æŸ¥è¯¢

---

## æƒé™æ•ˆæœæ¼”ç¤º

### åœºæ™¯1: ADMINç®¡ç†å‘˜

```
ç”¨æˆ·(ADMIN): å¸®æˆ‘åˆ é™¤è®°å½•ID 12345
åŠ©æ‰‹: âœ… è®°å½•åˆ é™¤æˆåŠŸ
```

### åœºæ™¯2: USERæ™®é€šç”¨æˆ·

```
ç”¨æˆ·(USER): å¸®æˆ‘åˆ é™¤è®°å½•ID 12345
åŠ©æ‰‹: âŒ æƒé™è¢«æ‹’ç»
      æƒé™ä¸è¶³: ç”¨æˆ·è§’è‰² 'USER' ç¼ºå°‘ä»¥ä¸‹æƒé™: delete
```

---

## è‡ªå®šä¹‰é…ç½®(å¯é€‰)

### ä¿®æ”¹æƒé™æ˜ å°„

ç¼–è¾‘ `d:\work\oilMCP\permissions.py`:

```python
# ä¿®æ”¹è§’è‰²æƒé™
ROLE_PERMISSIONS = {
    UserRole.ADMIN: [Permission.READ, Permission.WRITE, 
                     Permission.DELETE, Permission.ADMIN],
    UserRole.USER: [Permission.READ, Permission.WRITE],  # å…è®¸è¯»å†™
    UserRole.GUEST: [Permission.READ],  # åªè¯»
}

# ä¿®æ”¹å·¥å…·æƒé™è¦æ±‚
TOOL_PERMISSIONS = {
    "query_drilling_data": [Permission.READ],     # åªéœ€è¯»æƒé™
    "add_drilling_record": [Permission.WRITE],    # éœ€è¦å†™æƒé™
    "delete_drilling_record": [Permission.DELETE], # éœ€è¦åˆ é™¤æƒé™
    "export_all_data": [Permission.ADMIN],        # éœ€è¦ç®¡ç†å‘˜æƒé™
}
```

---

## å¸¸ç”¨å‘½ä»¤

### æµ‹è¯•æƒé™

```bash
# æµ‹è¯•æ‰€æœ‰è§’è‰²
python test_permissions_quick.py all

# å¯¹æ¯”æƒé™å·®å¼‚
python test_permissions_quick.py compare

# æµ‹è¯•å•ä¸ªè§’è‰²
python test_permissions_quick.py admin
python test_permissions_quick.py user
```

### æŸ¥çœ‹æ—¥å¿—

MCP Serverå¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºæƒé™é…ç½®:

```
ğŸš€ Starting Oilfield MCP Server with Permission Control
ğŸ“Š Permission Summary:
   User: user@example.com
   Role: USER
   Permissions: read, write
   Allowed Tools: 8/15
   Dev Mode: False
âœ… Production mode - permission checks enabled
```

---

## å¼€å‘æ¨¡å¼ vs ç”Ÿäº§æ¨¡å¼

### å¼€å‘æ¨¡å¼(è·³è¿‡æƒé™æ£€æŸ¥)

```yaml
env:
  DEV_MODE: "true"  # æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½è®¿é—®æ‰€æœ‰å·¥å…·
```

### ç”Ÿäº§æ¨¡å¼(å¯ç”¨æƒé™æ£€æŸ¥)

```yaml
env:
  DEV_MODE: "false"  # æ ¹æ®è§’è‰²é™åˆ¶å·¥å…·è®¿é—®
```

âš ï¸ **é‡è¦:** ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ç½® `DEV_MODE: "false"`

---

## æ•…éšœæ’é™¤

### é—®é¢˜1: æƒé™æ£€æŸ¥ä¸ç”Ÿæ•ˆ

**æ£€æŸ¥:**
```bash
# æŸ¥çœ‹MCP Serverå¯åŠ¨æ—¥å¿—
# åº”è¯¥æ˜¾ç¤º: âœ… Production mode - permission checks enabled
# è€Œä¸æ˜¯: âš ï¸ DEV_MODE is enabled
```

**è§£å†³:**
```yaml
# ç¡®ä¿librechat.yamlä¸­
env:
  DEV_MODE: "false"  # æ³¨æ„æ˜¯å­—ç¬¦ä¸² "false"
```

### é—®é¢˜2: ç”¨æˆ·ä¿¡æ¯æœªä¼ é€’

**æ£€æŸ¥:**
```python
# åœ¨MCP Serverä¸­æ·»åŠ è°ƒè¯•è¾“å‡º
user_context = permission_checker.get_user_context()
print(f"User context: {user_context}")
```

**è§£å†³:**
ç¡®ä¿ `librechat.yaml` ä¸­æ­£ç¡®é…ç½®äº†ç”¨æˆ·ä¸Šä¸‹æ–‡å˜é‡:
```yaml
LIBRECHAT_USER_ROLE: "{{LIBRECHAT_USER_ROLE}}"
```

---

## ä¸‹ä¸€æ­¥

âœ… **å®ŒæˆåŸºç¡€é…ç½®** - ä½ å·²ç»å®Œæˆ!  
ğŸ“– **æ·±å…¥äº†è§£** - é˜…è¯» [å®Œæ•´é…ç½®æŒ‡å—](./README_æƒé™é…ç½®å®Œæ•´æ–¹æ¡ˆ.md)  
ğŸ”§ **è‡ªå®šä¹‰æƒé™** - æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´æƒé™æ˜ å°„  
ğŸ“Š **æ·»åŠ å®¡è®¡** - å®ç°è¯¦ç»†çš„æ“ä½œæ—¥å¿—è®°å½•

---

## è·å–å¸®åŠ©

- ğŸ“– æŸ¥çœ‹ [è¯¦ç»†æ–‡æ¡£](./docs/MCPæƒé™é…ç½®æŒ‡å—.md)
- ğŸ” æŸ¥çœ‹ [å®Œæ•´æ–¹æ¡ˆ](./README_æƒé™é…ç½®å®Œæ•´æ–¹æ¡ˆ.md)
- ğŸ’¬ æŸ¥çœ‹æºç æ³¨é‡Š

---

**æ­å–œ!** ğŸ‰ ä½ çš„LibreChat MCP Serverç°åœ¨å·²ç»å…·å¤‡å®Œæ•´çš„è§’è‰²æƒé™æ§åˆ¶!
