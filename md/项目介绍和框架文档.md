# 油田钻井数据查询 MCP Server - 项目介绍和框架文档

## 📋 目录

1. [项目概述](#项目概述)
2. [核心功能](#核心功能)
3. [技术架构](#技术架构)
4. [数据模型](#数据模型)
5. [工具列表](#工具列表)
6. [System Prompt 配置](#system-prompt配置)
7. [文件导航](#文件导航)

---

## 🎯 项目概述

本项目是一个基于 **FastMCP** 框架开发的油田钻井数据智能查询服务，实现了完整的鉴权、数据查询、分析对比和报告生成功能，可直接部署到本地环境并与 Claude Desktop 集成使用。

### 项目特点

- ✅ **开箱即用**：内置模拟数据，无需配置数据库即可测试
- ✅ **完整鉴权**：生产级的权限控制和审计
- ✅ **智能聚合**：服务端完成数据处理，节省LLM Token
- ✅ **中文友好**：支持中文井号识别和归一化
- ✅ **易于扩展**：清晰的代码结构，详细的注释
- ✅ **测试完备**：13个测试用例覆盖所有功能
- ✅ **文档齐全**：完整的部署指南和使用文档

### 技术栈

- **框架**: FastMCP 0.2.0+
- **ORM**: SQLAlchemy 2.0+
- **数据处理**: Pandas 2.0+
- **参数校验**: Pydantic 2.0+
- **数据库**: SQLite（可切换至 PostgreSQL/MySQL/Oracle）
- **协议**: MCP (Model Context Protocol) stdio

---

## ✨ 核心功能

### 1. 鉴权系统（参考 auth-mcp.md）

- ✅ 基于角色的访问控制（RBAC）
- ✅ 支持 admin/engineer/viewer/default 四种角色
- ✅ 井级和区块级双重权限控制
- ✅ 工具调用前强制鉴权检查
- ✅ 完整的审计日志追踪（TraceID、执行时间、用户角色）

**实现要点：**
```python
class PermissionService:
    @staticmethod
    def check_well_access(user_role: str, well_id: str) -> bool
    
    @staticmethod
    def check_block_access(user_role: str, block_name: str) -> bool
```

### 2. 单井数据查询（参考 many-tool.md）

- ✅ 模糊搜索井号（支持中文井名归一化）
- ✅ 井基本信息概览（开钻日期、井型、钻机、队伍）
- ✅ 钻井日报查询（DDR）
- ✅ NPT（非生产时间）事故分析
- ✅ 井身结构/套管程序查询
- ✅ 泥浆参数追踪（密度、粘度、pH）

**工具列表：**
- `search_wells` - 井搜索
- `get_well_summary` - 井概览
- `get_well_casing` - 井身结构
- `get_daily_report` - 日报查询
- `analyze_npt_events` - NPT分析
- `track_mud_properties` - 泥浆追踪

### 3. 多井/邻井对比（参考 many-tool.md）

- ✅ 基本信息横向对比
- ✅ 钻井速度对比（ROP、日进尺、效率指标）
- ✅ NPT统计对比矩阵
- ✅ 标杆井识别
- ✅ 风险井预警

**工具列表：**
- `compare_wells_overview` - 基本对比
- `compare_drilling_pace` - 速度对比
- `compare_npt_statistics` - NPT对比

### 4. 日报总结成周报/月报（参考 read.md）

- ✅ 单井期间数据汇总（周报/月报素材）
- ✅ 区块级汇总报告（厂级报告）
- ✅ 自动计算核心指标（进尺、ROP、NPT、泥浆趋势）
- ✅ 每日作业时间轴生成
- ✅ 标杆井和问题井识别
- ✅ 钻井队绩效排名

**工具列表：**
- `get_period_drilling_summary` - 单井期间报告
- `get_block_period_summary` - 区块汇总报告

### 5. 🆕 意图识别增强功能

#### 规划工具 (`plan_data_retrieval`)

当用户查询复杂、涉及多步骤时，先调用此工具进行意图分类和规划。

**参数**：
- `intent_category`: 意图分类（single_well_status/multi_well_compare/historical_report/realtime_monitor/report_generation）
- `entities`: 涉及的实体列表（井号、区块）
- `time_range`: 时间范围描述

#### 智能归一化

**中文井号识别**：
- "中102" → "ZT-102"
- "102井" → "ZT-102"
- "新疆009" → "XY-009"

**模糊日期识别**：
- "昨天"、"yesterday" → 自动计算日期
- "上周"、"last_week" → 计算日期范围
- "本月"、"this_month" → 本月1号到今天
- "最近7天" → 7天前到今天

---

## 🏗️ 技术架构

### 架构分层

```
┌─────────────────────────────────────────┐
│    LLM Client (Claude Desktop)          │
│    - 自然语言理解                        │
│    - 意图识别与改写                      │
│    - 工具调用决策                        │
└──────────────┬──────────────────────────┘
               │ MCP Protocol (stdio)
┌──────────────▼──────────────────────────┐
│    MCP Server (oilfield_mcp_server.py)  │
├─────────────────────────────────────────┤
│  鉴权层 (PermissionService)              │
│    - 角色权限检查                        │
│    - 井级/区块级控制                     │
├─────────────────────────────────────────┤
│  监控层 (AuditLog)                       │
│    - 调用日志                            │
│    - 性能监控                            │
│    - 异常追踪                            │
├─────────────────────────────────────────┤
│  业务层 (MCP Tools)                      │
│    - 11个查询工具                        │
│    - Pydantic参数校验                    │
│    - Markdown格式输出                    │
├─────────────────────────────────────────┤
│  数据层 (SQLAlchemy ORM)                 │
│    - Well / DailyReport                  │
│    - NPTEvent / CasingProgram            │
│    - 关系映射                            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│    Database (SQLite/PostgreSQL/MySQL)   │
│    - 井基本信息表                        │
│    - 钻井日报表                          │
│    - NPT事故表                           │
│    - 套管程序表                          │
└─────────────────────────────────────────┘
```

### 关键设计模式

1. **装饰器模式**（AuditLog）
   - 用于工具调用的横切关注点（日志、性能监控）
   - 不侵入业务逻辑

2. **策略模式**（PermissionService）
   - 不同角色对应不同权限策略
   - 易于扩展新角色

3. **适配器模式**（normalize_well_id）
   - 处理中文井号与标准ID的映射
   - 用户友好的输入接口

4. **聚合模式**（区块报告）
   - 服务端完成数据聚合
   - 减轻LLM的计算负担

---

## 📊 数据模型

### 核心表结构

```sql
-- 井基本信息
Wells (
    id, name, block, target_depth, spud_date, 
    status, well_type, team, rig
)

-- 钻井日报
DailyReports (
    id, well_id, report_date, report_no,
    current_depth, progress, avg_rop,
    mud_density, mud_viscosity, mud_ph,
    operation_summary, next_plan
)

-- NPT事故
NPTEvents (
    id, report_id, category, duration, 
    severity, description
)

-- 套管程序
CasingPrograms (
    id, well_id, run_number, run_date,
    size, shoe_depth, cement_top
)
```

### 关系设计

```
Well 1----* DailyReport 1----* NPTEvent
     1----* CasingProgram
```

### 数据表详细说明

#### 1. Well (井基本信息)
- `id`: 井号（主键）
- `name`: 井名
- `block`: 区块
- `target_depth`: 设计井深
- `spud_date`: 开钻日期
- `status`: 状态（Active/Completed/Suspended）
- `well_type`: 井型（Vertical/Horizontal/Directional）
- `team`: 钻井队
- `rig`: 钻机

#### 2. DailyReport (钻井日报)
- `id`: 主键
- `well_id`: 井号（外键）
- `report_date`: 日期
- `report_no`: 报告编号
- `current_depth`: 当前井深
- `progress`: 日进尺
- `mud_density`: 泥浆密度
- `mud_viscosity`: 泥浆粘度
- `mud_ph`: 泥浆pH
- `operation_summary`: 作业摘要
- `next_plan`: 下步计划
- `avg_rop`: 平均机械钻速
- `bit_number`: 钻头编号

#### 3. NPTEvent (非生产时间事故)
- `id`: 主键
- `report_id`: 日报ID（外键）
- `category`: 事故类别（Lost Circulation/Kick/Equipment Failure等）
- `duration`: 损失时间（小时）
- `severity`: 严重程度（Low/Medium/High）
- `description`: 详细描述

#### 4. CasingProgram (套管程序)
- `id`: 主键
- `well_id`: 井号（外键）
- `run_number`: 趟次
- `run_date`: 下入日期
- `size`: 套管尺寸（英寸）
- `shoe_depth`: 鞋深（米）
- `cement_top`: 水泥返高（米）

---

## 🛠️ 工具列表

| 工具名称 | 功能描述 | 使用场景 | 新增/增强 |
|---------|---------|---------|----------|
| `plan_data_retrieval` ⭐ | 意图规划与分类 | 复杂查询时先规划 | 🆕 新增 |
| `search_wells` | 模糊搜索井号 | 不知道准确井号时 | - |
| `get_well_summary` | 获取井概览 | 查看井基本信息 | ✨ 支持中文井号 |
| `get_well_casing` | 查询井身结构 | 查看套管程序 | ✨ 支持中文井号 |
| `get_daily_report` | 查询日报 | 查看某天的作业情况 | ✨ 支持模糊日期 |
| `analyze_npt_events` | NPT分析 | 分析事故和复杂情况 | ✨ 支持中文井号 |
| `compare_wells_overview` | 多井基本对比 | 对比井的基本信息 | ✨ 支持中文井号 |
| `compare_drilling_pace` | 钻井速度对比 | 识别提速标杆井 | ✨ 支持中文井号 |
| `compare_npt_statistics` | NPT对比 | 识别风险井 | ✨ 支持中文井号 |
| `get_period_drilling_summary` | 单井期间报告 | 生成周报/月报素材 | ✨ 支持模糊日期范围 |
| `get_block_period_summary` | 区块汇总报告 | 生成厂级报告 | ✨ 支持模糊日期范围 |
| `track_mud_properties` | 泥浆参数追踪 | 监测泥浆性能变化 | ✨ 支持中文井号 |

---

## 📝 System Prompt 配置

### 方式一：使用完整配置文件（推荐）⭐

项目提供了完整的 `system_prompt.md` 配置文件，包含：
- ✅ 详细的实体归一化规则
- ✅ 完整的术语映射表
- ✅ Few-Shot Learning 示例
- ✅ 工具选择决策树
- ✅ 报告生成最佳实践

**使用方法**：
1. 打开 `system_prompt.md` 文件
2. 将内容复制到 Claude Desktop 的自定义指令中
3. 或在对话开始时告诉 Claude："请按照 system_prompt.md 中的规则与我交互"

### 方式二：简化版配置

如果需要简化版本，可以使用以下 System Prompt：

```
你是一个专业的油田钻井数据助手。你连接了一个 MCP 数据服务。

## 核心规则

1. **模糊输入支持**：
   - 中文井号："中102" 自动识别为 "ZT-102"
   - 模糊日期："昨天"、"上周" 自动计算具体日期
   - 系统已支持，可直接传递模糊输入

2. **意图映射**：
   - "谁钻得快"、"提速" → compare_drilling_pace
   - "有什么事故"、"井漏" → analyze_npt_events
   - "套管"、"井身结构" → get_well_casing
   - "周报"、"月报" → get_period_drilling_summary

3. **复杂查询**：
   - 涉及多个步骤时，先调用 plan_data_retrieval 工具规划

4. **默认行为**：
   - user_role 默认使用 "admin"
   - 未提供日期时使用 "today"
```

### 术语映射速查表

| 用户可能说的 | 标准术语 | 对应工具 |
|------------|---------|---------|
| 提速、钻得快 | ROP、机械钻速 | compare_drilling_pace |
| 井漏、溢流、卡钻 | NPT、复杂情况 | analyze_npt_events |
| 泥浆、密度、粘度 | 泥浆性能 | track_mud_properties |
| 套管、井身结构 | 套管程序 | get_well_casing |
| 周报、月报 | 期间报告 | get_period_drilling_summary |

---

## 📁 文件导航

### 核心文件结构

```
gemini-ge/
├── oilfield_mcp_server.py      # 主服务器代码（核心文件）
├── requirements.txt             # Python依赖清单
├── config_example.json          # Claude Desktop配置示例
├── test_server.py              # 功能测试脚本
├── start_server.bat            # Windows启动脚本
├── run_test.bat                # Windows测试脚本
└── md/                         # 文档目录
    ├── 部署启动指南.md          # 部署和启动文档
    ├── 项目介绍和框架文档.md    # 本文档
    ├── 改动记录文档.md          # 更新日志
    ├── system_prompt.md        # System Prompt 配置
    └── ...
```

### 代码文件分段说明

**oilfield_mcp_server.py** (~900行)：

| 部分 | 行数范围 | 说明 |
|-----|---------|------|
| Part 1: 配置与日志 | 1-139 | 权限配置、审计日志 |
| Part 2: 数据模型 | 140-174 | SQLAlchemy ORM 定义 |
| Part 3: 数据初始化 | 175-250 | 模拟数据注入 |
| Part 4: MCP 服务 | 251-870 | 11个工具定义 |
| Part 5: 启动入口 | 871-900 | 服务器启动 |

### 功能模块分布

```
┌─────────────────────────────────────────┐
│           功能模块分布                  │
├─────────────────────────────────────────┤
│ 1. 鉴权管理      (2个类，50行)         │
│ 2. 数据模型      (4个表，70行)         │
│ 3. 井查询工具    (4个工具，200行)      │
│ 4. 对比工具      (3个工具，180行)      │
│ 5. 报告生成      (2个工具，200行)      │
│ 6. 参数追踪      (1个工具，60行)       │
│ 7. 审计日志      (1个装饰器，40行)     │
│ 8. 辅助函数      (3个，40行)           │
└─────────────────────────────────────────┘
```

### 快速查找

#### 查找鉴权相关代码
- `oilfield_mcp_server.py` 第34-105行
- `PermissionService` 类
- 每个工具中的权限检查代码

#### 查找数据库模型
- `oilfield_mcp_server.py` 第142-174行
- `Well`, `DailyReport`, `NPTEvent`, `CasingProgram` 类

#### 查找工具定义
- `oilfield_mcp_server.py` 第269-868行
- 搜索 `@mcp.tool()` 装饰器

#### 查找测试用例
- `test_server.py` 文件
- 13个 `test_*` 函数

---

## 🎯 使用场景指南

### 场景1：第一次使用
1. 阅读 `部署启动指南.md`（5分钟）
2. 运行 `run_test.bat` 测试功能
3. 按照快速指南配置 Claude Desktop
4. 开始对话！

### 场景2：了解所有功能
1. 阅读本文档的"核心功能"章节
2. 查看工具列表和使用示例
3. 运行 `test_server.py` 查看实际效果

### 场景3：遇到问题
1. 查看 `部署启动指南.md` 的故障排查章节
2. 运行 `test_server.py` 验证基础功能
3. 检查日志输出

### 场景4：修改代码
1. 阅读本文档的"技术架构"章节
2. 查看 `oilfield_mcp_server.py` 中的代码注释
3. 参考扩展开发指南

### 场景5：连接真实数据库
1. 阅读 `部署启动指南.md` 的数据库配置章节
2. 修改 `oilfield_mcp_server.py` 第176行
3. 注释掉第194行的 `seed_mock_data()`

---

## 🏆 核心特性实现

### 1. 意图识别增强（参考 many-tool.md）

**问题**：LLM 可能不理解钻井术语，导致工具选择错误。

**解决方案**：
- 详细的 docstring（场景化描述 + 关键词标签）
- System Prompt 中的术语映射表
- 参数使用 `Literal` 枚举限制选项

**示例**：
```python
@mcp.tool()
def analyze_npt_events(...) -> str:
    """
    [场景] 分析某井的所有非生产时间（NPT）事件和复杂情况。
    [关键词] 事故、复杂、井漏、溢流、NPT、非生产时间
    """
```

### 2. 数据聚合优化（参考 many-tool.md）

**问题**：如果让 LLM 循环调用单井工具，会导致Token消耗巨大。

**解决方案**：
- 服务端完成所有 SQL JOIN 和 GROUP BY 操作
- 只返回聚合后的统计结果
- 使用 Pandas 进行二次聚合

**示例**：
```python
# 区块报告中的聚合逻辑
df = pd.DataFrame(data)
well_stats = df.groupby(['well_id', 'well_name']).agg({
    'progress': 'sum',
    'npt': 'sum'
}).sort_values('总进尺(m)', ascending=False)
```

### 3. 权限防御编程（参考 auth-mcp.md）

**问题**：不能依赖 Prompt 来实现权限控制。

**解决方案**：
- 每个工具强制调用权限检查
- 失败返回友好的错误信息（不抛异常）
- 权限过滤在数据查询前完成

**示例**：
```python
if not PermissionService.check_well_access(user_role, well_id):
    return f"🚫 权限拒绝：用户角色 ({user_role}) 无权访问井号 {well_id}。"
```

### 4. Markdown 输出优化（参考 many-tool.md）

**问题**：JSON 输出 Token 消耗大，且 LLM 阅读困难。

**解决方案**：
- 使用 Markdown 表格（pandas.to_markdown）
- 添加 Emoji 图标增强可读性
- 结构化的章节标题

**对比**：
```
# JSON (占用更多Token)
{"wells": [{"id": "ZT-102", "depth": 3500}, ...]}

# Markdown (更易读，Token更少)
| 井号 | 井深(m) |
|------|---------|
| ZT-102 | 3500  |
```

---

## 🔒 安全特性

1. **SQL注入防护**：使用 SQLAlchemy 参数化查询
2. **权限隔离**：角色级访问控制
3. **审计追踪**：完整的调用日志
4. **错误脱敏**：不暴露内部堆栈给用户
5. **输入校验**：Pydantic 严格的类型检查

---

## 🚀 扩展指南

### 添加新工具

1. 在 `oilfield_mcp_server.py` 中定义新函数
2. 使用 `@mcp.tool()` 和 `@AuditLog.trace()` 装饰器
3. 添加详细的 docstring（LLM会读取）
4. 添加权限检查逻辑

示例：
```python
@mcp.tool()
@AuditLog.trace("your_new_tool")
def your_new_tool(
    param1: str = Field(..., description="参数描述"),
    user_role: str = Field("default", description="当前用户角色")
) -> str:
    """
    [场景] 这个工具用于...
    [关键词] 关键词1、关键词2
    """
    # 权限检查
    if not PermissionService.check_well_access(user_role, param1):
        return "🚫 权限拒绝。"
    
    # 业务逻辑
    session = Session()
    try:
        # ... 数据库查询 ...
        return "结果"
    finally:
        session.close()
```

### 添加新的数据表

1. 在 `Part 2` 中定义新的 SQLAlchemy 模型
2. 在 `seed_mock_data()` 中添加模拟数据
3. 创建对应的查询工具

---

## 📈 性能特性

### 1. 审计日志（参考 many-tool.md）
```python
@AuditLog.trace("tool_name")
def tool_function(...):
    # 自动记录：开始时间、结束时间、执行时长、异常
```

输出示例：
```json
{
  "event": "TOOL_SUCCESS",
  "trace_id": "a3b2c1d4",
  "tool": "search_wells",
  "duration_ms": 125.3
}
```

### 2. 异常处理
- 所有工具调用都被 try-except 包裹
- 返回友好的错误信息（不中断对话）
- TraceID 用于问题追踪

### 3. 数据降采样（参考 many-tool.md）
- 时间范围过大时自动聚合
- 避免返回超过1000行的原始数据
- 优先返回统计指标而非明细

---

## 📚 最佳实践

1. **Tool 设计**：按用户意图分层，不按数据库表结构
2. **权限控制**：在代码层强制执行，不依赖 Prompt
3. **输出格式**：优先使用 Markdown，避免大量 JSON
4. **数据聚合**：服务端完成，只给 LLM 统计结果
5. **错误处理**：返回友好信息，不中断对话流
6. **日志审计**：记录所有调用，便于问题追踪

---

## 📊 代码统计

```
总代码行数：   ~900 行
总注释行数：   ~200 行
文档字数：     ~15000 字
测试用例：     13 个
工具数量：     11 个
数据表：       4 个
```

---

**项目状态：** ✅ 完成，可直接部署使用

**最后更新：** 2026-01-27
