# 真实数据测试指南

## 📋 测试前准备

### 1. 确保PostgreSQL服务运行

**检查服务状态：**
```powershell
# 方法1: 使用服务管理
Get-Service -Name postgresql*

# 方法2: 使用psql测试连接
psql -U postgres -d rag
```

**启动PostgreSQL服务：**
```powershell
# 如果服务未运行，启动它
Start-Service postgresql-x64-15  # 根据你的版本调整
```

### 2. 确保数据库和数据存在

**步骤1: 创建数据库表**
```powershell
python setup_oil_wells_table.py
```

**步骤2: 导入Excel数据**
```powershell
python import_well_data.py
```

**步骤3: 验证数据导入**
```powershell
python verify_imported_data.py
```

## 🧪 完整测试流程

### 方法一：自动化测试（推荐）

```powershell
# 运行完整测试脚本
python test_real_data.py
```

测试脚本会自动检查：
- ✅ 数据库连接
- ✅ 数据表存在
- ✅ 数据数量
- ✅ MCP服务器HTTP端点
- ✅ 工具调用功能

### 方法二：手动测试

#### 步骤1: 检查数据库

```powershell
# 使用psql连接
psql -U postgres -d rag

# 在psql中执行
SELECT COUNT(*) FROM oil_wells WHERE is_deleted = false;
SELECT well_name, qk, jx FROM oil_wells LIMIT 5;

# 退出
\q
```

#### 步骤2: 启动MCP服务器

**选项A: 主服务器（8080）+ 真实数据**
```powershell
# PowerShell
.\start_real_server.ps1

# 或批处理
start_real_server.bat
```

**选项B: 真实数据专用服务器（8081）**
```powershell
# PowerShell
.\start_true_server.ps1

# 或批处理
start_true_server.bat
```

#### 步骤3: 测试HTTP端点

**在另一个终端窗口中运行：**

```powershell
# 测试根路径
curl http://localhost:8080/

# 测试健康检查
curl http://localhost:8080/health

# 或使用8081端口
curl http://localhost:8081/
curl http://localhost:8081/health
```

#### 步骤4: 测试工具调用

**使用PowerShell：**

```powershell
# 准备请求数据
$headers = @{
    "Content-Type" = "application/json"
    "X-User-Role" = "ADMIN"
    "X-User-Email" = "test@example.com"
}

$body = @{
    jsonrpc = "2.0"
    id = 1
    method = "tools/list"
    params = @{}
} | ConvertTo-Json

# 发送请求
Invoke-RestMethod -Uri "http://localhost:8080/sse" -Method Post -Headers $headers -Body $body

# 测试搜索工具
$searchBody = @{
    jsonrpc = "2.0"
    id = 2
    method = "tools/call"
    params = @{
        name = "search_wells"
        arguments = @{
            keyword = ""
            limit = 5
        }
    }
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/sse" -Method Post -Headers $headers -Body $searchBody
```

## 📊 预期结果

### 1. 数据库连接成功

```
✅ oil_wells表存在
✅ 数据库连接成功
📊 当前有 XXX 口井的数据

📝 数据样例（前5条）：
  井名: xxx           区块: xxx      井型: xxx      设计井深: xxx
  ...
```

### 2. 服务器启动成功

```
🚀 油田钻井智能查询 MCP Server (真实数据库版本)
========================================

📌 系统功能：
  ✓ 连接PostgreSQL真实数据库
  ✓ 油井搜索和详细信息查询
  ✓ 按区块、项目查询
  ✓ 统计分析功能
  ✓ 基于角色的权限控制

🗄️  数据库配置：
  主机: localhost
  端口: 5432
  数据库: rag
  用户: postgres

🌐 访问地址: http://0.0.0.0:8081
```

### 3. HTTP端点响应

**根路径 (/):**
```json
{
  "service": "油田钻井数据MCP Server (真实数据)",
  "version": "2.0.0-real",
  "status": "running",
  "database": "localhost:5432/rag"
}
```

**健康检查 (/health):**
```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "2026-02-25T..."
}
```

### 4. 工具调用返回真实数据

应该能看到数据库中的真实油井数据，而不是模拟数据。

## ❌ 常见问题排查

### 问题1: 数据库连接失败

**错误信息：**
```
❌ 数据库连接失败: could not connect to server
```

**解决方法：**
```powershell
# 1. 检查PostgreSQL服务
Get-Service -Name postgresql*

# 2. 启动服务
Start-Service postgresql-x64-15

# 3. 检查端口
netstat -ano | findstr :5432
```

### 问题2: 数据库不存在

**错误信息：**
```
❌ database "rag" does not exist
```

**解决方法：**
```powershell
# 使用psql创建数据库
psql -U postgres
CREATE DATABASE rag;
\q
```

### 问题3: 表不存在

**错误信息：**
```
❌ oil_wells表不存在
```

**解决方法：**
```powershell
# 运行建表脚本
python setup_oil_wells_table.py
```

### 问题4: 没有数据

**错误信息：**
```
⚠️  警告：数据库中没有数据！
```

**解决方法：**
```powershell
# 导入Excel数据
python import_well_data.py
```

### 问题5: 服务器无法连接

**错误信息：**
```
❌ 无法连接到服务器
```

**解决方法：**
```powershell
# 确保服务器已启动
.\start_true_server.ps1

# 或
start_true_server.bat
```

### 问题6: 端口被占用

**错误信息：**
```
Address already in use
```

**解决方法：**
```powershell
# 查找占用端口的进程
netstat -ano | findstr :8080
netstat -ano | findstr :8081

# 关闭占用端口的进程
taskkill /PID <进程ID> /F
```

## 🎯 快速测试命令

**一键测试（需要先启动服务器）：**

```powershell
# 测试数据库 + 8081服务器
python test_real_data.py

# 或使用curl快速测试
curl http://localhost:8081/health
```

## 📝 测试检查清单

- [ ] PostgreSQL服务正在运行
- [ ] 数据库 'rag' 已创建
- [ ] oil_wells表已创建
- [ ] 数据已导入（运行 import_well_data.py）
- [ ] MCP服务器已启动（8080或8081）
- [ ] HTTP端点响应正常
- [ ] 工具调用返回真实数据
- [ ] 可以从LibreChat连接

## 🚀 生产环境部署建议

1. **修改权限模式：**
```powershell
# 编辑启动脚本，设置
$env:DEV_MODE = "false"  # 启用严格权限控制
```

2. **配置环境变量：**
```powershell
# 使用环境变量而不是硬编码密码
$env:DB_PASSWORD = "your_secure_password"
```

3. **使用HTTPS：**
- 配置反向代理（Nginx/Apache）
- 启用SSL证书

4. **监控和日志：**
- 监控服务器状态
- 定期备份数据库
- 查看日志文件

## 📚 相关文档

- [数据源切换指南.md](./数据源切换指南.md) - 详细的切换说明
- [README_数据源切换.md](./README_数据源切换.md) - 快速开始
- [PostgreSQL数据库设计.md](./PostgreSQL油井数据库设计.md) - 数据库结构

## 💡 提示

- 测试时建议先使用模拟数据模式验证功能
- 确认功能正常后再切换到真实数据
- 可以同时运行8080和8081两个服务器进行对比测试
- 定期备份PostgreSQL数据库
