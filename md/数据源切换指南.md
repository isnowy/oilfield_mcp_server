# MCP服务器数据源切换指南

## 概述

现在项目提供了三种启动方式，可以灵活切换使用模拟数据或真实PostgreSQL数据库。

## 文件说明

### 服务器文件

1. **oilfield_mcp_http_server.py** - 主服务器（支持切换数据源）
   - 端口：8080
   - 支持通过环境变量 `USE_REAL_DB` 切换数据源
   - 默认使用模拟数据（SQLite内存数据库）
   - 设置 `USE_REAL_DB=true` 后使用PostgreSQL真实数据库

2. **oilfield_mcp_true_server.py** - 真实数据专用服务器
   - 端口：8081
   - 仅连接PostgreSQL真实数据库
   - 专门用于真实数据查询

### 启动脚本

#### PowerShell脚本（推荐Windows用户）

- **start_mock_server.ps1** - 启动模拟数据服务器
- **start_real_server.ps1** - 启动真实数据服务器（8080端口）
- **start_true_server.ps1** - 启动真实数据专用服务器（8081端口）

#### 批处理脚本（Windows兼容）

- **start_mock_server.bat** - 启动模拟数据服务器
- **start_real_server.bat** - 启动真实数据服务器（8080端口）
- **start_true_server.bat** - 启动真实数据专用服务器（8081端口）

## 使用方法

### 方法一：使用模拟数据（快速测试）

适用于开发和测试，无需配置数据库。

**PowerShell:**
```powershell
.\start_mock_server.ps1
```

**批处理:**
```cmd
start_mock_server.bat
```

**或手动设置环境变量:**
```powershell
$env:USE_REAL_DB = "false"
$env:DEV_MODE = "true"
python oilfield_mcp_http_server.py
```

### 方法二：使用真实数据库（主服务器）

使用8080端口，连接PostgreSQL真实数据库。

**PowerShell:**
```powershell
.\start_real_server.ps1
```

**批处理:**
```cmd
start_real_server.bat
```

**或手动设置环境变量:**
```powershell
$env:USE_REAL_DB = "true"
$env:DEV_MODE = "true"
$env:DB_HOST = "localhost"
$env:DB_PORT = "5432"
$env:DB_NAME = "rag"
$env:DB_USER = "postgres"
$env:DB_PASSWORD = "postgres"
python oilfield_mcp_http_server.py
```

### 方法三：使用真实数据专用服务器

使用8081端口，专门用于真实数据库查询。

**PowerShell:**
```powershell
.\start_true_server.ps1
```

**批处理:**
```cmd
start_true_server.bat
```

**或手动启动:**
```powershell
$env:DEV_MODE = "true"
$env:DB_HOST = "localhost"
$env:DB_PORT = "5432"
$env:DB_NAME = "rag"
$env:DB_USER = "postgres"
$env:DB_PASSWORD = "postgres"
python oilfield_mcp_true_server.py
```

## 环境变量说明

### 数据源配置

- **USE_REAL_DB** - 是否使用真实数据库（仅用于 oilfield_mcp_http_server.py）
  - `true` - 使用PostgreSQL真实数据库
  - `false` - 使用SQLite内存模拟数据（默认）

### 权限配置

- **DEV_MODE** - 开发模式
  - `true` - 跳过权限检查（默认）
  - `false` - 启用严格权限控制

### 数据库配置（仅真实数据库模式）

- **DB_HOST** - 数据库主机（默认：localhost）
- **DB_PORT** - 数据库端口（默认：5432）
- **DB_NAME** - 数据库名称（默认：rag）
- **DB_USER** - 数据库用户名（默认：postgres）
- **DB_PASSWORD** - 数据库密码（默认：postgres）

## 数据源对比

### 模拟数据（SQLite内存数据库）

**优点：**
- 无需配置数据库
- 启动快速
- 适合开发和测试
- 数据一致性好

**缺点：**
- 数据是固定的模拟数据
- 服务器重启后数据重置
- 数据量有限（约9口井，100+条日报）

**适用场景：**
- 功能开发和调试
- 演示和培训
- 快速验证功能

### 真实数据（PostgreSQL数据库）

**优点：**
- 真实生产数据
- 数据持久化
- 数据量大
- 支持复杂查询

**缺点：**
- 需要配置PostgreSQL
- 需要导入数据
- 启动稍慢（需要测试数据库连接）

**适用场景：**
- 生产环境
- 真实数据查询
- 数据分析

## 两个服务器的区别

### oilfield_mcp_http_server.py (端口8080)

- 支持切换数据源（模拟/真实）
- 通过环境变量 `USE_REAL_DB` 控制
- 功能完整（包括日报、对比、周报等）
- 推荐用于一般场景

### oilfield_mcp_true_server.py (端口8081)

- 仅支持真实数据库
- 专门优化的真实数据查询工具
- 提供额外的统计功能
- 推荐用于需要专门查询真实数据的场景

## 端口说明

- **8080** - 主服务器（oilfield_mcp_http_server.py）
- **8081** - 真实数据专用服务器（oilfield_mcp_true_server.py）

两个服务器可以同时运行，互不影响。

## 配置LibreChat

### 配置模拟数据服务器

```yaml
mcpServers:
  oilfield-mock:
    url: http://localhost:8080/sse
    headers:
      X-User-Role: ADMIN
      X-User-Email: admin@example.com
```

### 配置真实数据服务器

```yaml
mcpServers:
  oilfield-real:
    url: http://localhost:8080/sse  # 或 8081
    headers:
      X-User-Role: ADMIN
      X-User-Email: admin@example.com
```

### 同时配置两个服务器

```yaml
mcpServers:
  oilfield-mock:
    url: http://localhost:8080/sse
    headers:
      X-User-Role: ADMIN
      X-User-Email: test@example.com
  
  oilfield-real:
    url: http://localhost:8081/sse
    headers:
      X-User-Role: ADMIN
      X-User-Email: admin@example.com
```

## 数据库准备（真实数据模式）

如果要使用真实数据库，需要先导入数据：

```powershell
# 1. 确保PostgreSQL正在运行
# 2. 创建数据库表结构
python setup_oil_wells_table.py

# 3. 导入Excel数据
python import_well_data.py

# 4. 验证导入结果
python verify_imported_data.py
```

## 快速切换

在开发过程中，可以通过修改脚本中的环境变量快速切换：

```powershell
# 编辑 start_real_server.ps1 或 start_real_server.bat
# 修改 USE_REAL_DB 的值即可切换
$env:USE_REAL_DB = "true"   # 使用真实数据库
$env:USE_REAL_DB = "false"  # 使用模拟数据
```

## 故障排查

### 真实数据库连接失败

1. 检查PostgreSQL服务是否运行
2. 检查数据库配置是否正确
3. 检查oil_wells表是否存在
4. 查看服务器启动日志

### 模拟数据无法加载

1. 检查是否有足够内存
2. 查看控制台错误信息
3. 确认 USE_REAL_DB=false

## 总结

现在你有三种方式运行MCP服务器：

1. **模拟数据模式** - 使用内存数据库，快速测试
2. **真实数据模式（8080）** - 主服务器切换到真实数据库
3. **真实数据专用（8081）** - 专门的真实数据查询服务器

选择最适合你需求的方式即可！
