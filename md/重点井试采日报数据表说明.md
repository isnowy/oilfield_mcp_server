# 重点井试采日报数据表设计与导入说明

## 一、数据表设计

### 表名：`key_well_daily`

### 字段设计

| 字段名 | 数据类型 | 说明 | 对应Excel列 |
|--------|----------|------|-------------|
| id | SERIAL | 主键ID | - |
| jh | VARCHAR(50) | 井号 | JH |
| qk | VARCHAR(50) | 区块 | QK |
| cw | VARCHAR(50) | 层位 | CW |
| cxh | VARCHAR(50) | 层序号 | CXH |
| djsd1 | DECIMAL(10,2) | 顶界深度1 | DJSD1 |
| djsd2 | DECIMAL(10,2) | 底界深度2 | DJSD2 |
| rq | DATE | 日期 | RQ |
| zt | VARCHAR(50) | 状态 | ZT |
| cyfs | VARCHAR(50) | 采油方式 | CYFS |
| yz | VARCHAR(50) | 油嘴 | YZ |
| gzsj | VARCHAR(100) | 工作时间 | GZSJ |
| gzzd | VARCHAR(50) | 工作制度 | GZZD |
| rcql | DECIMAL(10,2) | 日产气量（万方） | RCQL |
| hs | DECIMAL(10,2) | 含水（%） | HS |
| yysx | DECIMAL(10,4) | 油压上限（兆帕） | YYSX |
| yyxx | DECIMAL(10,4) | 油压下限（兆帕） | YYXX |
| tysx | DECIMAL(10,4) | 套压上限（兆帕） | TYSX |
| tyxx | DECIMAL(10,4) | 套压下限（兆帕） | TYXX |
| hysx | DECIMAL(10,4) | 回压上限（兆帕） | HYSX |
| hyxx | DECIMAL(10,4) | 回压下限（兆帕） | HYXX |
| d_ly | DECIMAL(10,4) | 流压 | D.LY |
| d_jy | DECIMAL(10,4) | 静压 | D.JY |
| d_bz | TEXT | 施工内容/备注 | D.BZ |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |
| is_deleted | BOOLEAN | 软删除标记 | - |

### 索引设计

- 主键索引：id
- 单列索引：jh, rq, qk, zt, created_at, is_deleted
- 复合索引：(jh, rq), (qk, rq)

### 设计说明

1. **井号字段（jh）**：关联oil_wells表的well_name字段（非jh字段）。经验证，key_well_daily表中的97个井号全部能在oil_wells.well_name中找到匹配（100%匹配率），14,296条记录全部可关联。未设置外键约束以保持灵活性。

2. **深度字段**：使用DECIMAL类型而非INTEGER，以支持小数值（如704.5米）。

3. **压力字段**：使用DECIMAL(10,4)类型，精确到4位小数，满足兆帕单位的精度要求。

4. **日期字段**：支持从2005年至2026年的数据。

## 二、数据导入情况

### 导入统计

- **总记录数**：14,296 条
- **不同井号数**：97 个
- **日期范围**：2005-10-23 至 2026-01-02
- **与oil_wells表关联**：100%匹配（97个井号全部在oil_wells.well_name中找到）

### 主要井号统计（Top 5）

| 井号 | 记录数 |
|------|--------|
| A页QH | 464 条 |
| 天湾Q | 452 条 |
| 白VVP | 391 条 |
| 克SQQ | 335 条 |
| 湾探Q | 321 条 |

### 主要区块统计（Top 5）

| 区块 | 记录数 |
|------|--------|
| 空值 | 9,706 条 |
| 南缘 | 1,489 条 |
| 西北缘 | 985 条 |
| 八256下盘 | 460 条 |
| 玛北探区X1 | 318 条 |

## 三、相关文件

### 1. 建表SQL脚本
**文件**：`key_well_daily_schema.sql`

包含完整的表结构定义、索引创建、字段注释和触发器。

### 2. 数据导入脚本
**文件**：`import_key_well_daily.py`

**功能**：
- 读取Excel文件（支持双行表头：第1行中文，第2行英文）
- 数据清洗和验证
- 自动创建表（如果不存在）
- 批量导入数据到PostgreSQL

**使用方法**：
```bash
python import_key_well_daily.py
```

**配置**：
```python
# 数据库配置
DB_CONFIG = {
    'host': 'localhost',
    'port': 5432,
    'database': 'rag',
    'user': 'postgres',
    'password': 'postgres'
}

# Excel文件路径
EXCEL_FILE = "key_well_daily.xlsx"
```

### 3. 数据验证脚本
**文件**：`verify_key_well_daily.py`

**功能**：
- 统计总记录数和井号数
- 显示日期范围
- 按井号和区块统计记录数
- 显示数据样例

**使用方法**：
```bash
pyt

### 4. 井号匹配检查脚本
**文件**：`check_well_name_matching.py`

**功能**：
- 清理表中的NaN值为NULL
- 检查key_well_daily.jh与oil_wells.well_name的匹配情况
- 统计匹配和未匹配的井号及记录数
- 生成匹配报告

**使用方法**：
```bash
python关联oil_wells表查询井的完整信息
SELECT k.jh, k.rq, k.zt, k.rcql, k.hs, 
       o.qk as 井区块, o.cw as 井层位, o.sjrq as 设计日期
FROM key_well_daily k
INNER JOIN oil_wells o ON k.jh = o.well_name
WHERE k.jh = 'A页QH'
ORDER BY k.rq DESC;

-- 3.  check_well_name_matching.py
```hon verify_key_well_daily.py
```

## 四、使用示例

-- 4. 查询某时间段的数据
SELECT jh, rq, zt, gzzd, rcql, hs
FROM key_well_daily
WHERE rq BETWEEN '2025-01-01' AND '2025-12-31'
ORDER BY rq DESC;

-- 5. 按井号统计平均产量C;

-- 2. 查询某时间段的数据
SELECT jh, rq, zt, gzzd, rcql, hs
FROM key_well_daily
WHERE rq BETWEEN '2025-01-01' AND '2025-12-31'
ORDER BY rq DESC;

-- 6. 按井号统计平均产量
SELECT jh, 
       COUNT(*) as 记录数,
       AVG(rcql) as 平均产气量,
       AVG(hs) as 平均含水
FROM key_well_daily
WHERE rcql IS NOT NULL
GROUP BY jh
ORDER BY 平均产气量 DESC;

-- 8. 查询最近的试采数据
SELECT jh, qk, rq, zt, gzzd, rcql, d_bz
FROM key_well_daily
WHERE zt = '试油'
ORDER BY rq DESC
LIMIT 10;

-- 9. 按区块和日期统计
SELECT qk, 
       DATE_TRUNC('month', rq) as 月份,
       COUNT(*) as 记录数,
       AVG(rcql) as 平均产气量
FROM key_well_daily
WHERE qk IS NOT NULL AND rcql IS NOT NULL
GROUP BY qk, DATE_TRUNC('month', rq)
ORDER BY 月份 DESC, 平均产气量 DESC;
```

## 五、数据清理情况

已执行数据清理操作，将Excel导入时产生的NaN字符串转换为数据库NULL值：
- qk字段：清理 9,706 个NaN值
- cw字段：清理 3,059 个NaN值  
- cxh字段：清理 12,831 个NaN值
- cyfs字段：清理 10,103 个NaN值
- yz字段：清理 10,299 个NaN值
- gzzd字段：清理 8,990 个NaN值
- 总计：清理 54,988 个NaN值

## 六、注意事项
七、后续优化建议

1. 补充缺失的区块信息（约68%的记录缺少区块）
2. 补充其他缺失字段（采油方式、油嘴、工作制度等）：约68%的记录区块字段为NULL（已清理NaN），使用时需注意处理空值。

3. **日期范围**：数据跨度20年（2005-2026），查询时建议使用日期范围条件提高性能。

4. **数值精度**：压力数据使用4位小数，产量数据使用2位小数，符合油田实际精度要求。

5. **扩展性**：表结构预留了审计字段（created_at, updated_at, is_deleted），支持后续数据追踪和软删除。

## 六、后续优化建议

1. 建立井号映射表，关联Excel井号与oil_wells表井号
2. 补充缺失的区块信息
3. 添加数据质量检查规则（如压力合理性、产量范围等）
4. 考虑分区表设计，按年份或月份分区提高大数据量查询性能
5. 添加物化视图用于常用的统计查询
