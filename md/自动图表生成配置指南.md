# 自动图表生成配置指南

## 📊 目标

在LibreChat中集成MCP Server后，当返回统计数据时，**不需要用户说"画图"**，LLM自动判断并生成可视化图表。

---

## 🎯 实现方案

### 方案一：在返回数据中添加显式提示（推荐）

#### 1. MCP Server端修改

在返回统计数据时，添加可视化提示字段：

```python
def get_statistics(group_by: str = "block", user_role: str = "GUEST", 
                   user_id: str = "unknown", user_email: str = "unknown") -> str:
    """获取统计信息 - 带可视化提示"""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    try:
        # ... 查询逻辑 ...
        
        data = []
        for row in results:
            data.append({
                "名称": row['name'],
                "井数": row['count'],
                "平均设计井深(m)": round(float(row['avg_depth']), 2) if row['avg_depth'] else 0
            })
        
        # 构建返回结果，包含可视化提示
        result = {
            "status": "success",
            "data_type": "statistics",
            "group_by": group_by,
            "data": data,
            "total_count": len(data),
            
            # 🎨 可视化提示字段（关键）
            "visualization": {
                "recommended": True,
                "chart_type": "bar",  # bar/line/pie
                "title": f"油井统计（按{group_name_map.get(group_by, group_by)}分组）",
                "x_axis": "名称",
                "y_axis": "井数",
                "description": "建议使用柱状图展示不同区块/项目的油井分布情况"
            }
        }
        
        # 转为markdown格式，并附加可视化提示
        markdown_output = f"""### 📊 {result['visualization']['title']}

{df_to_markdown(pd.DataFrame(data))}

---
💡 **可视化建议**：此数据适合用 **{result['visualization']['chart_type']}** 图表展示，可以更直观地对比{group_name_map.get(group_by)}之间的差异。
"""
        return markdown_output
    
    finally:
        cursor.close()
        conn.close()
```

#### 2. LibreChat System Prompt配置

在LibreChat的System Prompt中添加：

```markdown
## 📊 自动可视化规则

当MCP工具返回的数据中包含以下特征时，**自动生成图表**：

### 触发条件
1. 返回的数据是**表格/统计类型**（包含多行数据）
2. 数据包含**数值字段**（如：井数、深度、时长等）
3. 数据中有明确的**可视化建议**（如："💡 可视化建议"）

### 自动生成流程
```
MCP工具返回数据 
  ↓
检测到可视化建议标记
  ↓
分析数据结构（判断适合的图表类型）
  ↓
自动调用Artifacts生成图表
  ↓
同时展示：原始数据 + 可视化图表
```

### 图表类型判断规则

**柱状图（Bar Chart）** - 适用于：
- 分类统计数据（如：按区块统计井数）
- 对比不同项目/类别的数值
- 关键词：统计、分组、对比

**折线图（Line Chart）** - 适用于：
- 时间序列数据（如：钻进速度趋势）
- 连续变化的数值
- 关键词：趋势、变化、时间

**饼图（Pie Chart）** - 适用于：
- 占比分布（如：井型占比）
- 数据项较少（<8项）
- 关键词：占比、比例、分布

### 示例

**用户输入**：
```
"查询各区块的油井统计"
```

**系统行为**：
1. 调用 `get_statistics(group_by="block")`
2. 检测到返回数据中的"💡 可视化建议"标记
3. **自动判断**：数据适合用柱状图
4. 生成输出：
   ```
   ### 📊 油井统计（按区块分组）
   
   [数据表格]
   
   [自动生成柱状图]
   ```

**关键点**：用户**不需要说"画图"**，系统看到可视化建议标记后自动生成。

### 不自动生成图表的情况
- 单个数据点（如查询单个井的详情）
- 纯文本信息（如帮助文档）
- 已经是图表格式的数据
- 数据量过大（>100行）
```

---

## 🔄 方案二：纯System Prompt驱动（无需修改代码）

如果不想修改MCP Server代码，可以完全依赖LibreChat的System Prompt：

```markdown
## 📊 数据可视化自动判断规则

对于从MCP工具返回的**任何统计类数据**，你应该：

### 1. 自动识别可视化需求

**需要可视化的数据特征**：
- ✅ 包含2行以上的表格数据
- ✅ 包含数值字段（井数、深度、时长、占比等）
- ✅ 查询意图是"统计"、"对比"、"分析"

**不需要可视化的情况**：
- ❌ 单条详细信息（如单个井的详情）
- ❌ 纯文本描述
- ❌ 列表类信息

### 2. 自动生成流程

当MCP工具返回符合条件的数据时：

```
步骤1：展示原始数据表格
步骤2：分析数据特征，判断最佳图表类型
步骤3：使用Artifacts自动生成可视化图表
步骤4：添加简短说明
```

**完整示例**：

用户："查询各区块的油井统计"

你的响应：
```
我已查询到各区块的油井统计数据：

[展示表格]

[检测到统计数据，自动生成柱状图]

从图表可以看出，Block-A的油井数量最多，占比达到40%...
```

### 3. 关键指令

⚠️ **重要**：
- 只要返回的是**统计/对比类数据**，就**默认生成图表**
- 不需要等待用户说"画图"或"可视化"
- 生成图表是**标准输出**的一部分，不是额外操作
```

---

## 🎨 具体实现示例

### 示例1：区块统计自动生成柱状图

**用户输入**：
```
"各区块有多少口井？"
```

**MCP返回数据**（带可视化提示）：
```markdown
### 📊 油井统计（按区块分组）

| 名称    | 井数 | 平均设计井深(m) |
|---------|------|-----------------|
| Block-A | 12   | 3500.50         |
| Block-B | 8    | 2800.25         |
| Block-C | 5    | 4100.00         |

---
💡 **可视化建议**：此数据适合用 **bar** 图表展示，可以更直观地对比区块之间的差异。
```

**LLM自动生成的完整响应**：
```markdown
已查询到各区块的油井统计：

| 名称    | 井数 | 平均设计井深(m) |
|---------|------|-----------------|
| Block-A | 12   | 3500.50         |
| Block-B | 8    | 2800.25         |
| Block-C | 5    | 4100.00         |

[自动生成柱状图 - 使用Artifacts]

从统计数据可以看出：
- Block-A的油井数量最多，共12口井
- Block-C虽然井数较少，但平均井深最大，达到4100米
```

### 示例2：时间趋势自动生成折线图

**用户输入**：
```
"ZT-102最近7天的钻进速度趋势"
```

**MCP返回数据**：
```markdown
### 📈 钻进速度趋势

| 日期       | 钻进速度(m/h) |
|------------|---------------|
| 2024-01-19 | 8.5           |
| 2024-01-20 | 9.2           |
| 2024-01-21 | 7.8           |
| 2024-01-22 | 10.1          |
| 2024-01-23 | 9.5           |

---
💡 **可视化建议**：此数据适合用 **line** 图表展示时间趋势。
```

**LLM自动生成的完整响应**：
```markdown
已查询到ZT-102最近7天的钻进速度数据：

[展示表格]

[自动生成折线图]

趋势分析：钻进速度在1月22日达到峰值（10.1 m/h），之后略有回落。
```

---

## 🛠️ 配置步骤

### Step 1: 修改MCP Server代码（可选）

如果选择方案一，修改以下文件：
- `oilfield_mcp_true_server.py`
- `oilfield_mcp_http_server.py`

在以下函数中添加可视化提示：
- `get_statistics()`
- `compare_npt_statistics()`
- `analyze_npt_events()` （如果返回统计数据）

### Step 2: 配置LibreChat System Prompt

#### 方法A：在librechat.yaml中配置

```yaml
endpoints:
  custom:
    - name: "油田数据助手"
      apiKey: "${ANTHROPIC_API_KEY}"
      baseURL: "https://api.anthropic.com/v1"
      models:
        default: ["claude-3-5-sonnet-20241022"]
      systemPrompt: |
        你是专业的油田钻井数据助手。
        
        ## 📊 自动可视化规则
        
        对于MCP工具返回的统计数据，你应该：
        1. 检测数据中的"💡 可视化建议"标记
        2. 自动判断最佳图表类型（柱状图/折线图/饼图）
        3. 使用Artifacts生成可视化图表
        4. 同时展示原始数据和图表
        
        **重要**：只要是统计/对比类数据，就自动生成图表，不需要等待用户说"画图"。
```

#### 方法B：在LibreChat UI中配置

1. 打开LibreChat
2. 点击右上角 ⚙️ 设置
3. 选择 **Custom Instructions**
4. 粘贴System Prompt内容
5. 保存

### Step 3: 重启服务

```powershell
# 重启MCP Server（如果修改了代码）
.\start_true_server.ps1

# 刷新LibreChat页面
```

### Step 4: 测试验证

测试用例：
```
1. "查询各区块的油井统计" → 应自动生成柱状图
2. "ZT-102的钻进速度趋势" → 应自动生成折线图
3. "各井型的占比" → 应自动生成饼图
```

---

## 📋 可视化提示字段设计规范

### 完整JSON格式（供参考）

```json
{
  "status": "success",
  "data_type": "statistics",
  "data": [...],
  "visualization": {
    "recommended": true,
    "chart_type": "bar",
    "title": "油井统计（按区块分组）",
    "x_axis": "名称",
    "y_axis": "井数",
    "description": "建议使用柱状图展示不同区块的油井分布",
    "additional_metrics": ["平均设计井深"]
  }
}
```

### Markdown简化格式（推荐）

```markdown
### 📊 数据标题

[表格数据]

---
💡 **可视化建议**：此数据适合用 **bar/line/pie** 图表展示。
```

**优势**：
- ✅ 简洁易读
- ✅ 不破坏现有Markdown格式
- ✅ LLM容易识别
- ✅ 人工查看也很友好

---

## 🎯 最佳实践建议

### 1. 推荐组合方案

**MCP Server端**：
- 在返回数据中添加简单的"💡 可视化建议"标记
- 不需要复杂的JSON结构

**LibreChat端**：
- 配置明确的System Prompt规则
- 让LLM自动判断图表类型

### 2. 图表类型判断逻辑

```python
def suggest_chart_type(data, group_by):
    """根据数据特征建议图表类型"""
    data_count = len(data)
    
    # 时间序列 → 折线图
    if 'date' in group_by or 'time' in group_by:
        return "line"
    
    # 占比统计且数据项少 → 饼图
    elif data_count <= 6 and any('占比' in col or '百分比' in col for col in data[0].keys()):
        return "pie"
    
    # 其他统计 → 柱状图
    else:
        return "bar"
```

### 3. 避免过度可视化

不建议可视化的场景：
- ❌ 单条数据（如单个井的详情）
- ❌ 超过50行的大表
- ❌ 纯文本信息

---

## 🔍 故障排查

### 问题1：LLM还是不生成图表

**检查清单**：
1. ☑ System Prompt是否正确配置
2. ☑ 返回数据中是否包含"💡 可视化建议"
3. ☑ LibreChat的Artifacts功能是否启用

**解决方案**：
- 加强System Prompt中的指令
- 使用更明确的触发词（如"⚠️ 请生成图表"）

### 问题2：生成了错误的图表类型

**原因**：LLM判断失误

**解决方案**：
- 在可视化建议中**明确指定**图表类型
- 示例：`💡 可视化建议：请使用**柱状图**展示`

### 问题3：数据太多导致图表不清晰

**解决方案**：
- 限制返回数据量（如top 10）
- 或在System Prompt中添加：
  ```markdown
  如果数据超过20项，自动聚合或筛选最重要的数据再生成图表
  ```

---

## 📚 扩展阅读

- [LibreChat Custom Instructions文档](https://docs.librechat.ai/)
- [Claude Artifacts使用指南](https://support.anthropic.com/en/articles/9487310-what-are-artifacts-and-how-do-i-use-them)
- [数据可视化最佳实践](https://www.data-to-viz.com/)

---

## 🎉 预期效果

**优化前**：
```
用户："查询各区块的油井统计"
LLM：[展示表格]

用户："请画个图"
LLM：[生成图表]
```

**优化后**：
```
用户："查询各区块的油井统计"
LLM：[展示表格 + 自动生成图表]

→ 省略了"请画个图"这一步！
```

---

**更新时间**：2026-02-25  
**适用版本**：LibreChat + MCP Server (HTTP/SSE)
