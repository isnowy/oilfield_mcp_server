# 批量查询功能说明

## 概述

已对 `oilfield_mcp_http_server.py` 中的以下功能进行批量查询支持升级：

1. **search_wells** - 支持多关键词搜索
2. **get_well_summary** - 支持批量获取多井概况
3. **get_daily_report** - 支持批量获取多井日报
4. **generate_weekly_report** - 支持批量生成多井周报

## 功能详细说明

### 1. search_wells - 批量搜索油井

#### 新增参数
- `keywords`: 字符串数组，支持同时搜索多个关键词

#### 兼容性
- 保留了原有的 `keyword` 单个关键词参数（向后兼容）

#### 使用示例

**单关键词搜索（旧接口）：**
```json
{
  "keyword": "ZT-102",
  "status": "All"
}
```

**多关键词搜索（新接口）：**
```json
{
  "keywords": ["ZT-102", "ZT-105", "Block-A"],
  "status": "All"
}
```

#### 输出示例
返回所有匹配关键词的井（自动去重），结果中显示所有关键词。

---

### 2. get_well_summary - 批量获取井概况

#### 新增参数
- `well_ids`: 字符串数组，井号列表

#### 兼容性
- 保留了原有的 `well_id` 单个井号参数（向后兼容）

#### 使用示例

**单井查询（旧接口）：**
```json
{
  "well_id": "ZT-102"
}
```

**多井查询（新接口）：**
```json
{
  "well_ids": ["ZT-102", "ZT-105", "ZT-108"]
}
```

#### 输出示例
- 单井查询：返回单个井的详细概况
- 多井查询：返回多个井的概况，用 `---` 分隔

---

### 3. get_daily_report - 批量获取日报

#### 新增参数
- `well_ids`: 字符串数组，井号列表
- `dates`: 字符串数组，日期列表（YYYY-MM-DD格式）

#### 兼容性
- 保留了原有的 `well_id` 和 `date` 单个参数（向后兼容）

#### 使用示例

**单井单日期（旧接口）：**
```json
{
  "well_id": "ZT-102",
  "date": "2023-11-10"
}
```

**多井同一日期：**
```json
{
  "well_ids": ["ZT-102", "ZT-105"],
  "dates": ["2023-11-10"]
}
```
或
```json
{
  "well_ids": ["ZT-102", "ZT-105"],
  "date": "2023-11-10"
}
```

**多井多日期（一一对应）：**
```json
{
  "well_ids": ["ZT-102", "ZT-105", "ZT-108"],
  "dates": ["2023-11-10", "2023-11-11", "2023-11-12"]
}
```

#### 注意事项
- 如果只提供一个日期，所有井使用同一个日期
- 如果提供多个日期，必须与井号列表一一对应
- 保持了日期为空时列出可用日期的功能

#### 输出示例
- 单井查询：返回单个日报
- 多井查询：返回多个日报，用 `---` 分隔

---

### 4. generate_weekly_report - 批量生成周报

#### 新增参数
- `well_ids`: 字符串数组，井号列表

#### 兼容性
- 保留了原有的 `well_id` 单个井号参数（向后兼容）

#### 使用示例

**单井周报（旧接口）：**
```json
{
  "well_id": "ZT-102",
  "start_date": "2023-11-01",
  "end_date": "2023-11-07"
}
```

**多井周报（新接口）：**
```json
{
  "well_ids": ["ZT-102", "ZT-105", "ZT-108"],
  "start_date": "2023-11-01",
  "end_date": "2023-11-07"
}
```

#### 输出示例
- 单井查询：返回单个周报
- 多井查询：返回多个周报，用 `---` 分隔

---

## 技术实现细节

### 1. 向后兼容
所有函数都保留了原有的单参数接口，通过以下方式实现兼容：

```python
if well_ids is None:
    if well_id:
        well_ids = [well_id]
    else:
        return "❌ 请提供井号"
```

### 2. 权限控制
批量查询时，每个井都会进行独立的权限检查，无权访问的井会返回权限拒绝信息。

### 3. 结果去重
对于 `search_wells` 函数，如果多个关键词匹配到相同的井，会自动去重。

### 4. 错误处理
批量查询时，单个井的错误不会中断整个查询流程，而是在结果中单独标注错误。

## 调用方式

### HTTP/SSE 端点
所有三个端点都已更新：
1. `/mcp/sse` - SSE传输方式（MCP协议）
2. `/mcp/tools` + `/mcp/call-tool` - HTTP REST方式
3. MCP Server handlers - 原生MCP协议

### 测试命令

可以使用 curl 测试HTTP端点：

```bash
# 批量搜索
curl -X POST http://localhost:8000/mcp/call-tool \
  -H "Content-Type: application/json" \
  -H "X-User-Role: ADMIN" \
  -d '{"name":"search_wells","arguments":{"keywords":["ZT","Block-A"]}}'

# 批量获取井概况
curl -X POST http://localhost:8000/mcp/call-tool \
  -H "Content-Type: application/json" \
  -H "X-User-Role: ADMIN" \
  -d '{"name":"get_well_summary","arguments":{"well_ids":["ZT-102","ZT-105"]}}'

# 批量获取日报
curl -X POST http://localhost:8000/mcp/call-tool \
  -H "Content-Type: application/json" \
  -H "X-User-Role: ADMIN" \
  -d '{"name":"get_daily_report","arguments":{"well_ids":["ZT-102","ZT-105"],"date":"2023-11-10"}}'

# 批量生成周报
curl -X POST http://localhost:8000/mcp/call-tool \
  -H "Content-Type: application/json" \
  -H "X-User-Role: ADMIN" \
  -d '{"name":"generate_weekly_report","arguments":{"well_ids":["ZT-102","ZT-105"],"start_date":"2023-11-01","end_date":"2023-11-07"}}'
```

## 更新总结

### 修改的文件
- `oilfield_mcp_http_server.py`

### 修改的函数
1. `search_wells()` - 业务逻辑函数
2. `get_well_summary()` - 业务逻辑函数
3. `get_daily_report()` - 业务逻辑函数
4. `generate_weekly_report()` - 业务逻辑函数

### 修改的工具定义
1. HTTP/SSE端点的 `tools/list` 处理
2. MCP Server 的 `@mcp_server.list_tools()` handler
3. HTTP端点的 `/mcp/tools`

### 修改的调用逻辑
1. HTTP/SSE端点的 `tools/call` 处理
2. MCP Server 的 `@mcp_server.call_tool()` handler
3. HTTP端点的 `/mcp/call-tool`

## 注意事项

1. **性能考虑**：批量查询会增加数据库负载，建议合理控制批量大小
2. **权限检查**：每个井都会独立进行权限检查
3. **缓存机制**：`get_daily_report` 保留了缓存机制，批量查询时也会使用缓存
4. **错误处理**：批量查询中的单个错误不会影响其他项的查询

## 后续优化建议

1. 添加批量查询的数量限制（例如：最多10个井）
2. 优化数据库查询，使用批量查询而不是循环查询
3. 添加并发查询支持以提高性能
4. 添加进度反馈机制（对于大批量查询）
