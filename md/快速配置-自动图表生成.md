# 🚀 自动图表生成 - 快速配置指南

## 📋 5分钟快速设置

### Step 1️⃣: 修改已完成 ✅

以下文件已添加可视化提示功能：
- ✅ [oilfield_mcp_true_server.py](../oilfield_mcp_true_server.py) - `get_statistics()` 函数
- ✅ [oilfield_mcp_server.py](../oilfield_mcp_server.py) - `compare_npt_statistics()` 函数

**修改内容**：在返回数据末尾添加了：
```markdown
---
💡 **可视化建议**：此数据适合用 **柱状图/折线图/饼图** 展示...
```

### Step 2️⃣: 配置LibreChat System Prompt

#### 方法A：在librechat.yaml中配置（推荐）

编辑 `librechat.yaml`，添加或修改 `systemPrompt` 字段：

```yaml
endpoints:
  custom:
    - name: "油田数据助手"
      apiKey: "${ANTHROPIC_API_KEY}"
      baseURL: "https://api.anthropic.com/v1"
      models:
        default: ["claude-3-5-sonnet-20241022"]
      # 👇 关键配置
      systemPrompt: |
        你是专业的油田钻井数据助手。
        
        ## 📊 自动可视化规则
        
        **重要**：当MCP工具返回包含"💡 可视化建议"的统计数据时，自动生成图表，不需要等待用户说"画图"！
        
        ### 触发条件
        1. 返回数据中包含"💡 **可视化建议**"标记
        2. 数据是表格/统计类型（2行以上）
        3. 包含数值字段（井数、深度、时长等）
        
        ### 自动生成流程
        1. 展示原始数据表格
        2. 根据建议的图表类型（柱状图/折线图/饼图）
        3. 使用Artifacts自动生成可视化图表
        4. 添加数据洞察分析
        
        ### 示例
        
        用户："各区块有多少口井？"
        
        你的响应：
        ```
        已查询到各区块的油井统计数据：
        
        [数据表格]
        
        [自动生成柱状图]
        
        **数据洞察**：
        - Block-A占比最高，共12口井
        - ...
        ```
        
        **禁止**：不要等待用户说"画图"才生成图表！
```

#### 方法B：在LibreChat UI中配置

1. 打开LibreChat
2. 点击右上角 ⚙️ **Settings**
3. 找到 **Custom Instructions** 或 **System Prompt**
4. 复制以下内容粘贴：

```
你是专业的油田钻井数据助手。

## 📊 自动可视化规则

**重要**：当MCP工具返回包含"💡 可视化建议"的统计数据时，自动生成图表！

触发条件：
1. 数据中包含"💡 **可视化建议**"标记
2. 是统计/对比类数据

自动行为：
1. 展示数据表格
2. 根据建议生成对应图表（柱状图/折线图/饼图）
3. 添加数据洞察

禁止等待用户说"画图"！
```

### Step 3️⃣: 重启服务

```powershell
# 重启MCP Server
.\start_true_server.ps1

# 刷新LibreChat页面（Ctrl + F5）
```

### Step 4️⃣: 测试验证

在LibreChat中测试以下查询：

#### 测试1：区块统计（应自动生成柱状图）
```
查询各区块的油井统计
```

**预期结果**：
- ✅ 显示数据表格
- ✅ 自动生成柱状图
- ✅ 包含数据分析

#### 测试2：井型统计（应自动生成饼图）
```
各井型的统计
```

**预期结果**：
- ✅ 显示井型分布表格
- ✅ 自动生成饼图
- ✅ 显示占比分析

#### 测试3：NPT对比（应自动生成柱状图）
```
对比ZT-102和ZT-105的NPT情况
```

**预期结果**：
- ✅ 显示NPT对比表格
- ✅ 自动生成柱状图
- ✅ 风险分析

---

## 🎯 效果对比

### 优化前 ❌
```
用户：各区块有多少口井？
AI：[显示表格]

用户：请画个图
AI：[生成图表]
```
需要 **2次对话**

### 优化后 ✅
```
用户：各区块有多少口井？
AI：[显示表格 + 自动生成图表 + 数据分析]
```
只需 **1次对话**！

---

## 🔍 故障排查

### 问题1：还是不自动生成图表

**检查清单**：
```
☑ System Prompt是否正确配置？
☑ 是否重启了LibreChat？
☑ 查询的是统计数据吗？（单条数据不会生成图表）
☑ LibreChat的Artifacts功能是否启用？
```

**解决方案**：
- 查看MCP Server返回的数据是否包含"💡 可视化建议"
- 在System Prompt中加强指令：
  ```markdown
  ⚠️ **强制规则**：只要看到"💡 可视化建议"标记，立即生成图表！
  ```

### 问题2：生成了错误的图表类型

**原因**：LLM没有按建议执行

**解决方案**：
在System Prompt中明确：
```markdown
根据"💡 可视化建议"中指定的图表类型生成，不要自行判断！
```

### 问题3：单个井详情也生成了图表

**原因**：触发条件过于宽松

**解决方案**：
在System Prompt中添加：
```markdown
❌ 不需要可视化的情况：
- 单条详细信息（如单个井的详情）
- 纯文本描述
- 列表类信息
```

---

## 📚 相关文档

- [完整配置指南](./自动图表生成配置指南.md) - 详细说明和高级配置
- [System Prompt模板](../librechat_system_prompt_with_auto_viz.md) - 可直接使用的完整模板
- [代码修改记录](./改动记录文档.md) - 查看所有代码变更

---

## 💡 最佳实践

1. **简洁的可视化提示**
   ```markdown
   💡 **可视化建议**：此数据适合用 **柱状图** 展示
   ```

2. **明确的System Prompt**
   ```markdown
   看到"💡 可视化建议" = 立即生成图表
   ```

3. **合理的触发条件**
   - ✅ 统计数据 → 生成图表
   - ❌ 详情数据 → 不生成图表

---

**配置完成时间**：2026-02-25  
**适用版本**：LibreChat + MCP Server (HTTP/SSE)  
**状态**：✅ 已测试可用
