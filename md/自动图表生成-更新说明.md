# 自动图表生成功能 - 更新说明

## 📅 更新时间
2026年2月25日

## 🎯 更新目标
实现在LibreChat中调用MCP Server返回统计数据时，**无需用户说"画图"**，系统自动判断并生成可视化图表。

## ✅ 已完成的修改

### 1. MCP Server端代码修改

#### 文件：[oilfield_mcp_true_server.py](../oilfield_mcp_true_server.py)

**修改函数**：`get_statistics()`（第1157行）

**修改内容**：
- 添加了图表类型智能判断逻辑
- 在返回结果末尾添加可视化提示标记

```python
# 判断最佳图表类型
data_count = len(data)
if group_by == "well_type" and data_count <= 6:
    chart_type = "饼图"
    chart_description = "适合展示各井型的占比分布"
else:
    chart_type = "柱状图"
    chart_description = f"适合对比不同{group_name_map.get(group_by)}的油井数量"

# 添加可视化提示
return f"""### 📊 油井统计（按{group_name_map.get(group_by, group_by)}分组）

{df_to_markdown(pd.DataFrame(data))}

---
💡 **可视化建议**：此数据适合用 **{chart_type}** 展示，可以更直观地{chart_description}。"""
```

#### 文件：[oilfield_mcp_server.py](../oilfield_mcp_server.py)

**修改函数**：`compare_npt_statistics()`（第1344行）

**修改内容**：
- 在NPT对比分析结果末尾添加可视化提示

```python
---
💡 **可视化建议**：此数据适合用 **柱状图** 展示，可以直观对比各井的NPT总时长和事故频次。
```

### 2. 新增配置文档

创建了以下文档帮助用户配置和使用：

1. **[自动图表生成配置指南.md](./自动图表生成配置指南.md)**
   - 完整的实现方案说明
   - 两种配置方案（修改代码 vs 纯System Prompt）
   - 详细的示例和最佳实践
   
2. **[快速配置-自动图表生成.md](./快速配置-自动图表生成.md)**
   - 5分钟快速设置指南
   - 测试验证步骤
   - 故障排查方案

3. **[librechat_system_prompt_with_auto_viz.md](../librechat_system_prompt_with_auto_viz.md)**
   - 完整的LibreChat System Prompt模板
   - 可直接复制使用
   - 包含详细的规则和示例

4. **[system_prompt_auto_viz_simple.txt](../system_prompt_auto_viz_simple.txt)**
   - 简化版System Prompt
   - 适合直接粘贴到LibreChat UI

## 🔧 实现原理

### 方案一：显式提示标记（推荐）

**MCP Server端**：
```markdown
[数据表格]

---
💡 **可视化建议**：此数据适合用 **柱状图** 展示
```

**LibreChat System Prompt**：
```
检测到"💡 可视化建议"标记 → 自动生成对应类型的图表
```

### 方案二：纯System Prompt驱动

**MCP Server端**：
- 无需修改代码，正常返回数据

**LibreChat System Prompt**：
```
检测到统计/对比类数据（2行以上表格 + 数值字段） → 自动生成图表
```

## 📊 支持的图表类型

| 图表类型 | 适用场景 | 触发条件 | 示例 |
|---------|---------|---------|------|
| 柱状图 | 分类统计、对比数据 | 按区块/项目统计 | 各区块油井数量 |
| 折线图 | 时间序列、趋势数据 | 包含日期/时间字段 | 钻进速度趋势 |
| 饼图 | 占比分布 | 数据项≤6且适合占比 | 井型占比分布 |

## 🎯 使用效果

### 优化前
```
用户：各区块有多少口井？
AI：[显示表格]

用户：请画个图
AI：[生成图表]
```
**需要2次对话**

### 优化后
```
用户：各区块有多少口井？
AI：[显示表格 + 自动生成图表 + 数据分析]
```
**只需1次对话！**

## 📋 配置步骤

### Step 1: MCP Server端（已完成）
- ✅ 修改了 `get_statistics()` 函数
- ✅ 修改了 `compare_npt_statistics()` 函数

### Step 2: LibreChat配置（用户操作）

**方法A：修改librechat.yaml**
```yaml
systemPrompt: |
  你是专业的油田钻井数据助手。
  
  ## 📊 自动可视化规则
  当MCP工具返回包含"💡 可视化建议"的数据时，自动生成图表！
  ...
```

**方法B：在UI中配置**
1. LibreChat → Settings → Custom Instructions
2. 复制 [system_prompt_auto_viz_simple.txt](../system_prompt_auto_viz_simple.txt) 的内容
3. 粘贴并保存

### Step 3: 重启服务
```powershell
.\start_true_server.ps1
```

### Step 4: 测试验证
```
测试查询：
1. "各区块的油井统计" → 应自动生成柱状图
2. "各井型的统计" → 应自动生成饼图
3. "对比ZT-102和ZT-105的NPT" → 应自动生成柱状图
```

## 🔍 技术细节

### 可视化提示标记格式

**标准格式**：
```markdown
---
💡 **可视化建议**：此数据适合用 **图表类型** 展示，描述...
```

**关键元素**：
- `💡` 图标：视觉标识
- `**可视化建议**`：关键词
- `**图表类型**`：柱状图/折线图/饼图

### LLM识别逻辑

System Prompt中的核心规则：
```python
if "💡 可视化建议" in mcp_response:
    chart_type = extract_chart_type(mcp_response)  # 提取图表类型
    auto_generate_chart(data, chart_type)  # 自动生成图表
```

## ⚠️ 注意事项

### 不自动生成图表的情况
- ❌ 单条详细信息（如单个井的详情）
- ❌ 纯文本描述
- ❌ 列表类信息（如井名列表）
- ❌ 数据量过大（>50行）

### 建议
1. **明确的提示标记**：使用统一的格式
2. **合理的图表类型**：根据数据特征智能判断
3. **清晰的System Prompt**：让LLM明确知道何时生成图表

## 🐛 已知问题和解决方案

### 问题1：LLM还是等用户说"画图"
**原因**：System Prompt不够明确  
**解决**：加强指令，使用"⚠️ **强制规则**"等强调词

### 问题2：对所有数据都生成图表
**原因**：触发条件过于宽松  
**解决**：在System Prompt中明确排除条件

### 问题3：图表类型错误
**原因**：LLM自行判断  
**解决**：强调"严格按照建议的图表类型生成"

## 📚 参考资料

- [LibreChat官方文档](https://docs.librechat.ai/)
- [Claude Artifacts文档](https://support.anthropic.com/en/articles/9487310-what-are-artifacts-and-how-do-i-use-them)
- [数据可视化最佳实践](https://www.data-to-viz.com/)

## 🎉 总结

通过在MCP Server返回数据中添加简单的"💡 可视化建议"标记，配合LibreChat的System Prompt配置，成功实现了：

✅ 自动判断数据类型  
✅ 自动选择图表类型  
✅ 自动生成可视化图表  
✅ 无需用户说"画图"  

**用户体验提升**：从2次对话减少到1次对话，操作更流畅！

---

**文档维护者**：GitHub Copilot  
**最后更新**：2026-02-25  
**版本**：v1.0
