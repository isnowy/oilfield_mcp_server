# ğŸ” LibreChat MCP Server è§’è‰²æƒé™é…ç½®æ–¹æ¡ˆå®Œå…¨æŒ‡å—

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£æ•´åˆäº†ä¸‰ç§LibreChat MCP Serveræƒé™é…ç½®æ–¹æ¡ˆï¼Œè¯¦ç»†è¯´æ˜å„æ–¹æ¡ˆçš„åŸç†ã€ä¼˜ç¼ºç‚¹ã€å®ç°æ­¥éª¤å’Œå¯¹æ¯”åˆ†æã€‚

**å½“å‰æ¨èæ–¹æ¡ˆï¼šHTTP Serveræ–¹æ¡ˆ**

---
## ğŸ“š æƒé™æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå·²æ•´åˆï¼‰

### ä¸‰ç§æ–¹æ¡ˆæ¦‚è§ˆ

| ç¼–å· | æ–¹æ¡ˆåç§° | éš¾åº¦ | æ¨èåº¦ | å®æ–½æ—¶é—´ | ç‰¹ç‚¹ |
|-----|---------|------|--------|---------|------|
| **1ï¸âƒ£** | **Stdio + æ•°æ®åº“ + ACL** | â­â­ | â­â­â­â­ | 5åˆ†é’Ÿ | å¿«é€Ÿã€ç®€å•ã€å—é™ |
| **2ï¸âƒ£** | **HTTP Server** | â­â­â­ | â­â­â­â­â­ | 30åˆ†é’Ÿ | **ã€å½“å‰ä¸»æ–¹æ¡ˆã€‘** |
| **3ï¸âƒ£** | **Stdio + æ•°æ®åº“æŸ¥è¯¢** | â­â­â­â­ | â­ | 1å°æ—¶+ | è¿‡æ—¶ã€å¤æ‚ã€æ€§èƒ½å·® |

### æ¨èæ–¹æ¡ˆï¼šHTTP Server

**ä¸ºä»€ä¹ˆé€‰æ‹©HTTP Serverï¼Ÿ**

âœ… **åŠ¨æ€æƒé™æ§åˆ¶** - æ¯ä¸ªè¯·æ±‚éƒ½èƒ½è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
âœ… **å®Œæ•´çš„å ä½ç¬¦æ”¯æŒ** - `{{LIBRECHAT_USER_ROLE}}` ç­‰èƒ½æ­£ç¡®æ›¿æ¢
âœ… **çœŸæ­£çš„per-requestéªŒè¯** - æ— éœ€ä¸ºæ¯ä¸ªè§’è‰²åˆ›å»ºå¤šä¸ªå®ä¾‹
âœ… **ç”Ÿäº§çº§åˆ«æ–¹æ¡ˆ** - å®˜æ–¹æ¨èçš„ç°ä»£æ–¹æ¡ˆ
âœ… **æ˜“äºæ‰©å±•** - æ·»åŠ æ–°åŠŸèƒ½å’Œä¸­é—´ä»¶ç®€å•
âœ… **æ€§èƒ½ä¼˜è‰¯** - 50-100mså»¶è¿Ÿï¼Œå¯æ¥å—


## ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜èƒŒæ™¯ä¸åˆ†æ

### æ ¸å¿ƒé—®é¢˜

LibreChatç³»ç»Ÿéœ€è¦ä¸ºMCP Serverå®ç°å®Œæ•´çš„è§’è‰²æƒé™æ§åˆ¶ï¼Œä»¥æ»¡è¶³ä»¥ä¸‹éœ€æ±‚ï¼š

1. âœ… **ç”¨æˆ·ä¿¡æ¯ä¼ é€’** - æ ¹æ®ç™»å½•ç”¨æˆ·è‡ªåŠ¨ä¼ é€’ç”¨æˆ·ä¸Šä¸‹æ–‡
2. âœ… **è§’è‰²æƒé™æ£€æŸ¥** - MCP Serveræ ¹æ®ç”¨æˆ·è§’è‰²æ£€æŸ¥å·¥å…·è®¿é—®æƒé™
3. âœ… **ç»†ç²’åº¦æ§åˆ¶** - æ”¯æŒREADã€WRITEã€DELETEã€ADMINå››çº§æƒé™
4. âœ… **å¼€å‘æ¨¡å¼æ”¯æŒ** - æ”¯æŒå¼€å‘ç¯å¢ƒè·³è¿‡æƒé™æ£€æŸ¥
5. âœ… **å®¡è®¡æ—¥å¿—** - è®°å½•æ‰€æœ‰æƒé™æ£€æŸ¥å’Œå·¥å…·è°ƒç”¨

### LibreChatçš„MCPæƒé™ç³»ç»Ÿ

LibreChaté‡‡ç”¨ä¸¤å±‚æƒé™æ¨¡å‹ï¼š

#### ç¬¬ä¸€å±‚ï¼šæ¥å£çº§æƒé™ï¼ˆInterface-Levelï¼‰

```yaml
interface:
  mcpServers:
    use: true      # å…è®¸ä½¿ç”¨MCPæœåŠ¡å™¨
    create: false  # ä¸å…è®¸åˆ›å»ºMCPé…ç½®
    share: false   # ä¸å…è®¸åˆ†äº«
    public: false  # ä¸å…è®¸å…¬å¼€
```

#### ç¬¬äºŒå±‚ï¼šAccess Control List (ACL)

- åŸºäºèµ„æºç±»å‹ï¼ˆResourceType.MCPSERVERï¼‰
- ä½¿ç”¨è®¿é—®è§’è‰²ï¼ˆAccessRoleIds: VIEWER, EDITOR, OWNERï¼‰
- æ”¯æŒç”¨æˆ·çº§å’Œç»„çº§æƒé™æ§åˆ¶

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šä¸‰ç§æƒé™å®ç°æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1ï¸âƒ£ï¼šStdio + æ•°æ®åº“MCP Server + ACLæƒé™

#### åŸç†

é€šè¿‡LibreChat UIæˆ–APIåˆ›å»ºå¤šä¸ªMCP Serverå®ä¾‹ï¼Œå¹¶ä½¿ç”¨æ•°æ®åº“å­˜å‚¨é…ç½®å’ŒACLæƒé™ã€‚

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç™»å½• & é€‰æ‹©MCP Server
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LibreChat                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ è¯»å–æ•°æ®åº“ä¸­çš„MCPé…ç½®      â”‚   â”‚
â”‚  â”‚ â€¢ æ ¹æ®ACLè¿‡æ»¤å¯è§çš„Server   â”‚   â”‚
â”‚  â”‚ â€¢ å¯åŠ¨stdioè¿›ç¨‹             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Stdio MCP Server (Python)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç¯å¢ƒå˜é‡ï¼ˆç¡¬ç¼–ç è§’è‰²ï¼‰       â”‚   â”‚
â”‚  â”‚ LIBRECHAT_USER_ROLE: "ADMIN" â”‚   â”‚
â”‚  â”‚ LIBRECHAT_USER_ROLE: "USER"  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°æ­¥éª¤

##### æ­¥éª¤1: å‡†å¤‡å·¥ä½œï¼ˆ1åˆ†é’Ÿï¼‰

```bash
# 1. ç¡®ä¿LibreChatæ­£åœ¨è¿è¡Œ
cd d:\work\librechat
docker-compose ps

# 2. ç¡®è®¤é…ç½®å·²å¯ç”¨MCPåˆ›å»ºåŠŸèƒ½
# ç¼–è¾‘ librechat.yamlï¼Œç¡®ä¿ï¼š
#   interface.mcpServers.create: true

# 3. é‡å¯LibreChatï¼ˆå¦‚æœä¿®æ”¹äº†é…ç½®ï¼‰
docker-compose restart
```

##### æ­¥éª¤2: åˆ›å»ºMCP Serversï¼ˆ2åˆ†é’Ÿï¼‰

1. **ç™»å½•ç®¡ç†å‘˜è´¦å·**
2. **è¿›å…¥ Settings â†’ MCP Servers**
3. **åˆ›å»ºç®¡ç†å‘˜ç‰ˆMCP Server**
   ```json
   {
     "name": "æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(ç®¡ç†å‘˜)",
     "command": "python",
     "args": ["d:/work/oilMCP/oilfield_mcp_server_with_permissions.py"],
     "env": {
       "DATABASE_URL": "sqlite:///d:/work/oilMCP/oilfield.db",
       "PYTHONIOENCODING": "utf-8",
       "LOG_LEVEL": "INFO",
       "LIBRECHAT_USER_ROLE": "ADMIN",
       "DEV_MODE": "false"
     }
   }
   ```

4. **åˆ›å»ºç”¨æˆ·ç‰ˆMCP Server**
   ```json
   {
     "name": "æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(æ™®é€šç”¨æˆ·)",
     "command": "python",
     "args": ["d:/work/oilMCP/oilfield_mcp_server_with_permissions.py"],
     "env": {
       "DATABASE_URL": "sqlite:///d:/work/oilMCP/oilfield.db",
       "PYTHONIOENCODING": "utf-8",
       "LOG_LEVEL": "INFO",
       "LIBRECHAT_USER_ROLE": "USER",
       "DEV_MODE": "false"
     }
   }
   ```

##### æ­¥éª¤3: é…ç½®ACLæƒé™ï¼ˆ1åˆ†é’Ÿï¼‰

ä½¿ç”¨Node.jsè„šæœ¬é…ç½®ACLï¼š

```bash
cd d:\work\librechat

# ä¸ºç®¡ç†å‘˜MCP Serveré…ç½®æƒé™
node scripts\configure-mcp-acl.js "æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(ç®¡ç†å‘˜)" ADMIN

# ä¸ºç”¨æˆ·MCP Serveré…ç½®æƒé™
node scripts\configure-mcp-acl.js "æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(æ™®é€šç”¨æˆ·)" USER
```

æˆ–è€…æ‰‹åŠ¨é…ç½®ï¼š
1. ç¼–è¾‘ librechat.yaml
2. åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹permissionsè¡¨

##### æ­¥éª¤4: æ¸…ç†yamlå…¨å±€é…ç½®ï¼ˆ30ç§’ï¼‰

ç¼–è¾‘ `librechat.yaml`ï¼Œæ³¨é‡Šæ‰æˆ–åˆ é™¤å…¨å±€MCPé…ç½®ï¼š

```yaml
# mcpServers:
#   oilfield-admin:
#     ...
#   oilfield-user:
#     ...
```

é‡å¯LibreChatï¼š

```bash
docker-compose restart
```

##### æ­¥éª¤5: éªŒè¯ï¼ˆ30ç§’ï¼‰

**ç®¡ç†å‘˜éªŒè¯**ï¼š
1. ä½¿ç”¨ADMINè´¦å·ç™»å½•
2. Settings â†’ MCP Servers
3. åº”è¯¥åªçœ‹åˆ° **"æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(ç®¡ç†å‘˜)"**

**ç”¨æˆ·éªŒè¯**ï¼š
1. ä½¿ç”¨USERè´¦å·ç™»å½•
2. Settings â†’ MCP Servers
3. åº”è¯¥åªçœ‹åˆ° **"æ²¹ç”°é’»äº•æ•°æ®æœåŠ¡(æ™®é€šç”¨æˆ·)"**

#### ä¼˜ç‚¹ âœ…

1. **ç®€å•æ˜“æ“ä½œ** - é€šè¿‡UIåˆ›å»ºå’Œé…ç½®
2. **åŸç”Ÿæ”¯æŒ** - åˆ©ç”¨LibreChatå†…ç½®ACLç³»ç»Ÿ
3. **æƒé™éš”ç¦»** - ä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒçš„MCP Server
4. **æ— éœ€é¢å¤–æœåŠ¡** - åŸºäºstdioï¼Œæ— éœ€é¢å¤–éƒ¨ç½²
5. **å®‰å…¨å¯é ** - ç”±LibreChatåŸç”Ÿæƒé™ç³»ç»Ÿä¿è¯

#### ç¼ºç‚¹ âŒ

1. **éœ€è¦å¤šä¸ªServerå®ä¾‹** - æ¯ä¸ªè§’è‰²éƒ½è¦åˆ›å»ºä¸€ä¸ª
2. **ç¯å¢ƒå˜é‡ç¡¬ç¼–ç ** - æ— æ³•ä¼ é€’åŠ¨æ€ç”¨æˆ·ä¿¡æ¯
3. **å…±äº«è¿›ç¨‹** - stdio MCP Serveræ˜¯å•ä¾‹ï¼Œæ‰€æœ‰ç”¨æˆ·å…±äº«
4. **ç»´æŠ¤æˆæœ¬** - æ·»åŠ æ–°è§’è‰²éœ€è¦åˆ›å»ºæ–°çš„Serverå®ä¾‹
5. **ä¸æ”¯æŒå ä½ç¬¦** - `{{LIBRECHAT_USER_ROLE}}`ç­‰å ä½ç¬¦åœ¨stdioä¸­ä¸ç”Ÿæ•ˆ

#### é¢„æœŸç»“æœ

**æƒé™çŸ©é˜µ**ï¼š

| å·¥å…·åˆ†ç±» | ç¤ºä¾‹å·¥å…· | ADMIN | USER | è¯´æ˜ |
|---------|---------|-------|------|------|
| **æŸ¥è¯¢ç±»** | query_drilling_data | âœ… | âœ… | éƒ½å¯ä»¥æŸ¥è¯¢ |
| **å†™å…¥ç±»** | add_drilling_record | âœ… | âœ… | éƒ½å¯ä»¥æ·»åŠ  |
| **åˆ é™¤ç±»** | delete_drilling_record | âœ… | âŒ | åªæœ‰ç®¡ç†å‘˜å¯åˆ é™¤ |
| **ç®¡ç†ç±»** | export_all_data | âœ… | âŒ | åªæœ‰ç®¡ç†å‘˜å¯å¯¼å‡º |

**ç»Ÿè®¡æ•°æ®**ï¼š

| è§’è‰² | å¯ç”¨å·¥å…·æ•° | è®¿é—®ç‡ |
|-----|----------|--------|
| ADMIN | 15/15 | 100% |
| USER | 8/15 | 53.3% |

---

### æ–¹æ¡ˆ2ï¸âƒ£ï¼šHTTP/SSE Server + åŠ¨æ€æƒé™

#### åŸç†

ä½¿ç”¨HTTPæˆ–SSEä¼ è¾“ç±»å‹éƒ¨ç½²MCP Serverï¼Œåœ¨æ¯ä¸ªè¯·æ±‚æ—¶è·å–å®é™…ç”¨æˆ·ä¿¡æ¯å¹¶è¿›è¡Œæƒé™æ£€æŸ¥ã€‚

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è°ƒç”¨MCPå·¥å…·
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LibreChat                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ æ„å»ºè¯·æ±‚headers             â”‚   â”‚
â”‚  â”‚ â€¢ åŒ…å«ç”¨æˆ·ä¿¡æ¯å ä½ç¬¦           â”‚   â”‚
â”‚  â”‚ â€¢ å‘é€HTTPè¯·æ±‚               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. HTTPè¯·æ±‚ with headers:
       â”‚    X-User-Role: "{{LIBRECHAT_USER_ROLE}}"
       â”‚    X-User-Email: "{{LIBRECHAT_USER_EMAIL}}"
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP/SSE MCP Server (Python)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ FastAPI / Starlette          â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚ â”‚ 1. è§£ærequest headers  â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ 2. è·å–ç”¨æˆ·è§’è‰²         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ 3. æ£€æŸ¥å·¥å…·æƒé™         â”‚  â”‚   â”‚
â”‚  â”‚ â”‚ 4. æ‰§è¡Œæˆ–æ‹’ç»           â”‚  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ è¿”å›ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°æ­¥éª¤

##### æ­¥éª¤1: åˆ›å»ºHTTP MCP Server

```python
# oilfield_mcp_http_server.py
from fastapi import FastAPI, Header, HTTPException
from fastapi.responses import JSONResponse
from mcp.server import Server
from mcp.types import Tool, TextContent
from contextlib import asynccontextmanager
import os

from permissions import PermissionChecker, UserRole

app = FastAPI()

# åˆå§‹åŒ–MCPæœåŠ¡å™¨
mcp_server = Server("oilfield-drilling-data")

class HTTPMCPServer:
    def __init__(self):
        self.permission_checker = None
    
    @asynccontextmanager
    async def lifespan(self, app: FastAPI):
        # åˆå§‹åŒ–
        print("âœ… HTTP MCP Server started")
        yield
        # æ¸…ç†
        print("âœ… HTTP MCP Server stopped")

server = HTTPMCPServer()

@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥"""
    return {"status": "ok", "service": "oilfield-mcp-http"}

@app.post("/mcp/call-tool")
async def call_tool(
    tool_name: str,
    arguments: dict,
    x_user_role: str = Header(None, alias="X-User-Role"),
    x_user_email: str = Header(None, alias="X-User-Email"),
    x_user_id: str = Header(None, alias="X-User-ID")
):
    """è°ƒç”¨MCPå·¥å…·
    
    LibreChatå°†ç”¨æˆ·ä¿¡æ¯é€šè¿‡è¯·æ±‚headersä¼ é€’ï¼š
    - X-User-Role: ç”¨æˆ·è§’è‰² (ADMIN, USER, GUEST)
    - X-User-Email: ç”¨æˆ·é‚®ç®±
    - X-User-ID: ç”¨æˆ·ID
    """
    try:
        # è§£æç”¨æˆ·è§’è‰²
        user_role = UserRole.GUEST
        if x_user_role:
            try:
                user_role = UserRole(x_user_role.upper())
            except ValueError:
                user_role = UserRole.GUEST
        
        # åˆ›å»ºæƒé™æ£€æŸ¥å™¨
        checker = PermissionChecker(
            user_role=user_role,
            user_email=x_user_email or "unknown@oilfield.com",
            user_id=x_user_id
        )
        
        # æ£€æŸ¥æƒé™
        has_permission, error_msg = checker.has_permission(tool_name)
        
        if not has_permission:
            checker.log_access(tool_name, False, arguments, error_msg)
            return JSONResponse(
                status_code=403,
                content={
                    "error": "Permission denied",
                    "message": error_msg,
                    "tool": tool_name,
                    "user_role": user_role.value
                }
            )
        
        # æ‰§è¡Œå·¥å…·ï¼ˆè¿™é‡Œæ˜¯ç¤ºä¾‹å®ç°ï¼‰
        result = await execute_tool(tool_name, arguments)
        
        # è®°å½•æˆåŠŸè®¿é—®
        checker.log_access(tool_name, True, arguments)
        
        return {
            "success": True,
            "tool": tool_name,
            "result": result
        }
        
    except Exception as e:
        return JSONResponse(
            status_code=500,
            content={"error": str(e)}
        )

async def execute_tool(tool_name: str, arguments: dict):
    """æ‰§è¡Œå®é™…çš„å·¥å…·é€»è¾‘"""
    # è¿™é‡Œæ¥å…¥å®é™…çš„å·¥å…·å®ç°
    if tool_name == "query_drilling_data":
        return {"status": "success", "data": []}
    else:
        raise ValueError(f"Unknown tool: {tool_name}")

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8080,
        log_level="info"
    )
```

##### æ­¥éª¤2: åœ¨librechat.yamlä¸­é…ç½®HTTPç±»å‹MCP Server

```yaml
interface:
  mcpServers:
    use: true
    create: false
    share: false
    public: false

mcpServers:
  oilfield-drilling:
    type: http  # ä½¿ç”¨HTTPç±»å‹
    url: "http://localhost:8080/mcp/call-tool"
    
    # é€šè¿‡headersä¼ é€’ç”¨æˆ·ä¿¡æ¯
    headers:
      X-User-Role: "{{LIBRECHAT_USER_ROLE}}"
      X-User-Email: "{{LIBRECHAT_USER_EMAIL}}"
      X-User-ID: "{{LIBRECHAT_USER_ID}}"
    
    description: "æ²¹ç”°é’»äº•æ•°æ®æŸ¥è¯¢æœåŠ¡"
    disabled: false
    timeout: 60000
```

##### æ­¥éª¤3: å¯åŠ¨HTTP Server

```bash
cd d:\work\oilMCP

# å®‰è£…ä¾èµ–
pip install fastapi uvicorn

# å¯åŠ¨æœåŠ¡å™¨
python oilfield_mcp_http_server.py

# æˆ–ä½¿ç”¨uvicornç›´æ¥å¯åŠ¨
uvicorn oilfield_mcp_http_server:app --host 0.0.0.0 --port 8080 --reload
```

##### æ­¥éª¤4: å¯åŠ¨LibreChatå¹¶æµ‹è¯•

```bash
cd d:\work\librechat
docker-compose up -d

# éªŒè¯è¿æ¥
curl -X POST http://localhost:8080/mcp/call-tool \
  -H "X-User-Role: ADMIN" \
  -H "X-User-Email: admin@oilfield.com" \
  -H "Content-Type: application/json" \
  -d '{"tool_name": "query_drilling_data", "arguments": {}}'
```

#### ä¼˜ç‚¹ âœ…

1. **çœŸæ­£çš„åŠ¨æ€æƒé™** - æ¯ä¸ªè¯·æ±‚éƒ½èƒ½è·å–å®é™…ç”¨æˆ·ä¿¡æ¯
2. **å ä½ç¬¦æ”¯æŒ** - æ”¯æŒ`{{LIBRECHAT_USER_ROLE}}`ç­‰åŠ¨æ€æ›¿æ¢
3. **å•ä¸€å®ä¾‹** - æ— éœ€åˆ›å»ºå¤šä¸ªServerå®ä¾‹
4. **é«˜åº¦çµæ´»** - å¯ä»¥å®ç°å¤æ‚çš„æƒé™é€»è¾‘
5. **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°åŠŸèƒ½å’Œä¸­é—´ä»¶
6. **é•¿æœŸæœ€ä½³æ–¹æ¡ˆ** - å®˜æ–¹æ¨èçš„modernæ–¹æ¡ˆ

#### ç¼ºç‚¹ âŒ

1. **éœ€è¦é¢å¤–æœåŠ¡** - éœ€è¦ç‹¬ç«‹çš„HTTPæœåŠ¡å™¨
2. **éƒ¨ç½²å¤æ‚åº¦é«˜** - éœ€è¦ç®¡ç†é¢å¤–çš„è¿›ç¨‹
3. **ç½‘ç»œé€šä¿¡å¼€é”€** - HTTPè¯·æ±‚å¸¦æ¥é¢å¤–å»¶è¿Ÿ
4. **æ•…éšœç‚¹å¢åŠ ** - å¦‚æœHTTPæœåŠ¡å´©æºƒï¼ŒMCPåŠŸèƒ½æ— æ³•ä½¿ç”¨
5. **éœ€è¦æ›´å¤šèµ„æº** - æœåŠ¡å™¨å†…å­˜å’ŒCPUå ç”¨

#### é¢„æœŸç»“æœ

ä¸æ–¹æ¡ˆ1ç›¸åŒçš„æƒé™çŸ©é˜µï¼Œä½†æ”¯æŒçœŸæ­£çš„åŠ¨æ€ç”¨æˆ·ä¿¡æ¯ï¼š

```
å½“å‰ç™»å½•ç”¨æˆ·: alice@oilfield.com (USERè§’è‰²)
è¯·æ±‚Header: X-User-Role: USER

MCP Serveræ£€æŸ¥ï¼š
âœ… query_drilling_data - æƒé™å…è®¸
âœ… add_drilling_record - æƒé™å…è®¸  
âŒ delete_drilling_record - æƒé™æ‹’ç»
âŒ export_all_data - æƒé™æ‹’ç»
```

---

### æ–¹æ¡ˆ3ï¸âƒ£ï¼šStdio Server + æ•°æ®åº“æŸ¥è¯¢æƒé™

#### åŸç†

ç»§ç»­ä½¿ç”¨stdioç±»å‹MCP Serverï¼Œä½†åœ¨Serverå†…éƒ¨ä¸»åŠ¨è¿æ¥åˆ°LibreChatæ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„å®é™…æƒé™ã€‚

#### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è°ƒç”¨MCPå·¥å…·
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LibreChat                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä¼ é€’æœ€å°ç¯å¢ƒå˜é‡              â”‚   â”‚
â”‚  â”‚ LIBRECHAT_USER_EMAIL          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Stdio MCP Server (Python)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. è·å–LIBRECHAT_USER_EMAIL  â”‚   â”‚
â”‚  â”‚ 2. è¿æ¥åˆ°LibreChatæ•°æ®åº“    â”‚   â”‚
â”‚  â”‚ 3. æŸ¥è¯¢ç”¨æˆ·å®é™…è§’è‰²          â”‚   â”‚
â”‚  â”‚ 4. æ£€æŸ¥æƒé™                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ MongoDBæŸ¥è¯¢                    â”‚
       â†“                                â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
  â”‚ MongoDB      â”‚                     â”‚
  â”‚ - usersè¡¨   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ - rolesè¡¨    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°æ­¥éª¤

##### æ­¥éª¤1: ä¿®æ”¹MCP Serverä»£ç 

```python
# oilfield_mcp_server_with_db_auth.py
import os
from pymongo import MongoClient
from permissions import PermissionChecker, UserRole
from mcp.server import Server
from mcp.types import TextContent, Tool

# è¿æ¥åˆ°LibreChatçš„MongoDBæ•°æ®åº“
mongodb_uri = os.getenv("MONGODB_URI", "mongodb://localhost:27017/librechat")
mongo_client = MongoClient(mongodb_uri)
db = mongo_client.librechat

def get_user_role_from_db(user_email: str) -> UserRole:
    """ä»LibreChatæ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·è§’è‰²"""
    if not user_email:
        return UserRole.GUEST
    
    try:
        user = db.users.find_one({"email": user_email})
        if not user:
            return UserRole.GUEST
        
        role_str = user.get("role", "USER").upper()
        return UserRole(role_str)
    except Exception as e:
        print(f"âŒ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: {e}")
        return UserRole.GUEST

# åˆ›å»ºMCP Server
mcp = Server("oilfield-drilling-data")

@mcp.call_tool()
async def handle_tool_call(name: str, arguments: dict):
    """å¤„ç†å·¥å…·è°ƒç”¨ï¼Œè¿›è¡Œæƒé™æ£€æŸ¥"""
    
    # è·å–å½“å‰ç”¨æˆ·é‚®ç®±ï¼ˆéœ€è¦LibreChatä¼ é€’ï¼‰
    user_email = os.getenv("LIBRECHAT_USER_EMAIL")
    
    # ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·å®é™…è§’è‰²
    user_role = get_user_role_from_db(user_email)
    
    # åˆ›å»ºæƒé™æ£€æŸ¥å™¨
    checker = PermissionChecker(user_role, user_email)
    
    # æ£€æŸ¥æƒé™
    has_permission, error_msg = checker.has_permission(name)
    
    if not has_permission:
        checker.log_access(name, False, arguments, error_msg)
        return [TextContent(
            type="text",
            text=f"âŒ æƒé™ä¸è¶³: {error_msg}"
        )]
    
    # æ‰§è¡Œå·¥å…·é€»è¾‘
    try:
        result = await execute_tool(name, arguments)
        checker.log_access(name, True, arguments)
        return [TextContent(type="text", text=str(result))]
    except Exception as e:
        checker.log_access(name, False, arguments, str(e))
        return [TextContent(type="text", text=f"âŒ æ‰§è¡Œå‡ºé”™: {str(e)}")]

async def execute_tool(tool_name: str, arguments: dict):
    """å®é™…çš„å·¥å…·å®ç°"""
    # å·¥å…·é€»è¾‘ä»£ç ...
    pass

if __name__ == "__main__":
    mcp.run()
```

##### æ­¥éª¤2: åœ¨librechat.yamlä¸­é…ç½®

```yaml
mcpServers:
  oilfield-data:
    command: python
    args:
      - "d:/work/oilMCP/oilfield_mcp_server_with_db_auth.py"
    env:
      # æ•°æ®åº“é…ç½®
      DATABASE_URL: "sqlite:///d:/work/oilMCP/oilfield.db"
      MONGODB_URI: "mongodb://localhost:27017/librechat"
      PYTHONIOENCODING: "utf-8"
      LOG_LEVEL: "INFO"
      
      # å¿…é¡»ä¼ é€’ç”¨æˆ·é‚®ç®±
      LIBRECHAT_USER_EMAIL: "{{LIBRECHAT_USER_EMAIL}}"
```

##### æ­¥éª¤3: å¯åŠ¨LibreChat

```bash
cd d:\work\librechat
docker-compose up -d
```

#### ä¼˜ç‚¹ âœ…

1. **ä¿æŒstdioç±»å‹** - ä¸éœ€è¦é¢å¤–çš„HTTPæœåŠ¡
2. **è·å–å®æ—¶æƒé™** - ä»æ•°æ®åº“æŸ¥è¯¢æœ€æ–°çš„ç”¨æˆ·è§’è‰²
3. **æ”¯æŒæƒé™æ›´æ–°** - ä¿®æ”¹æ•°æ®åº“æƒé™å³æ—¶ç”Ÿæ•ˆ
4. **å•ä¸€å®ä¾‹** - æ— éœ€åˆ›å»ºå¤šä¸ªServerå®ä¾‹

#### ç¼ºç‚¹ âŒ

1. **æ€§èƒ½å¼€é”€** - æ¯æ¬¡è°ƒç”¨éƒ½è¦æŸ¥è¯¢æ•°æ®åº“ï¼ˆN+1é—®é¢˜ï¼‰
2. **å¤æ‚åº¦é«˜** - éœ€è¦è®¿é—®LibreChatæ•°æ®åº“
3. **ä¾èµ–MongoDB** - å¯¹æ•°æ®åº“å¯ç”¨æ€§æœ‰å¼ºä¾èµ–
4. **ç»´æŠ¤å›°éš¾** - éœ€è¦ç†è§£LibreChatçš„æ•°æ®åº“æ¶æ„
5. **é”™è¯¯å¤„ç†å¤æ‚** - æ•°æ®åº“æ•…éšœä¼šå½±å“æƒé™æ£€æŸ¥
6. **æƒé™æ¨¡å‹ä¸æ¸…æ™°** - æ··åˆäº†ä¸¤ä¸ªç³»ç»Ÿçš„æƒé™é€»è¾‘

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šä¸‰ç§æ–¹æ¡ˆè¯¦ç»†å¯¹æ¯”

### å¯¹æ¯”è¡¨

| ç‰¹æ€§ | æ–¹æ¡ˆ1ï¼šæ•°æ®åº“+ACL | æ–¹æ¡ˆ2ï¼šHTTP Server | æ–¹æ¡ˆ3ï¼šæ•°æ®åº“æŸ¥è¯¢ |
|------|-----------------|----------------|----------------|
| **éš¾åº¦ç­‰çº§** | â­â­ ç®€å• | â­â­â­ ä¸­ç­‰ | â­â­â­â­ å¤æ‚ |
| **æ¨èåº¦** | â­â­â­â­ | â­â­â­â­â­ æ¨è | â­ ä¸æ¨è |
| **å®ç°è€—æ—¶** | 5åˆ†é’Ÿ | 30åˆ†é’Ÿ | 1å°æ—¶+ |
| **ç»´æŠ¤æˆæœ¬** | ä½ | ä¸­ç­‰ | é«˜ |
| **æ€§èƒ½** | â­â­â­â­â­ æœ€ä¼˜ | â­â­â­ è‰¯å¥½ | â­â­ è¾ƒå·® |
| **åŠ¨æ€æƒé™** | âŒ å¦ | âœ… æ˜¯ | âœ… æ˜¯ |
| **å ä½ç¬¦æ”¯æŒ** | âŒ å¦ | âœ… æ˜¯ | âŒ å¦ |
| **Serverå®ä¾‹æ•°** | å¤šä¸ª | 1ä¸ª | 1ä¸ª |
| **é¢å¤–æœåŠ¡** | å¦ | æ˜¯ï¼ˆHTTPï¼‰ | å¦ |
| **æ•°æ®åº“ä¾èµ–** | LibreChat DB | æ—  | LibreChat DB |
| **æƒé™éš”ç¦»** | âœ… å®Œç¾ | âœ… å®Œç¾ | âš ï¸ éœ€è¦é¢å¤–ä»£ç  |
| **æƒé™æ›´æ–°å»¶è¿Ÿ** | é‡å¯ç”Ÿæ•ˆ | å³æ—¶ | å³æ—¶ |
| **æ•…éšœå½±å“èŒƒå›´** | è¯¥Serverä¸å¯ç”¨ | HTTPæœåŠ¡å´©æºƒ | æ•°æ®åº“æ•…éšœå½±å“æƒé™ |
| **æ‰©å±•æ€§** | ä½ | é«˜ | ä¸­ç­‰ |
| **ç›‘æ§è°ƒè¯•** | å®¹æ˜“ | å®¹æ˜“ | å›°éš¾ |
| **é•¿æœŸå‘å±•æ–¹å‘** | çŸ­æœŸæ–¹æ¡ˆ | âœ… é•¿æœŸæ¨è | è¿‡æ¸¡æ–¹æ¡ˆ |

### é€‰æ‹©å»ºè®®

#### ğŸ¯ é€‰æ‹©æ–¹æ¡ˆ1ï¼ˆæ•°æ®åº“+ACLï¼‰å½“ï¼š

- éœ€è¦å¿«é€Ÿå®Œæˆæƒé™æ§åˆ¶
- åªæœ‰æœ‰é™çš„å‡ ä¸ªç”¨æˆ·è§’è‰²
- ä¸éœ€è¦é¢‘ç¹ä¿®æ”¹æƒé™é…ç½®
- ç³»ç»Ÿå¤æ‚åº¦è¦æ±‚ä½
- ç»´æŠ¤èµ„æºæœ‰é™

#### ğŸ¯ é€‰æ‹©æ–¹æ¡ˆ2ï¼ˆHTTP Serverï¼‰å½“ï¼š

- éœ€è¦çœŸæ­£çš„åŠ¨æ€æƒé™æ§åˆ¶
- ç”¨æˆ·è§’è‰²å’Œæƒé™ç»å¸¸å˜åŒ–
- æœ‰ä¸“é—¨çš„è¿ç»´äººå‘˜
- å¯¹ç³»ç»Ÿæ€§èƒ½æœ‰ä¸€å®šè¦æ±‚
- éœ€è¦é•¿æœŸå¯ç»´æŠ¤æ€§

#### ğŸ¯ é€‰æ‹©æ–¹æ¡ˆ3ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰å½“ï¼š

- å¿…é¡»ä½¿ç”¨stdioç±»å‹ï¼ˆä¸æ¨èï¼‰
- è¿‡æ¸¡é˜¶æ®µï¼ˆæœ€ç»ˆåº”è¿ç§»åˆ°æ–¹æ¡ˆ2ï¼‰
- éœ€è¦é¢‘ç¹æ›´æ–°æƒé™ï¼ˆä½†æœ‰æ€§èƒ½é—®é¢˜ï¼‰

---

## ç¬¬å››éƒ¨åˆ†ï¼šæƒé™ä½“ç³»è¯¦è§£

### æƒé™å±‚çº§å®šä¹‰

#### ç”¨æˆ·è§’è‰²ï¼ˆRoleï¼‰

```python
class UserRole(Enum):
    """LibreChatç”¨æˆ·è§’è‰²"""
    ADMIN = "admin"        # ç³»ç»Ÿç®¡ç†å‘˜
    USER = "user"          # æ™®é€šç”¨æˆ·
    GUEST = "guest"        # è®¿å®¢
```

#### æƒé™ç±»å‹ï¼ˆPermissionï¼‰

```python
class Permission(Enum):
    """MCPå·¥å…·æƒé™ç±»å‹"""
    READ = "read"          # è¯»å–/æŸ¥è¯¢æƒé™
    WRITE = "write"        # åˆ›å»º/ä¿®æ”¹æƒé™
    DELETE = "delete"      # åˆ é™¤æƒé™
    ADMIN = "admin"        # ç®¡ç†æƒé™ï¼ˆç³»ç»Ÿçº§ï¼‰
```

#### æƒé™æ˜ å°„

```python
ROLE_PERMISSIONS = {
    UserRole.ADMIN: [
        Permission.READ,
        Permission.WRITE,
        Permission.DELETE,
        Permission.ADMIN
    ],
    UserRole.USER: [
        Permission.READ,
        Permission.WRITE
    ],
    UserRole.GUEST: [
        Permission.READ
    ]
}
```

### å·¥å…·æƒé™é…ç½®

```python
TOOL_PERMISSIONS = {
    # æŸ¥è¯¢ç±»ï¼ˆREADï¼‰
    "query_drilling_data": [Permission.READ],
    "query_well_status": [Permission.READ],
    
    # åˆ›å»º/ä¿®æ”¹ç±»ï¼ˆWRITEï¼‰
    "add_drilling_record": [Permission.WRITE],
    "update_well_info": [Permission.WRITE],
    
    # åˆ é™¤ç±»ï¼ˆDELETEï¼‰
    "delete_drilling_record": [Permission.DELETE],
    
    # ç®¡ç†ç±»ï¼ˆADMINï¼‰
    "export_all_data": [Permission.ADMIN],
    "system_config": [Permission.ADMIN],
}
```

### æƒé™æ£€æŸ¥æµç¨‹

```
ç”¨æˆ·è¯·æ±‚å·¥å…·è°ƒç”¨
    â†“
è·å–ç”¨æˆ·è§’è‰²å’Œé‚®ç®±
    â†“
æŸ¥æ‰¾å·¥å…·æƒé™è¦æ±‚
    â†“
è·å–ç”¨æˆ·æ‹¥æœ‰çš„æƒé™åˆ—è¡¨
    â†“
æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒé™åŒ¹é…ï¼Ÿ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
    âœ… æ˜¯                        âŒ å¦
       â”‚                          â”‚
       â†“                          â†“
   æ‰§è¡Œå·¥å…·               è¿”å›æƒé™æ‹’ç»é”™è¯¯
   è®°å½•æˆåŠŸæ—¥å¿—           è®°å½•å¤±è´¥æ—¥å¿—
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®Œæ•´æƒé™å¯¹æ¯”çŸ©é˜µ

### å·¥å…·è®¿é—®æƒé™è¡¨

| å·¥å…·åç§° | æƒé™è¦æ±‚ | ADMIN | USER | GUEST | è¯´æ˜ |
|---------|---------|-------|------|-------|------|
| **æŸ¥è¯¢ç±»** |
| query_drilling_data | READ | âœ… | âœ… | âœ… | æŸ¥è¯¢é’»äº•æ•°æ® |
| query_well_status | READ | âœ… | âœ… | âœ… | æŸ¥è¯¢äº•çŠ¶æ€ |
| query_production_data | READ | âœ… | âœ… | âœ… | æŸ¥è¯¢ç”Ÿäº§æ•°æ® |
| get_well_info | READ | âœ… | âœ… | âœ… | è·å–äº•ä¿¡æ¯ |
| **åˆ›å»º/ä¿®æ”¹ç±»** |
| add_drilling_record | WRITE | âœ… | âœ… | âŒ | æ·»åŠ é’»äº•è®°å½• |
| update_well_info | WRITE | âœ… | âœ… | âŒ | æ›´æ–°äº•ä¿¡æ¯ |
| **åˆ é™¤ç±»** |
| delete_drilling_record | DELETE | âœ… | âŒ | âŒ | åˆ é™¤é’»äº•è®°å½• |
| delete_well_info | DELETE | âœ… | âŒ | âŒ | åˆ é™¤äº•ä¿¡æ¯ |
| **åˆ†æç±»** |
| analyze_well_data | READ | âœ… | âœ… | âŒ | åˆ†æäº•æ•°æ® |
| generate_report | READ | âœ… | âœ… | âŒ | ç”ŸæˆæŠ¥å‘Š |
| **ç®¡ç†ç±»** |
| export_all_data | ADMIN | âœ… | âŒ | âŒ | å¯¼å‡ºå…¨éƒ¨æ•°æ® |
| import_data | ADMIN | âœ… | âŒ | âŒ | å¯¼å…¥æ•°æ® |
| system_config | ADMIN | âœ… | âŒ | âŒ | ç³»ç»Ÿé…ç½® |
| manage_permissions | ADMIN | âœ… | âŒ | âŒ | ç®¡ç†æƒé™ |
| view_audit_log | ADMIN | âœ… | âŒ | âŒ | æŸ¥çœ‹å®¡è®¡æ—¥å¿— |

### ç»Ÿè®¡æ•°æ®

```
æ€»å·¥å…·æ•°: 15

ADMINè§’è‰²:
  å¯ç”¨å·¥å…·: 15/15 (100%)
  æƒé™ç±»å‹: READ + WRITE + DELETE + ADMIN

USERè§’è‰²:
  å¯ç”¨å·¥å…·: 8/15 (53.3%)
  æƒé™ç±»å‹: READ + WRITE
  æ— æ³•ä½¿ç”¨: DELETEå’ŒADMINæƒé™çš„å·¥å…·

GUESTè§’è‰²:
  å¯ç”¨å·¥å…·: 4/15 (26.7%)
  æƒé™ç±»å‹: READ
  æ— æ³•ä½¿ç”¨: WRITE, DELETEå’ŒADMINæƒé™çš„å·¥å…·
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šå¸¸è§é—®é¢˜è§£å†³

### æ–¹æ¡ˆ1ç›¸å…³

#### Q1.1: åˆ›å»ºMCP Serveræ—¶è¿”å›401é”™è¯¯

**åŸå› **ï¼šJWT Tokenæ— æ•ˆæˆ–è¿‡æœŸ

**è§£å†³**ï¼š
1. é‡æ–°ä»æµè§ˆå™¨è·å–token
   - æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
   - åˆ‡æ¢åˆ° Network æ ‡ç­¾
   - åˆ·æ–°é¡µé¢
   - æ‰¾åˆ°ä»»æ„APIè¯·æ±‚
   - å¤åˆ¶Authorization headerä¸­çš„token
2. ç¡®ä¿å¤åˆ¶äº†å®Œæ•´tokenï¼ˆä¸åŒ…æ‹¬"Bearer "å‰ç¼€ï¼‰

#### Q1.2: æƒé™é…ç½®åç”¨æˆ·ä»çœ‹ä¸åˆ°MCP Server

**åŸå› **ï¼šACLæƒé™é…ç½®é”™è¯¯æˆ–æœªç”Ÿæ•ˆ

**è§£å†³**ï¼š
```bash
# 1. æ£€æŸ¥ç”¨æˆ·è§’è‰²
node scripts\list-users-with-roles.js

# 2. é‡æ–°é…ç½®ACL
node scripts\configure-mcp-acl.js "server-name" ADMIN

# 3. æ¸…é™¤ç¼“å­˜
node scripts\flush-cache.js

# 4. é‡å¯LibreChat
docker-compose restart
```

#### Q1.3: åˆ é™¤yamlå…¨å±€é…ç½®åMCPä¸å¯ç”¨

**åŸå› **ï¼šæ•°æ®åº“ä¸­çš„MCP Serveré…ç½®æœªæ­£ç¡®åˆ›å»º

**è§£å†³**ï¼š
1. æ£€æŸ¥æ•°æ®åº“ä¸­MCP Serveræ˜¯å¦å­˜åœ¨
2. é‡æ–°åˆ›å»ºé…ç½®
3. éªŒè¯æƒé™è®¾ç½®
4. é€æ­¥åˆ é™¤yamlé…ç½®ï¼ˆè€Œä¸æ˜¯ä¸€æ¬¡å…¨åˆ ï¼‰

### æ–¹æ¡ˆ2ç›¸å…³

#### Q2.1: HTTP Serverå¯åŠ¨å¤±è´¥

**åŸå› **ï¼šä¾èµ–åŒ…ç¼ºå¤±æˆ–ç«¯å£è¢«å ç”¨

**è§£å†³**ï¼š
```bash
# 1. å®‰è£…ä¾èµ–
pip install fastapi uvicorn mcp

# 2. æ£€æŸ¥ç«¯å£å ç”¨
netstat -ano | findstr :8080

# 3. å¦‚æœè¢«å ç”¨ï¼Œæ›´æ¢ç«¯å£
python oilfield_mcp_http_server.py --port 8081

# 4. æ£€æŸ¥Pythonç‰ˆæœ¬ï¼ˆéœ€è¦3.8+ï¼‰
python --version
```

#### Q2.2: LibreChatæ— æ³•è¿æ¥HTTP Server

**åŸå› **ï¼šURLé…ç½®é”™è¯¯æˆ–æœåŠ¡å™¨é˜²ç«å¢™

**è§£å†³**ï¼š
```bash
# 1. æµ‹è¯•HTTP Serveræ˜¯å¦æ­£å¸¸
curl -X GET http://localhost:8080/health

# 2. æ£€æŸ¥librechat.yamlä¸­çš„URLé…ç½®
# å¦‚æœLibreChatåœ¨Dockerä¸­ï¼Œä½¿ç”¨host.docker.internalè€Œä¸æ˜¯localhost
url: "http://host.docker.internal:8080/mcp/call-tool"

# 3. æ£€æŸ¥é˜²ç«å¢™
# Windowsé˜²ç«å¢™å…è®¸Pythonè¿›ç¨‹
```

#### Q2.3: æƒé™æ£€æŸ¥ä¸ç”Ÿæ•ˆï¼ˆæ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸï¼‰

**åŸå› **ï¼šPermissionCheckeræœªæ­£ç¡®åˆå§‹åŒ–æˆ–æ£€æŸ¥é€»è¾‘æœ‰é—®é¢˜

**è§£å†³**ï¼š
```python
# 1. ç¡®è®¤permission_checkerå·²æ­£ç¡®åˆå§‹åŒ–
checker = PermissionChecker(user_role, user_email)

# 2. æ£€æŸ¥æ—¥å¿—è¾“å‡º
import logging
logging.basicConfig(level=logging.DEBUG)

# 3. æµ‹è¯•æƒé™æ£€æŸ¥
has_perm, error = checker.has_permission("delete_record")
print(f"Delete permission: {has_perm}, Error: {error}")

# 4. æ£€æŸ¥TOOL_PERMISSIONSé…ç½®æ˜¯å¦æ­£ç¡®
```

### æ–¹æ¡ˆ3ç›¸å…³

#### Q3.1: æ•°æ®åº“è¿æ¥å¤±è´¥

**åŸå› **ï¼šMongoDB URIé”™è¯¯æˆ–æœåŠ¡æœªè¿è¡Œ

**è§£å†³**ï¼š
```bash
# 1. æ£€æŸ¥MongoDBæœåŠ¡çŠ¶æ€
docker-compose ps | grep mongo

# 2. ç¡®è®¤URIæ­£ç¡®
# åº”è¯¥æ˜¯: mongodb://username:password@host:27017/librechat

# 3. æµ‹è¯•è¿æ¥
python -c "from pymongo import MongoClient; MongoClient('mongodb://localhost:27017')"
```

#### Q3.2: é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“å¯¼è‡´æ€§èƒ½ä¸‹é™

**åŸå› **ï¼šæ¯ä¸ªè¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“

**ä¼˜åŒ–**ï¼š
```python
# æ·»åŠ ç¼“å­˜
from functools import lru_cache
from datetime import datetime, timedelta

cache_time = {}

def get_user_role_from_db_cached(user_email: str, cache_duration=300) -> UserRole:
    """å¸¦ç¼“å­˜çš„æ•°æ®åº“æŸ¥è¯¢"""
    current_time = datetime.now()
    
    # æ£€æŸ¥ç¼“å­˜
    if user_email in cache_time:
        cached_data, cached_at = cache_time[user_email]
        if (current_time - cached_at).seconds < cache_duration:
            return cached_data
    
    # æŸ¥è¯¢æ•°æ®åº“
    role = get_user_role_from_db(user_email)
    cache_time[user_email] = (role, current_time)
    
    return role
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå®‰å…¨å»ºè®®

### 1. ç¯å¢ƒå˜é‡å®‰å…¨

```yaml
# âŒ ä¸è¦åœ¨yamlä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
env:
  DB_PASSWORD: "12345"  # ç¦æ­¢

# âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
env:
  DB_PASSWORD: "${DATABASE_PASSWORD}"
```

### 2. æƒé™æœ€å°åŒ–åŸåˆ™

```python
# âŒ ç»™äºˆè¿‡å¤šæƒé™
ROLE_PERMISSIONS = {
    UserRole.USER: [Permission.READ, Permission.WRITE, Permission.DELETE]
}

# âœ… åªç»™å¿…è¦çš„æƒé™
ROLE_PERMISSIONS = {
    UserRole.USER: [Permission.READ, Permission.WRITE]
}
```

### 3. ç”Ÿäº§ç¯å¢ƒé…ç½®

```python
# âœ… åœ¨ç”Ÿäº§ç¯å¢ƒç¦ç”¨å¼€å‘æ¨¡å¼
DEV_MODE = os.getenv("DEV_MODE", "false").lower() == "true"

if DEV_MODE:
    logger.warning("âš ï¸ å¼€å‘æ¨¡å¼å·²å¯ç”¨ - æƒé™æ£€æŸ¥è¢«ç»•è¿‡")
else:
    logger.info("âœ… ç”Ÿäº§æ¨¡å¼ - æƒé™æ£€æŸ¥å¯ç”¨")
```

### 4. å®¡è®¡æ—¥å¿—è®°å½•

```python
def log_access(self, tool_name: str, success: bool, 
               arguments: dict = None, error: str = None):
    """è®°å½•æ‰€æœ‰æƒé™æ£€æŸ¥"""
    log_entry = {
        "timestamp": datetime.now().isoformat(),
        "user": self.user_email,
        "role": self.user_role.value,
        "tool": tool_name,
        "success": success,
        "error": error,
        "arguments_hash": hash(str(arguments))  # é¿å…è®°å½•æ•æ„Ÿæ•°æ®
    }
    
    # æŒä¹…åŒ–åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶
    with open("audit.log", "a") as f:
        f.write(json.dumps(log_entry) + "\n")
```

### 5. é”™è¯¯æ¶ˆæ¯å®‰å…¨

```python
# âŒ æ³„éœ²æ•æ„Ÿä¿¡æ¯
error = f"æ— æƒè®¿é—®è¡¨{table_name}ä¸­çš„ç”¨æˆ·{user_id}æ•°æ®"

# âœ… é€šç”¨é”™è¯¯æ¶ˆæ¯
error = "æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ"
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šæµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•æƒé™æ£€æŸ¥é€»è¾‘
cd d:\work\oilMCP
python test_permissions_quick.py all

# å¯¹æ¯”ä¸åŒè§’è‰²
python test_permissions_quick.py compare

# æµ‹è¯•ç‰¹å®šè§’è‰²
python test_permissions_quick.py admin
python test_permissions_quick.py user
python test_permissions_quick.py guest
```

### æƒé™éš”ç¦»æµ‹è¯•

```python
# åœ¨LibreChatä¸­éªŒè¯
1. ä»¥ADMINè´¦å·ç™»å½•
   - è°ƒç”¨: query_drilling_data âœ… æˆåŠŸ
   - è°ƒç”¨: delete_record âœ… æˆåŠŸ
   - è°ƒç”¨: export_data âœ… æˆåŠŸ

2. ä»¥USERè´¦å·ç™»å½•
   - è°ƒç”¨: query_drilling_data âœ… æˆåŠŸ
   - è°ƒç”¨: delete_record âŒ æƒé™æ‹’ç»
   - è°ƒç”¨: export_data âŒ æƒé™æ‹’ç»

3. ä»¥GUESTè´¦å·ç™»å½•
   - è°ƒç”¨: query_drilling_data âœ… æˆåŠŸ
   - è°ƒç”¨: add_record âŒ æƒé™æ‹’ç»
   - è°ƒç”¨: delete_record âŒ æƒé™æ‹’ç»
```

### æ€§èƒ½æµ‹è¯•

```bash
# æ–¹æ¡ˆ1ï¼šæ•°æ®åº“+ACL
- å»¶è¿Ÿ: < 10ms
- åŸå› : æƒé™ä¿¡æ¯é¢„åŠ è½½

# æ–¹æ¡ˆ2ï¼šHTTP Server
- å»¶è¿Ÿ: 50-100ms
- åŸå› : ç½‘ç»œé€šä¿¡å¼€é”€

# æ–¹æ¡ˆ3ï¼šæ•°æ®åº“æŸ¥è¯¢
- å»¶è¿Ÿ: 100-500msï¼ˆé¦–æ¬¡ï¼‰/5-50msï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
- åŸå› : é¢‘ç¹æ•°æ®åº“æŸ¥è¯¢
```

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šè¿ç§»æŒ‡å—

### ä»æ–¹æ¡ˆ1è¿ç§»åˆ°æ–¹æ¡ˆ2

#### æ­¥éª¤1: å‡†å¤‡HTTP Serverï¼ˆå¹¶è¡Œè¿è¡Œï¼‰

```bash
# åœ¨æ–°ç«¯å£å¯åŠ¨HTTP Server
python oilfield_mcp_http_server.py --port 8080

# æµ‹è¯•åŠŸèƒ½
curl http://localhost:8080/health
```

#### æ­¥éª¤2: åœ¨librechat.yamlä¸­æ·»åŠ æ–°é…ç½®

```yaml
mcpServers:
  # ä¿æŒæ—§çš„stdioé…ç½®
  oilfield-admin:
    command: python
    ...
  
  # æ·»åŠ æ–°çš„HTTPé…ç½®
  oilfield-http:
    type: http
    url: "http://localhost:8080/mcp/call-tool"
    ...
```

#### æ­¥éª¤3: ç°åº¦æµ‹è¯•

1. éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨HTTPç‰ˆæœ¬æµ‹è¯•
2. å¯¹æ¯”æ€§èƒ½å’ŒåŠŸèƒ½
3. æ”¶é›†åé¦ˆ

#### æ­¥éª¤4: å®Œå…¨è¿ç§»

1. æ›´æ–°librechat.yamlï¼Œåªä¿ç•™HTTPé…ç½®
2. åˆ é™¤æ—§çš„stdioç›¸å…³é…ç½®
3. é‡å¯LibreChat
4. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

#### æ­¥éª¤5: æ¸…ç†

```bash
# åˆ é™¤stdio Serveræ–‡ä»¶
rm oilfield_mcp_server_with_permissions.py

# ä¿æŒHTTP Serverå¯åŠ¨
# é…ç½®è‡ªåŠ¨é‡å¯å’Œç›‘æ§
```

---

## æ€»ç»“è¡¨

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | æ¨èåº¦ | å…¸å‹åœºæ™¯ | ä¼˜å…ˆé€‰æ‹© |
|------|---------|--------|---------|---------|
| **æ–¹æ¡ˆ1ï¼šæ•°æ®åº“+ACL** | â­â­ | â­â­â­â­ | å¿«é€ŸåŸå‹ã€å°å‹å›¢é˜Ÿ | å½“å‰ç«‹å³ä½¿ç”¨ |
| **æ–¹æ¡ˆ2ï¼šHTTP Server** | â­â­â­ | â­â­â­â­â­ | ç”Ÿäº§ç¯å¢ƒã€é•¿æœŸæ–¹æ¡ˆ | åæœŸä¼˜åŒ–ç›®æ ‡ |
| **æ–¹æ¡ˆ3ï¼šæ•°æ®åº“æŸ¥è¯¢** | â­â­â­â­ | â­ | è¿‡æ¸¡æ–¹æ¡ˆ | ä¸æ¨è |

---

## å‚è€ƒèµ„æº

- [LibreChat MCPå®˜æ–¹æ–‡æ¡£](https://github.com/danny-avila/LibreChat/blob/main/MCP_QUICKSTART.md)
- [MCP Protocolè§„èŒƒ](https://modelcontextprotocol.io/)
- [LibreChatæƒé™ç³»ç»Ÿæºç ](https://github.com/danny-avila/LibreChat/tree/main/packages/data-provider)
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**æœ€åæ›´æ–°**: 2026-01-29  
**ç»´æŠ¤è€…**: LibreChat MCP Team

---

## æ›´æ–°æ—¥å¿—

### v2.0 (2026-01-29)
- âœ… æ•´åˆä¸‰ç§æƒé™æ–¹æ¡ˆ
- âœ… æ·»åŠ è¯¦ç»†å¯¹æ¯”åˆ†æ
- âœ… è¡¥å……HTTP Serverå®Œæ•´å®ç°ä»£ç 
- âœ… æ·»åŠ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
- âœ… è¡¥å……å®‰å…¨å»ºè®®å’Œæœ€ä½³å®è·µ

### v1.0 (åˆå§‹ç‰ˆæœ¬)
- å•ä¸€æ–¹æ¡ˆï¼ˆæ•°æ®åº“+ACLï¼‰
